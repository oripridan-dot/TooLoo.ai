<!DOCTYPE html>
<!-- @version 2.1.11 -->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TooLoo ‚Ä¢ Command Center</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg-dark: #0a0e27;
      --bg-darker: #050812;
      --bg-light: #1e293b;
      --accent: #60a5fa;
      --accent-dark: #3b82f6;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --text-primary: #e2e8f0;
      --text-secondary: #94a3b8;
      --border: rgba(148,163,184,.1);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-darker);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
    }

    .command-center {
      display: grid;
      grid-template-columns: 280px 1fr 320px;
      grid-template-rows: 56px 1fr 60px;
      height: 100vh;
      gap: 0;
    }

    /* ===== TOP BAR ===== */
    .top-bar {
      grid-column: 1 / -1;
      background: linear-gradient(90deg, rgba(15,23,42,.95), rgba(20,30,48,.95));
      border-bottom: 1px solid var(--border);
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 100;
    }

    .logo { font-size: 16px; font-weight: 700; color: var(--accent); display: flex; align-items: center; gap: 8px; }
    .mode-indicator { display: flex; gap: 12px; font-size: 12px; }
    .mode-badge { padding: 4px 8px; background: rgba(96,165,250,.15); border-radius: 3px; color: var(--accent); }
    .top-actions { display: flex; gap: 10px; }
    .btn-small { padding: 6px 12px; background: rgba(59,130,246,.15); border: 1px solid rgba(59,130,246,.3); color: var(--accent); border-radius: 5px; cursor: pointer; font-size: 11px; font-weight: 600; transition: all 0.2s; }
    .btn-small:hover { background: rgba(59,130,246,.25); }

    /* ===== LEFT PANEL (MODES & QUICK ACCESS) ===== */
    .left-panel {
      grid-column: 1;
      grid-row: 2;
      background: rgba(15,23,42,.6);
      border-right: 1px solid var(--border);
      overflow-y: auto;
      padding: 16px;
      flex-direction: column;
    }

    .section {
      margin-bottom: 24px;
    }

    .section-title {
      font-size: 10px;
      text-transform: uppercase;
      color: var(--accent);
      font-weight: 700;
      margin-bottom: 12px;
      letter-spacing: 0.5px;
    }

    .mode-btn {
      width: 100%;
      padding: 12px;
      background: rgba(59,130,246,.1);
      border: 1px solid rgba(59,130,246,.2);
      color: var(--accent);
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .mode-btn:hover {
      background: rgba(59,130,250,.2);
      border-color: rgba(59,130,250,.4);
    }

    .mode-btn.active {
      background: rgba(59,130,250,.3);
      border-color: var(--accent);
      box-shadow: 0 0 12px rgba(96,165,250,.2);
    }

    .quick-item {
      padding: 8px 12px;
      background: rgba(100,116,139,.1);
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .quick-item:hover {
      background: rgba(100,116,139,.2);
      color: var(--text-primary);
    }

    /* ===== CENTER (CANVAS) ===== */
    .center-canvas {
      grid-column: 2;
      grid-row: 2;
      background: linear-gradient(135deg, rgba(10,14,39,.8), rgba(15,23,42,.6));
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .canvas-tabs {
      display: flex;
      gap: 0;
      border-bottom: 1px solid var(--border);
      padding: 0 16px;
      background: rgba(15,23,42,.4);
    }

    .canvas-tab {
      padding: 12px 16px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }

    .canvas-tab:hover { color: var(--text-primary); }
    .canvas-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

    .canvas-content {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: none;
    }

    .canvas-content.active { display: block; }

    /* Roadmap visualization */
    .roadmap-container { display: flex; flex-direction: column; gap: 16px; }
    .roadmap-phase {
      background: rgba(30,41,59,.8);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      transition: all 0.3s;
    }

    .roadmap-phase:hover {
      background: rgba(30,41,59,.95);
      border-color: rgba(96,165,250,.3);
      box-shadow: 0 8px 20px rgba(96,165,250,.1);
    }

    .phase-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .phase-title { font-weight: 600; color: var(--accent); }
    .phase-timeline { font-size: 11px; color: var(--text-secondary); }
    .phase-tasks { display: flex; flex-direction: column; gap: 8px; }
    .task-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      background: rgba(16,185,129,.05);
      border-left: 2px solid var(--success);
      border-radius: 3px;
      font-size: 12px;
    }

    /* Task board */
    .board-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
    }

    .board-column {
      background: rgba(30,41,59,.6);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      min-height: 400px;
    }

    .column-header {
      font-size: 12px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }

    .task-card {
      background: rgba(51,65,85,.8);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 8px;
      cursor: move;
      transition: all 0.2s;
      font-size: 12px;
    }

    .task-card:hover {
      background: rgba(51,65,85,.95);
      box-shadow: 0 4px 12px rgba(96,165,250,.1);
    }

    .task-title { font-weight: 600; color: var(--text-primary); margin-bottom: 6px; }
    .task-meta { font-size: 11px; color: var(--text-secondary); display: flex; gap: 8px; }
    .task-priority { padding: 2px 6px; background: rgba(245,158,11,.2); border-radius: 2px; color: var(--warning); }

    /* Ideation board */
    .idea-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
    }

    .idea-card {
      background: rgba(30,41,59,.8);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.3s;
      min-height: 150px;
      display: flex;
      flex-direction: column;
    }

    .idea-card:hover {
      border-color: var(--accent);
      background: rgba(30,41,59,.95);
      box-shadow: 0 8px 20px rgba(96,165,250,.15);
      transform: translateY(-4px);
    }

    .idea-icon { font-size: 24px; margin-bottom: 8px; }
    .idea-title { font-weight: 600; font-size: 13px; margin-bottom: 8px; }
    .idea-desc { font-size: 12px; color: var(--text-secondary); line-height: 1.4; flex: 1; }
    .idea-tags { display: flex; gap: 4px; margin-top: 8px; flex-wrap: wrap; }
    .tag { padding: 2px 6px; background: rgba(96,165,250,.2); border-radius: 2px; font-size: 10px; color: var(--accent); }

    /* ===== RIGHT PANEL (AI RESPONSES) ===== */
    .right-panel {
      grid-column: 3;
      grid-row: 2;
      background: rgba(15,23,42,.6);
      border-left: 1px solid var(--border);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .response-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      font-size: 12px;
      font-weight: 700;
      color: var(--accent);
    }

    .response-box {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .ai-response {
      background: rgba(51,65,85,.4);
      border-left: 3px solid var(--accent);
      border-radius: 4px;
      padding: 12px;
      font-size: 12px;
      line-height: 1.5;
      color: var(--text-primary);
    }

    .response-section {
      background: rgba(30,41,59,.6);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 12px;
      margin-bottom: 8px;
    }

    .response-label {
      font-size: 10px;
      text-transform: uppercase;
      color: var(--accent);
      font-weight: 700;
      margin-bottom: 6px;
    }

    .response-content {
      font-size: 11px;
      color: var(--text-primary);
      line-height: 1.6;
    }

    /* ===== INPUT AREA ===== */
    .input-bar {
      grid-column: 2;
      grid-row: 3;
      border-top: 1px solid var(--border);
      background: rgba(15,23,42,.8);
      padding: 12px 16px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .input-field {
      flex: 1;
      padding: 12px 14px;
      background: rgba(30,41,59,.8);
      border: 1px solid rgba(148,163,184,.2);
      color: var(--text-primary);
      border-radius: 6px;
      font-size: 12px;
    }

    .input-field:focus {
      outline: none;
      border-color: rgba(96,165,250,.5);
      background: rgba(30,41,59,.95);
    }

    .btn-submit {
      padding: 10px 16px;
      background: var(--accent-dark);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 12px;
      transition: all 0.2s;
    }

    .btn-submit:hover { background: #2563eb; }

    .context-indicator {
      font-size: 11px;
      color: var(--text-secondary);
      padding: 4px 8px;
      background: rgba(96,165,250,.1);
      border-radius: 4px;
    }

    /* ===== SCROLLBARS ===== */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb {
      background: rgba(96,165,250,.3);
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover { background: rgba(96,165,250,.5); }

    /* ===== ANIMATIONS ===== */
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    .loading { animation: pulse 2s infinite; }
  </style>
</head>
<body>
  <div class="command-center">
    <!-- TOP BAR -->
    <div class="top-bar">
      <div class="logo"><i class="fas fa-brain"></i> TooLoo Command Center</div>
      <div class="mode-indicator">
        <div class="mode-badge" id="currentMode">üìä Planning Mode</div>
      </div>
      <div class="top-actions">
        <button class="btn-small" onclick="exportState()"><i class="fas fa-download"></i> Export</button>
        <button class="btn-small" onclick="saveState()"><i class="fas fa-save"></i> Save</button>
      </div>
    </div>

    <!-- LEFT PANEL -->
    <div class="left-panel">
      <div class="section">
        <div class="section-title">üìç Mode</div>
        <button class="mode-btn active" onclick="switchMode('planning')" id="mode-planning">
          <i class="fas fa-lightbulb"></i> Planning
        </button>
        <button class="mode-btn" onclick="switchMode('building')" id="mode-building">
          <i class="fas fa-hammer"></i> Building
        </button>
        <button class="mode-btn" onclick="switchMode('analyzing')" id="mode-analyzing">
          <i class="fas fa-chart-line"></i> Analyzing
        </button>
        <button class="mode-btn" onclick="switchMode('debugging')" id="mode-debugging">
          <i class="fas fa-bug"></i> Debugging
        </button>
      </div>

      <div class="section">
        <div class="section-title">‚≠ê Quick Access</div>
        <div class="quick-item" onclick="switchCanvas('ideation')"><i class="fas fa-bulb"></i> Ideation Board</div>
        <div class="quick-item" onclick="switchCanvas('roadmap')"><i class="fas fa-map"></i> Dynamic Roadmap</div>
        <div class="quick-item" onclick="switchCanvas('tasks')"><i class="fas fa-tasks"></i> Task Board</div>
      </div>

      <div class="section">
        <div class="section-title">üíæ Recent</div>
        <div class="quick-item" id="recent-1">Loading...</div>
        <div class="quick-item" id="recent-2">-</div>
        <div class="quick-item" id="recent-3">-</div>
      </div>
    </div>

    <!-- CENTER CANVAS -->
    <div class="center-canvas">
      <div class="canvas-tabs">
        <div class="canvas-tab active" onclick="switchCanvas('ideation')">üí° Ideation</div>
        <div class="canvas-tab" onclick="switchCanvas('roadmap')">üó∫Ô∏è Roadmap</div>
        <div class="canvas-tab" onclick="switchCanvas('tasks')">üìã Tasks</div>
      </div>

      <!-- IDEATION CANVAS -->
      <div class="canvas-content active" id="canvas-ideation">
        <h3 style="margin-bottom: 16px; color: var(--accent);">üí≠ Ideas & Concepts</h3>
        <div class="idea-grid" id="ideaGrid">
          <div class="idea-card">
            <div class="idea-icon">üé®</div>
            <div class="idea-title">Smart Response Engine</div>
            <div class="idea-desc">Context-aware formatting that adapts to your current mode</div>
            <div class="idea-tags">
              <span class="tag">UI/UX</span>
              <span class="tag">Core</span>
            </div>
          </div>

          <div class="idea-card">
            <div class="idea-icon">üéØ</div>
            <div class="idea-title">Dynamic Task Breakdown</div>
            <div class="idea-desc">Auto-generate weekly tasks from strategic roadmaps</div>
            <div class="idea-tags">
              <span class="tag">Automation</span>
            </div>
          </div>

          <div class="idea-card">
            <div class="idea-icon">üìä</div>
            <div class="idea-title">Visual Progress Tracker</div>
            <div class="idea-desc">Real-time visualization of project status and metrics</div>
            <div class="idea-tags">
              <span class="tag">Analytics</span>
            </div>
          </div>

          <div class="idea-card">
            <div class="idea-icon">üîó</div>
            <div class="idea-title">Context Linking</div>
            <div class="idea-desc">Connect ideas, tasks, and roadmap items bidirectionally</div>
            <div class="idea-tags">
              <span class="tag">Knowledge Graph</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ROADMAP CANVAS -->
      <div class="canvas-content" id="canvas-roadmap">
        <h3 style="margin-bottom: 16px; color: var(--accent);">üó∫Ô∏è Dynamic Roadmap</h3>
        <div class="roadmap-container" id="roadmapContainer">
          <div class="roadmap-phase">
            <div class="phase-header">
              <div class="phase-title">Phase 1: Foundation</div>
              <div class="phase-timeline">Week 1-2</div>
            </div>
            <div class="phase-tasks">
              <div class="task-item">
                <i class="fas fa-check-circle"></i>
                <span>Build command center UI</span>
              </div>
              <div class="task-item">
                <i class="fas fa-check-circle"></i>
                <span>Implement mode switching</span>
              </div>
              <div class="task-item">
                <i class="fas fa-circle"></i>
                <span>Smart response generation</span>
              </div>
            </div>
          </div>

          <div class="roadmap-phase">
            <div class="phase-header">
              <div class="phase-title">Phase 2: Intelligence</div>
              <div class="phase-timeline">Week 3-4</div>
            </div>
            <div class="phase-tasks">
              <div class="task-item">
                <i class="fas fa-circle"></i>
                <span>Context awareness engine</span>
              </div>
              <div class="task-item">
                <i class="fas fa-circle"></i>
                <span>Task auto-generation</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TASK BOARD CANVAS -->
      <div class="canvas-content" id="canvas-tasks">
        <h3 style="margin-bottom: 16px; color: var(--accent);">üìã Task Board (Monday.com Style)</h3>
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
          <div style="flex:1"></div>
          <button class="btn-small" onclick="createTaskPrompt()">+ Add Task</button>
        </div>
        <div class="board-container" id="boardContainer">
          <div class="board-column" id="backlogColumn">
            <div class="column-header">üìã Backlog</div>
            <div class="task-card">
              <div class="task-title">Design ideation UI</div>
              <div class="task-meta">
                <span class="task-priority">High</span>
              </div>
            </div>
            <div class="task-card">
              <div class="task-title">Research context systems</div>
              <div class="task-meta">
                <span class="task-priority">Medium</span>
              </div>
            </div>
          </div>

          <div class="board-column" id="inprogressColumn">
            <div class="column-header">üèóÔ∏è In Progress</div>
            <div class="task-card">
              <div class="task-title">Build canvas tabs</div>
              <div class="task-meta">
                <span style="color: var(--success);">In Progress</span>
              </div>
            </div>
          </div>

          <div class="board-column" id="doneColumn">
            <div class="column-header">‚úÖ Done</div>
            <div class="task-card">
              <div class="task-title">Create command center layout</div>
              <div class="task-meta">
                <span style="color: var(--success);">Completed</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT PANEL (AI RESPONSES) -->
    <div class="right-panel">
      <div class="response-header">
        <i class="fas fa-brain"></i> Smart Responses
      </div>
      <div class="response-box" id="responseBox">
        <div class="ai-response">
          <strong>Mode:</strong> Planning Mode<br>
          Ready to help you ideate and plan. Responses will be structured for strategic thinking.
        </div>

        <div class="response-section">
          <div class="response-label">Current Context</div>
          <div class="response-content">
            ‚Ä¢ Mode: Planning<br>
            ‚Ä¢ Focus: Ideation & Strategy<br>
            ‚Ä¢ Format: Conceptual & Visual
          </div>
        </div>

        <div class="response-section">
          <div class="response-label">Suggested Questions</div>
          <div class="response-content">
            ‚Ä¢ How should I structure this feature?<br>
            ‚Ä¢ What's my 3-week roadmap?<br>
            ‚Ä¢ Break this into weekly tasks?
          </div>
        </div>
      </div>
    </div>

    <!-- INPUT BAR -->
    <div class="input-bar">
      <input type="text" class="input-field" id="userInput" placeholder="Ask TooLoo in Planning mode..." onkeypress="handleKeyPress(event)">
      <div class="context-indicator" id="contextIndicator">üìä Planning</div>
      <button class="btn-submit" onclick="sendMessage()">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>

  <script>
    let currentMode = 'planning';
    let currentCanvas = 'ideation';
    let draggedElement = null;
    let planning_state = {};

    const modeConfig = {
      planning: {
        icon: 'üìä',
        label: 'Planning Mode',
        placeholder: 'Ask about strategy, roadmaps, ideas...',
        responseFormat: 'strategic'
      },
      building: {
        icon: 'üî®',
        label: 'Building Mode',
        placeholder: 'Ask about implementation, code, structure...',
        responseFormat: 'technical'
      },
      analyzing: {
        icon: 'üìà',
        label: 'Analyzing Mode',
        placeholder: 'Ask about metrics, data, performance...',
        responseFormat: 'analytical'
      },
      debugging: {
        icon: 'üêõ',
        label: 'Debugging Mode',
        placeholder: 'Ask about issues, errors, solutions...',
        responseFormat: 'diagnostic'
      }
    };

    // ===== DRAG & DROP LOGIC =====
    function enableDragDrop() {
      const taskCards = document.querySelectorAll('.task-card');
      taskCards.forEach(card => {
        card.draggable = true;
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragend', handleDragEnd);
      });

      const columns = document.querySelectorAll('.board-column');
      columns.forEach(col => {
        col.addEventListener('dragover', handleDragOver);
        col.addEventListener('drop', handleDrop);
        col.addEventListener('dragenter', handleDragEnter);
        col.addEventListener('dragleave', handleDragLeave);
      });
    }

    function handleDragStart(e) {
      draggedElement = this;
      this.style.opacity = '0.5';
      e.dataTransfer.effectAllowed = 'move';
    }

    function handleDragEnd(e) {
      if (draggedElement) {
        draggedElement.style.opacity = '1';
        draggedElement = null;
      }
      document.querySelectorAll('.board-column').forEach(col => {
        col.style.background = 'rgba(30,41,59,.6)';
      });
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      return false;
    }

    function handleDragEnter(e) {
      e.preventDefault();
      this.style.background = 'rgba(59,130,250,.15)';
    }

    function handleDragLeave(e) {
      if (e.target === this) {
        this.style.background = 'rgba(30,41,59,.6)';
      }
    }

    function handleDrop(e) {
      e.preventDefault();
      e.stopPropagation();
      
      if (draggedElement) {
        const column = this;
        const targetList = column.querySelector('.board-column') || column;
        
        // Find the actual column container
        let columnContainer = this.closest('.board-column');
        if (!columnContainer) {
          columnContainer = this;
        }

        // Move card to new column
        if (!columnContainer.contains(draggedElement)) {
          columnContainer.appendChild(draggedElement);
          savePlanningState();
        }
      }

      this.style.background = 'rgba(30,41,59,.6)';
      return false;
    }

    // ===== STATE MANAGEMENT =====
    async function loadPlanningState() {
      try {
        const response = await fetch('/api/v1/planning/state');
        if (response.ok) {
          planning_state = await response.json();
          console.log('Planning state loaded:', planning_state);
          // Render tasks/ideas/phases into the UI
          if (planning_state.tasks) renderPlanningTasks(planning_state.tasks);
          if (planning_state.ideas) renderIdeas(planning_state.ideas);
          if (planning_state.phases) renderPhases(planning_state.phases);
        }
      } catch (err) {
        console.log('Using local state:', err.message);
      }
    }

    async function savePlanningState() {
      try {
        const state = {
          mode: currentMode,
          canvas: currentCanvas,
          timestamp: new Date().toISOString(),
          tasks: Array.from(document.querySelectorAll('.task-card')).map((card, idx) => {
            const col = card.closest('.board-column');
            let columnKey = 'backlog';
            if (col) {
              if (col.id === 'inprogressColumn') columnKey = 'inprogress';
              else if (col.id === 'doneColumn') columnKey = 'done';
              else if (col.id === 'backlogColumn') columnKey = 'backlog';
              else {
                // fallback: inspect header text
                const header = col.querySelector('.column-header')?.textContent || '';
                if (header.toLowerCase().includes('in progress')) columnKey = 'inprogress';
                else if (header.toLowerCase().includes('done')) columnKey = 'done';
              }
            }

            return {
              id: card.dataset.taskId || `task-${idx}`,
              title: card.querySelector('.task-title')?.textContent || '',
              column: columnKey,
              priority: card.querySelector('.task-priority')?.textContent || 'normal'
            };
          })
        };

        const response = await fetch('/api/v1/planning/state', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(state)
        });

        if (response.ok) {
          console.log('State saved to database');
        }
      } catch (err) {
        console.log('State saved locally (no backend):', err.message);
      }
    }

    // ===== RENDER HELPERS =====
    function renderPlanningTasks(tasks) {
      try {
        const backlog = document.getElementById('backlogColumn');
        const inprogress = document.getElementById('inprogressColumn');
        const done = document.getElementById('doneColumn');
        [backlog, inprogress, done].forEach(col => {
          // remove existing dynamic task-cards
          Array.from(col.querySelectorAll('.task-card')).forEach(c => c.remove());
        });

        tasks.forEach(t => {
          const card = document.createElement('div');
          card.className = 'task-card';
          card.dataset.taskId = t.id || '';
          card.innerHTML = `<div class="task-title">${(t.title)||''}</div><div class="task-meta"><span class="task-priority">${t.priority||''}</span></div>`;
          // wire drag handlers
          card.draggable = true; card.addEventListener('dragstart', handleDragStart); card.addEventListener('dragend', handleDragEnd);

          if (t.column === 'inprogress') inprogress.appendChild(card);
          else if (t.column === 'done') done.appendChild(card);
          else backlog.appendChild(card);
        });
      } catch (e) { console.error('renderPlanningTasks error', e); }
    }

    function renderIdeas(ideas) {
      const grid = document.getElementById('ideaGrid');
      if (!grid) return;
      // remove previously added dynamic idea cards
      grid.querySelectorAll('.idea-card.dynamic').forEach(n => n.remove());
      ideas.forEach(i => {
        const card = document.createElement('div'); card.className = 'idea-card dynamic';
        card.innerHTML = `<div class="idea-icon">${i.icon||'üí°'}</div><div class="idea-title">${i.title||''}</div><div class="idea-desc">${i.description||''}</div>`;
        grid.appendChild(card);
      });
    }

    function renderPhases(phases) {
      const container = document.getElementById('roadmapContainer');
      if (!container) return;
      // remove dynamic phases
      container.querySelectorAll('.roadmap-phase.dynamic').forEach(n => n.remove());
      phases.forEach(p => {
        const el = document.createElement('div'); el.className = 'roadmap-phase dynamic';
        el.innerHTML = `<div class="phase-header"><div class="phase-title">${p.title||''}</div><div class="phase-timeline">${p.timeline||''}</div></div>`;
        container.appendChild(el);
      });
    }

    // ===== TASK CREATION =====
    async function createTaskPrompt() {
      const title = prompt('New task title');
      if (!title) return;
      try {
        const r = await fetch('/api/v1/planning/tasks', { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify({ title, description: '', priority: 'normal', column: 'backlog' }) });
        if (r.ok) await loadPlanningState();
      } catch (e) { console.error('createTaskPrompt error', e); }
    }

    // ===== MODE & CANVAS SWITCHING =====
    function switchMode(mode) {
      currentMode = mode;
      document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`mode-${mode}`).classList.add('active');
      
      const config = modeConfig[mode];
      document.getElementById('currentMode').textContent = `${config.icon} ${config.label}`;
      document.getElementById('userInput').placeholder = config.placeholder;
      document.getElementById('contextIndicator').textContent = `${config.icon} ${config.label.split(' ')[0]}`;
      
      updateResponseBox(mode);
      savePlanningState();
    }

    function switchCanvas(canvas) {
      currentCanvas = canvas;
      document.querySelectorAll('.canvas-content').forEach(el => el.classList.remove('active'));
      document.getElementById(`canvas-${canvas}`).classList.add('active');
      
      document.querySelectorAll('.canvas-tab').forEach(tab => tab.classList.remove('active'));
      if (event?.target) event.target.classList.add('active');

      if (canvas === 'tasks') {
        setTimeout(enableDragDrop, 100);
      }
    }

    function updateResponseBox(mode) {
      const responses = {
        planning: `
          <div class="ai-response"><strong>Planning Mode Activated</strong></div>
          <div class="response-section">
            <div class="response-label">Response Format</div>
            <div class="response-content">I'll structure responses with:<br>‚Ä¢ Strategic frameworks<br>‚Ä¢ Roadmaps & phases<br>‚Ä¢ Dependencies & timeline</div>
          </div>
        `,
        building: `
          <div class="ai-response"><strong>Building Mode Activated</strong></div>
          <div class="response-section">
            <div class="response-label">Response Format</div>
            <div class="response-content">I'll provide:<br>‚Ä¢ Code examples<br>‚Ä¢ Implementation steps<br>‚Ä¢ Technical details</div>
          </div>
        `,
        analyzing: `
          <div class="ai-response"><strong>Analyzing Mode Activated</strong></div>
          <div class="response-section">
            <div class="response-label">Response Format</div>
            <div class="response-content">I'll show:<br>‚Ä¢ Data patterns<br>‚Ä¢ Metrics & KPIs<br>‚Ä¢ Visual breakdowns</div>
          </div>
        `,
        debugging: `
          <div class="ai-response"><strong>Debugging Mode Activated</strong></div>
          <div class="response-section">
            <div class="response-label">Response Format</div>
            <div class="response-content">I'll diagnose:<br>‚Ä¢ Error analysis<br>‚Ä¢ Root causes<br>‚Ä¢ Step-by-step fixes</div>
          </div>
        `
      };
      document.getElementById('responseBox').innerHTML = responses[mode];
    }

    function handleKeyPress(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        sendMessage();
        event.preventDefault();
      }
    }

    async function sendMessage() {
      const input = document.getElementById('userInput');
      const message = input.value.trim();
      if (!message) return;

      const response = document.getElementById('responseBox');
      const config = modeConfig[currentMode];
      
      response.innerHTML = `
        <div class="ai-response loading">
          <i class="fas fa-spinner"></i> Querying in ${config.label}...
        </div>
      `;

      try {
        // Call real TooLoo API with context
        const aiResponse = await fetch('/api/v1/planning/query', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            query: message,
            mode: currentMode,
            canvas: currentCanvas,
            context: planning_state
          })
        });

        if (aiResponse.ok) {
          const result = await aiResponse.json();
          response.innerHTML = `
            <div class="ai-response">${result.response}</div>
            <div class="response-section">
              <div class="response-label">üí° Related</div>
              <div class="response-content">
                Ask me about: roadmaps, code structure, metrics, or solutions
              </div>
            </div>
          `;
        } else {
          throw new Error('API error');
        }
      } catch (err) {
        console.log('Using fallback responses:', err.message);
        
        const fallbackResponses = {
          planning: `<strong>Strategic Approach:</strong><br>
            1. <strong>Foundation (Week 1)</strong> - ${message}<br>
            2. <strong>Intelligence (Week 2)</strong> - Add context awareness<br>
            3. <strong>Refinement (Week 3)</strong> - Polish and optimize`,
          building: `<strong>Implementation Plan:</strong><br>
            1. Create solution for: ${message}<br>
            2. Add mode switcher with state management<br>
            3. Implement drag-drop for tasks`,
          analyzing: `<strong>Data Insights:</strong><br>
            ‚Ä¢ Question: ${message}<br>
            ‚Ä¢ Pattern 1: Most frequent use case<br>
            ‚Ä¢ Pattern 2: 60% adoption rate`,
          debugging: `<strong>Diagnostic Report:</strong><br>
            ‚úì Issue: ${message}<br>
            ‚úì Mode: ${currentMode}<br>
            ‚ö† Recommendation: Check logs`
        };

        response.innerHTML = `
          <div class="ai-response">${fallbackResponses[currentMode]}</div>
          <div class="response-section">
            <div class="response-label">üí° Related</div>
            <div class="response-content">Backend integration pending</div>
          </div>
        `;
      }

      input.value = '';
    }

    function saveState() {
      savePlanningState();
      alert('üíæ State saved to database!');
    }

    function exportState() {
      const state = {
        mode: currentMode,
        canvas: currentCanvas,
        tasks: Array.from(document.querySelectorAll('.task-card')).map((card, idx) => ({
          title: card.querySelector('.task-title')?.textContent,
          priority: card.querySelector('.task-priority')?.textContent,
          status: card.closest('.board-column')?.querySelector('.column-header')?.textContent
        }))
      };

      const json = JSON.stringify(state, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `planning-state-${new Date().toISOString().slice(0,10)}.json`;
      a.click();
    }

    // Initialize
    window.addEventListener('DOMContentLoaded', async () => {
      await loadPlanningState();
      updateResponseBox('planning');
      enableDragDrop();
    });
  </script>
</body>
</html>
