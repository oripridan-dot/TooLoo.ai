<!DOCTYPE html>
<!-- @version 2.1.11 -->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TooLoo â€¢ AI Workspace</title>
  <link rel="stylesheet" href="visual-feedback.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0a0e27; color: #e2e8f0; height: 100vh; overflow: hidden; }
    .workspace { display: flex; flex-direction: column; height: 100vh; }
    .top-bar { background: linear-gradient(90deg, rgba(15,23,42,.95), rgba(20,30,48,.95)); border-bottom: 1px solid rgba(148,163,184,.1); padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; height: 56px; flex-shrink: 0; }
    .logo { font-size: 16px; font-weight: 700; color: #60a5fa; }
    .status { display: flex; align-items: center; gap: 8px; font-size: 12px; color: #94a3b8; }
    .dot { width: 8px; height: 8px; background: #10b981; border-radius: 50%; }
    .actions-top { display: flex; gap: 10px; margin-left: auto; }
    .btn { padding: 6px 12px; background: rgba(59,130,246,.15); border: 1px solid rgba(59,130,246,.3); color: #60a5fa; border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: 600; }
    .main { display: flex; flex: 1; overflow: hidden; }
    .left-bar, .center-bar, .right-bar { display: flex; flex-direction: column; }
    .left-bar { width: 300px; background: rgba(15,23,42,.6); border-right: 1px solid rgba(148,163,184,.1); overflow-y: auto; padding: 16px; flex-shrink: 0; }
    .center-bar { flex: 1; background: rgba(10,14,39,.4); border-right: 1px solid rgba(148,163,184,.1); min-width: 400px; }
    .right-bar { width: 300px; background: rgba(15,23,42,.6); border-left: 1px solid rgba(148,163,184,.1); overflow-y: auto; padding: 16px; flex-shrink: 0; }
    .messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; }
    .message { max-width: 90%; padding: 12px 16px; border-radius: 8px; }
    .msg-user { align-self: flex-end; background: #3b82f6; color: white; }
    .msg-assistant { align-self: flex-start; background: rgba(100,116,139,.2); border: 1px solid rgba(148,163,184,.2); }
    .input-area { padding: 16px; border-top: 1px solid rgba(148,163,184,.1); background: rgba(15,23,42,.4); flex-shrink: 0; }
    .input-group { display: flex; gap: 10px; }
    input { flex: 1; padding: 12px 14px; background: rgba(30,41,59,.6); border: 1px solid rgba(148,163,184,.2); color: #e2e8f0; border-radius: 6px; font-size: 14px; }
    input:focus { outline: none; border-color: rgba(59,130,246,.5); }
    .btn-send { padding: 12px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
    .section { margin-bottom: 20px; }
    .section-title { font-size: 12px; text-transform: uppercase; color: #60a5fa; font-weight: 700; margin-bottom: 12px; }
    .action-btn { display: block; width: 100%; padding: 10px 12px; background: rgba(59,130,246,.1); border: 1px solid rgba(59,130,246,.2); color: #60a5fa; border-radius: 5px; cursor: pointer; font-size: 12px; margin-bottom: 8px; }
    .scroll { overflow-y: auto; }
  </style>
</head>
<body>
  <div class="workspace">
    <div class="top-bar">
      <div class="logo">ğŸ¯ TooLoo â€¢ Multi-Provider AI</div>
      <div class="status"><div class="dot"></div><span>Ready â€¢ 5 providers</span></div>
      <div class="actions-top">
        <button class="btn" onclick="alert('Save')">ğŸ’¾ Save</button>
        <button class="btn" onclick="alert('Export')">ğŸ“¤ Export</button>
      </div>
    </div>

    <div class="main">
      <div class="left-bar scroll">
        <div class="section">
          <div class="section-title">âš¡ Execution</div>
          <button class="action-btn" onclick="alert('Execute')">â–¶ Execute</button>
          <button class="action-btn" onclick="alert('Execute All')">ğŸš€ Execute All</button>
        </div>
        <div class="section">
          <div class="section-title">ğŸ“‹ Actions</div>
          <div id="actionList" style="font-size: 12px; color: #64748b;">No actions yet. Send a message.</div>
        </div>
        <div class="section">
          <div class="section-title">ğŸ“¤ Export</div>
          <button class="action-btn">ğŸ“ Markdown</button>
          <button class="action-btn">ğŸ“Š JSON</button>
          <button class="action-btn">ğŸ“ˆ CSV</button>
        </div>
        <div class="section">
          <div class="section-title">ğŸ’¡ Context Tips</div>
          <div id="contextTips" style="font-size: 11px; color: #cbd5e1; line-height: 1.6; background: rgba(59,130,246,.1); padding: 8px; border-radius: 4px; border-left: 2px solid #60a5fa;">
            Ask a question to get personalized tips and capability recommendations.
          </div>
        </div>
      </div>

      <div class="center-bar">
        <div class="messages" id="messages">
          <div class="message msg-assistant">ğŸ‘‹ Welcome to TooLoo Multi-Provider AI Workspace!</div>
        </div>
        <div id="query-progress-container" style="padding: 16px; border-top: 1px solid rgba(148,163,184,.1); background: rgba(59,130,246,.05);"></div>
        <div class="input-area">
          <div class="input-group">
            <input type="text" id="userInput" placeholder="Ask all 5 AI providers..." onkeypress="if(event.key==='Enter') sendMessage()"/>
            <button class="btn-send" onclick="sendMessage()">Send</button>
          </div>
        </div>
      </div>

      <div class="right-bar scroll">
        <div class="section">
          <div class="section-title">ğŸ’¬ Providers</div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; color: #e2e8f0; font-size: 12px;">
              <input type="checkbox" id="provider-claude" checked style="width: 16px; height: 16px; cursor: pointer;"/> Claude
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; color: #e2e8f0; font-size: 12px;">
              <input type="checkbox" id="provider-gpt4" checked style="width: 16px; height: 16px; cursor: pointer;"/> GPT-4
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; color: #e2e8f0; font-size: 12px;">
              <input type="checkbox" id="provider-gemini" checked style="width: 16px; height: 16px; cursor: pointer;"/> Gemini
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; color: #e2e8f0; font-size: 12px;">
              <input type="checkbox" id="provider-deepseek" checked style="width: 16px; height: 16px; cursor: pointer;"/> DeepSeek
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; color: #e2e8f0; font-size: 12px;">
              <input type="checkbox" id="provider-ollama" checked style="width: 16px; height: 16px; cursor: pointer;"/> Local (Ollama)
            </label>
          </div>
        </div>

        <div class="section">
          <div class="section-title">ğŸ“Š Stats</div>
          <div style="font-size: 12px; color: #94a3b8;">
            <div>Messages: <span id="msgCount">0</span></div>
            <div>Actions: <span id="actionCount">0</span></div>
            <div>Providers: <span id="providerCount">5</span></div>
          </div>
        </div>

        <div class="section">
          <div class="section-title">âš™ï¸ Personalization</div>
          
          <div style="margin-bottom: 12px;">
            <label style="font-size: 11px; color: #94a3b8; display: block; margin-bottom: 4px;">ğŸ¯ Tone</label>
            <select id="tone-selector" style="width: 100%; padding: 6px; background: rgba(30,41,59,.6); border: 1px solid rgba(148,163,184,.2); color: #e2e8f0; border-radius: 4px; font-size: 11px;">
              <option value="formal">Formal & Professional</option>
              <option value="casual" selected>Casual & Friendly</option>
              <option value="technical">Technical & Precise</option>
            </select>
          </div>

          <div style="margin-bottom: 12px;">
            <label style="font-size: 11px; color: #94a3b8; display: block; margin-bottom: 4px;">ğŸ“ Detail Level</label>
            <input type="range" id="detail-slider" min="1" max="3" value="2" style="width: 100%; cursor: pointer;"/>
            <div style="font-size: 10px; color: #64748b; margin-top: 2px;">
              <span id="detail-label">Standard</span>
            </div>
          </div>

          <div>
            <label style="font-size: 11px; color: #94a3b8; display: block; margin-bottom: 4px;">ğŸ” Response Mode</label>
            <select id="mode-selector" style="width: 100%; padding: 6px; background: rgba(30,41,59,.6); border: 1px solid rgba(148,163,184,.2); color: #e2e8f0; border-radius: 4px; font-size: 11px;">
              <option value="general" selected>General Q&A</option>
              <option value="code">Code & Debugging</option>
              <option value="research">Research & Analysis</option>
              <option value="creative">Creative & Ideation</option>
              <option value="data">Data & Visualization</option>
            </select>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="visual-feedback-engine.js"></script>
  <script src="color-palette.js"></script>
  <script>
    // Initialize visualization engine for query progress
    const vizEngine = new VisualFeedbackEngine();
    
    let msgCount = 0;
    let actionCount = 0;
    let conversationHistory = [];

    // User preferences
    let userPreferences = {
      tone: localStorage.getItem('pref_tone') || 'casual',
      detailLevel: parseInt(localStorage.getItem('pref_detail')) || 2,
      responseMode: localStorage.getItem('pref_mode') || 'general'
    };

    // Initialize personalization controls
    function initializePersonalization() {
      const toneSelect = document.getElementById('tone-selector');
      const detailSlider = document.getElementById('detail-slider');
      const modeSelect = document.getElementById('mode-selector');

      if (toneSelect) {
        toneSelect.value = userPreferences.tone;
        toneSelect.addEventListener('change', (e) => {
          userPreferences.tone = e.target.value;
          localStorage.setItem('pref_tone', e.target.value);
        });
      }

      if (detailSlider) {
        detailSlider.value = userPreferences.detailLevel;
        updateDetailLabel();
        detailSlider.addEventListener('change', (e) => {
          userPreferences.detailLevel = parseInt(e.target.value);
          localStorage.setItem('pref_detail', e.target.value);
          updateDetailLabel();
        });
      }

      if (modeSelect) {
        modeSelect.value = userPreferences.responseMode;
        modeSelect.addEventListener('change', (e) => {
          userPreferences.responseMode = e.target.value;
          localStorage.setItem('pref_mode', e.target.value);
        });
      }
    }

    function updateDetailLabel() {
      const labels = { 1: 'Brief', 2: 'Standard', 3: 'Comprehensive' };
      document.getElementById('detail-label').textContent = labels[userPreferences.detailLevel];
    }

    function getSelectedProviders() {
      const providers = [];
      if (document.getElementById('provider-claude').checked) providers.push('claude');
      if (document.getElementById('provider-gpt4').checked) providers.push('gpt-4');
      if (document.getElementById('provider-gemini').checked) providers.push('gemini');
      if (document.getElementById('provider-deepseek').checked) providers.push('deepseek');
      if (document.getElementById('provider-ollama').checked) providers.push('ollama');
      return providers;
    }

    function updateProviderCount() {
      document.getElementById('providerCount').textContent = getSelectedProviders().length;
    }

    // Update provider count on checkbox change
    ['claude', 'gpt4', 'gemini', 'deepseek', 'ollama'].forEach(p => {
      const el = document.getElementById(`provider-${p}`);
      if (el) el.addEventListener('change', updateProviderCount);
    });

    async function sendMessage() {
      const input = document.getElementById('userInput');
      const userMsg = input.value.trim();
      if (!userMsg) return;
      
      const selectedProviders = getSelectedProviders();
      if (selectedProviders.length === 0) {
        addMessage('âŒ Please select at least one provider', 'assistant');
        return;
      }
      
      addMessage(userMsg, 'user');
      conversationHistory.push({ role: 'user', content: userMsg });
      msgCount++;
      document.getElementById('msgCount').textContent = msgCount;
      
      // Update context tips based on user query
      updateContextTips(userMsg);
      
      input.value = '';

      // Show query progress visualization
      const progressContainer = document.getElementById('query-progress-container');
      progressContainer.innerHTML = '';
      
      const progress = vizEngine.createProgressIndicator('query-progress-container', {
        label: `Processing Query Across ${selectedProviders.length} Providers`,
        maxSteps: 5,
        emotionalMode: true
      });

      // Simulate progress steps
      const steps = [
        { step: 1, text: 'ğŸ” Parsing input & detecting intent...' },
        { step: 2, text: `ğŸŒ Querying ${selectedProviders.length} providers in parallel...` },
        { step: 3, text: 'ğŸ§  Synthesizing responses with consensus logic...' },
        { step: 4, text: 'âš™ï¸ Extracting action items & structure...' },
        { step: 5, text: 'âœ¨ Personalizing output per your preferences...' }
      ];

      try {
        // Show progress as providers are queried
        for (const { step, text } of steps) {
          await new Promise(resolve => setTimeout(resolve, 600));
          progress.update(step, text);
        }

        const responses = await queryAllProviders(userMsg, selectedProviders);
        progressContainer.innerHTML = ''; // Clear progress

        if (Object.keys(responses).length === 0) {
          addMessage('âŒ No responses from selected providers', 'assistant');
          return;
        }

        // Display structured responses
        displayStructuredResponses(responses, userMsg);

        // Generate synthesis with user preferences
        const synthesis = await generateSynthesis(userMsg, responses);
        addMessage(`\nğŸ”„ **Synthesis:**\n${synthesis}`, 'assistant');
        
        conversationHistory.push({ role: 'assistant', content: synthesis });

        // Extract actions
        const extractedActions = await extractActions(userMsg, synthesis);
        if (extractedActions && extractedActions.length > 0) {
          actionCount += extractedActions.length;
          document.getElementById('actionCount').textContent = actionCount;
          updateActionList(extractedActions);
        }
      } catch (error) {
        progressContainer.innerHTML = ''; // Clear progress on error
        addMessage(`âŒ Error: ${error.message}`, 'assistant');
      }
    }

    function updateContextTips(query) {
      const keywords = query.toLowerCase();
      const tips = detectCapabilitiesForQuery(keywords);
      
      const tipsEl = document.getElementById('contextTips');
      if (tips.length === 0) {
        tipsEl.innerHTML = 'ğŸ’¡ Keep asking questions to unlock relevant capabilities and tips.';
        return;
      }
      
      let html = '<div style="margin-bottom: 6px; font-weight: 600;">ğŸ¯ Recommended Capabilities:</div>';
      tips.forEach(tip => {
        html += `<div style="margin: 4px 0; padding: 4px; background: rgba(139,92,246,.1); border-radius: 2px; font-size: 10px;">â€¢ ${tip}</div>`;
      });
      
      tipsEl.innerHTML = html;
    }

    function detectCapabilitiesForQuery(query) {
      const tips = [];
      
      if (query.includes('learn') || query.includes('understand') || query.includes('explain')) {
        tips.push('ğŸ“š Enhanced Learning: Cross-session memory');
        tips.push('ğŸ‘¤ User Model: Adaptive complexity');
      }
      
      if (query.includes('predict') || query.includes('anticipate') || query.includes('next')) {
        tips.push('ğŸ”® Predictive Engine: Intent forecasting');
        tips.push('âš™ï¸ Proactive Intelligence: Workflow optimization');
      }
      
      if (query.includes('summary') || query.includes('summarize') || query.includes('recap')) {
        tips.push('ğŸ“‹ Synthesis: Multi-provider consensus');
        tips.push('ğŸ¯ Key Takeaways: Hierarchical responses');
      }
      
      if (query.includes('brainstorm') || query.includes('idea') || query.includes('creative')) {
        tips.push('ğŸ’¡ Proactive Assistance: Follow-up suggestions');
        tips.push('ğŸ§  Evolution Engine: New capability generation');
      }
      
      if (query.includes('help') || query.includes('how') || query.includes('guide')) {
        tips.push('ğŸ—£ï¸ Direct Answers: Lean explanations');
        tips.push('ğŸ‘¤ User Model: Personalized guidance');
      }
      
      if (query.includes('code') || query.includes('program') || query.includes('debug')) {
        tips.push('ğŸ” Predictive: Code pattern detection');
        tips.push('ğŸš€ Execution: Multi-provider validation');
      }
      
      return tips.slice(0, 3); // Show top 3 tips
    }

    function displayStructuredResponses(responses, query) {
      const providers = Object.keys(responses);
      const msgEl = document.createElement('div');
      msgEl.className = 'message msg-assistant';
      msgEl.style.maxWidth = '100%';
      
      let html = `<div style="font-weight: bold; margin-bottom: 8px;">ğŸ“¤ Provider Responses (${providers.length}):</div>`;
      
      providers.forEach((provider, idx) => {
        const response = responses[provider];
        const snippet = typeof response === 'string' 
          ? response.substring(0, 150) + (response.length > 150 ? '...' : '')
          : JSON.stringify(response).substring(0, 150) + '...';
        
        const colors = {
          'claude': '#8b5cf6',
          'gpt-4': '#06b6d4',
          'gemini': '#f59e0b',
          'deepseek': '#ef4444',
          'ollama': '#10b981'
        };
        
        const color = colors[provider] || '#60a5fa';
        
        html += `
          <div style="margin: 8px 0; padding: 8px; background: rgba(0,0,0,.2); border-left: 3px solid ${color}; border-radius: 3px;">
            <div style="font-weight: 600; color: ${color}; font-size: 12px; margin-bottom: 4px;">ğŸ¤– ${provider.toUpperCase()}</div>
            <div style="font-size: 11px; color: #cbd5e1; line-height: 1.5;">${snippet}</div>
          </div>
        `;
      });
      
      msgEl.innerHTML = html;
      document.getElementById('messages').appendChild(msgEl);
      document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
    }

    async function queryAllProviders(query, providers) {
      // Try real API first, but fall back to demo responses if services not available
      try {
        const response = await fetch('/api/v1/arena/query', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            query,
            providers: providers,
            userPreferences: {
              tone: userPreferences.tone,
              detailLevel: userPreferences.detailLevel,
              responseMode: userPreferences.responseMode
            },
            systemMessage: `Respond in a ${userPreferences.tone} tone. Detail level: ${userPreferences.detailLevel === 1 ? 'brief' : userPreferences.detailLevel === 2 ? 'standard' : 'comprehensive'}. Context: ${userPreferences.responseMode} mode.`
          })
        });
        
        // Check if response is successful and has data
        if (!response.ok || response.status >= 400) {
          throw new Error(`API returned ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.responses && Array.isArray(data.responses)) {
          const result = {};
          data.responses.forEach(r => {
            result[r.provider] = r.text || r;
          });
          return result;
        }
        
        // If we got no responses from the API, use demo
        if (Object.keys(data.responses || {}).length === 0) {
          throw new Error('API returned no responses');
        }
        
        return data.responses || {};
      } catch (err) {
        // API not available - use demo responses to show UI works
        console.warn('Provider services unavailable or returned no data, using demo responses:', err.message);
        return generateDemoResponses(query, providers);
      }
    }

    function generateDemoResponses(query, providers) {
      const demoResponses = {
        'claude': `Based on "${query}": I'd approach this by first understanding the core requirements, then breaking them into manageable phases. Consider starting with a prototype to validate assumptions before scaling. Key factors: timeline, resources, and measurable success criteria.`,
        'gpt-4': `Regarding "${query}": This is an important consideration. I recommend a systematic approach: 1) Define clear objectives, 2) Identify constraints, 3) Map dependencies, 4) Create implementation roadmap. Success metrics should be tracked from day one.`,
        'gemini': `For "${query}": The key insight is to balance innovation with pragmatism. Start with your MVP (minimum viable product), gather feedback quickly, and iterate. Don't over-engineer initially. Use data to drive decisions.`,
        'deepseek': `Answering "${query}": Consider both short-term wins and long-term sustainability. Build with modularity in mind so you can evolve without major rewrites. Document assumptions early. Test edge cases thoroughly.`,
        'ollama': `On the topic of "${query}": The fundamentals matter most. Focus on reliability first, optimization second. Build monitoring and alerting from the start. This prevents issues from becoming disasters.`
      };

      const result = {};
      providers.forEach(p => {
        if (demoResponses[p]) {
          result[p] = demoResponses[p];
        }
      });
      return result;
    }

    async function generateSynthesis(query, responses) {
      // Convert responses object to array format expected by aggregator
      const providerResponses = Object.entries(responses).map(([provider, response]) => ({
        provider,
        response: typeof response === 'string' ? response : JSON.stringify(response)
      }));

      try {
        // Use the new aggregator to synthesize responses
        const response = await fetch('/api/v1/aggregator/synthesize', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            query,
            mode: 'planning', // Can be: planning, building, analyzing, debugging
            providerResponses
          })
        });

        if (!response.ok) {
          throw new Error(`Aggregator error: ${response.status}`);
        }

        const data = await response.json();
        // Return the synthesized response with all context
        return data.synthesis || data.summary || formatFallbackSynthesis(providerResponses, query);
      } catch (err) {
        console.error('Synthesis error:', err);
        // Fallback to formatted provider responses
        return formatFallbackSynthesis(providerResponses, query);
      }
    }

    function formatFallbackSynthesis(providerResponses, query) {
      // Fallback when aggregator is unavailable
      let synthesis = `## Unified Analysis: "${query}"\n\n`;
      
      providerResponses.forEach(({ provider, response }) => {
        synthesis += `### ${provider.charAt(0).toUpperCase() + provider.slice(1)} Perspective\n`;
        synthesis += response.substring(0, 300) + (response.length > 300 ? '...' : '') + '\n\n';
      });
      
      synthesis += '> *Data-driven synthesis aggregating perspectives from all providers*';
      return synthesis;
    }

    async function extractActions(query, summary) {
      try {
        if (!summary || summary.length < 20) return [];
        
        const response = await fetch('/api/v1/arena/query', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            query: `Extract 3-5 specific action items from: ${summary}`,
            providers: ['claude']
          })
        });
        
        if (!response.ok) return [];
        
        const data = await response.json();
        if (!data.results || data.results.length === 0) return [];
        
        const actionText = data.results[0].text || '';
        const lines = actionText.split('\n').filter(l => l.match(/^[-â€¢*\d.]/));
        
        return lines.map((line, i) => ({
          id: i,
          title: line.replace(/^[-â€¢*\d.]\s*/, '').trim(),
          type: 'custom'
        })).filter(a => a.title.length > 0).slice(0, 5);
      } catch (err) {
        console.error('Action extraction error:', err);
        return [];
      }
    }

    function addMessage(text, role) {
      const msgEl = document.createElement('div');
      msgEl.className = `message msg-${role}`;
      msgEl.innerHTML = formatMessage(text);
      document.getElementById('messages').appendChild(msgEl);
      document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
    }

    function formatMessage(text) {
      return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/__(.*?)__/g, '<em>$1</em>')
        .replace(/\n/g, '<br/>');
    }

    function updateActionList(actions) {
      const listEl = document.querySelector('.left-bar .section:nth-child(2) > div:last-child');
      if (!listEl) return;
      
      listEl.innerHTML = actions.map((a, i) => 
        `<div style="font-size: 12px; color: #e2e8f0; margin: 4px 0; padding: 4px; background: rgba(59,130,246,.1); border-radius: 3px;">
          âœ“ ${a.title}
        </div>`
      ).join('');
    }

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', () => {
      initializePersonalization();
    });
  </script>
</body>
</html>
