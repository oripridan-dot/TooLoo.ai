<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TooLoo ‚Ä¢ AI Workspace</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
      background: #0a0e27;
      color: #e2e8f0;
      height: 100vh;
      overflow: hidden;
    }

    .workspace {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* TOP BAR */
    .top-bar {
      background: linear-gradient(90deg, rgba(15,23,42,.95), rgba(20,30,48,.95));
      border-bottom: 1px solid rgba(148,163,184,.1);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 56px;
      flex-shrink: 0;
    }

    .logo { font-size: 16px; font-weight: 700; color: #60a5fa; }
    
    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #94a3b8;
    }

    .dot { width: 8px; height: 8px; background: #10b981; border-radius: 50%; }

    .actions-top {
      display: flex;
      gap: 10px;
      margin-left: auto;
    }

    .btn {
      padding: 6px 12px;
      background: rgba(59,130,246,.15);
      border: 1px solid rgba(59,130,246,.3);
      color: #60a5fa;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all .2s;
    }

    .btn:hover { background: rgba(59,130,246,.25); }

    /* MAIN CONTENT */
    .main {
      display: flex;
      flex: 1;
      gap: 1px;
      overflow: hidden;
      background: rgba(0,0,0,.2);
    }

    /* LEFT BAR - Dynamic Context Content */
    .left-bar {
      width: 320px !important;
      min-width: 320px !important;
      background: rgba(15,23,42,.6);
      border-right: 1px solid rgba(148,163,184,.1);
      display: flex !important;
      flex-direction: column;
      overflow-y: auto;
      padding: 0;
      flex-shrink: 0 !important;
    }

    /* Session Menu - Hidden by default */
    .session-menu-btn {
      background: rgba(20,30,48,.8);
      border-bottom: 1px solid rgba(148,163,184,.1);
      padding: 12px 16px;
      cursor: pointer;
      transition: all .2s;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      color: #60a5fa;
    }

    .session-menu-btn:hover {
      background: rgba(25,35,55,.9);
    }

    /* Overlay menu for session controls */
    .menu-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,.7);
      display: none;
      z-index: 999;
      animation: fadeIn .2s;
    }

    .menu-overlay.open {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .menu-panel {
      background: rgba(15,23,42,.95);
      border: 1px solid rgba(148,163,184,.2);
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,.8);
      animation: slideUp .3s ease-out;
    }

    @keyframes slideUp {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .menu-header {
      padding: 20px;
      border-bottom: 1px solid rgba(148,163,184,.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .menu-header h2 {
      font-size: 18px;
      color: #e2e8f0;
      margin: 0;
    }

    .menu-close-btn {
      background: none;
      border: none;
      color: #94a3b8;
      font-size: 20px;
      cursor: pointer;
      transition: color .2s;
    }

    .menu-close-btn:hover {
      color: #e2e8f0;
    }

    .menu-section {
      padding: 16px 20px;
      border-bottom: 1px solid rgba(148,163,184,.1);
    }

    .menu-section-title {
      font-size: 12px;
      font-weight: 700;
      color: #60a5fa;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
    }

    .menu-stat {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid rgba(148,163,184,.05);
      font-size: 14px;
    }

    .menu-stat:last-child {
      border-bottom: none;
    }

    .menu-stat-label {
      color: #94a3b8;
    }

    .menu-stat-value {
      color: #60a5fa;
      font-weight: 600;
    }

    .menu-button {
      width: 100%;
      padding: 10px 12px;
      background: rgba(59,130,246,.15);
      border: 1px solid rgba(59,130,246,.3);
      color: #60a5fa;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      margin-bottom: 8px;
      transition: all .2s;
      text-align: left;
    }

    .menu-button:last-child {
      margin-bottom: 0;
    }

    .menu-button:hover {
      background: rgba(59,130,246,.25);
      border-color: rgba(59,130,246,.5);
    }

    .memory-item {
      padding: 8px 12px;
      background: rgba(15,30,55,.6);
      border-left: 3px solid #60a5fa;
      margin-bottom: 6px;
      border-radius: 4px;
      font-size: 12px;
      color: #cbd5e1;
    }

    .memory-label {
      color: #60a5fa;
      font-weight: 600;
    }

    .session-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .session-title {
      font-size: 13px;
      font-weight: 700;
      color: #60a5fa;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .session-toggle {
      font-size: 12px;
      color: #94a3b8;
      transition: transform .2s;
    }

    .session-toggle.collapsed {
      transform: rotate(-90deg);
    }

    .session-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(148,163,184,.1);
      max-height: 300px;
      overflow: hidden;
      transition: max-height .3s ease;
    }

    .session-stats.collapsed {
      max-height: 0;
      margin-top: 0;
      padding-top: 0;
      border-top: none;
    }

    .stat-mini {
      background: rgba(59,130,246,.1);
      border: 1px solid rgba(59,130,246,.2);
      padding: 8px;
      border-radius: 4px;
      text-align: center;
    }

    .stat-mini-value {
      font-size: 18px;
      font-weight: 700;
      color: #60a5fa;
    }

    .stat-mini-label {
      font-size: 10px;
      color: #94a3b8;
      margin-top: 4px;
    }

    /* Dynamic Context Bar */
    .context-bar {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .context-section {
      background: rgba(30,41,59,.5);
      border: 1px solid rgba(148,163,184,.1);
      border-radius: 8px;
      padding: 12px;
    }

    .context-title {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      color: #60a5fa;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .context-tip {
      font-size: 12px;
      line-height: 1.5;
      color: #cbd5e1;
      margin-bottom: 8px;
      padding: 8px;
      background: rgba(59,130,246,.05);
      border-left: 3px solid #60a5fa;
      border-radius: 4px;
    }

    .context-tip strong {
      color: #93c5fd;
    }

    .context-tools {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .context-tool {
      font-size: 11px;
      padding: 8px;
      background: rgba(139,92,246,.1);
      border: 1px solid rgba(139,92,246,.2);
      border-radius: 4px;
      color: #c4b5fd;
      cursor: pointer;
      transition: all .2s;
    }

    .context-tool:hover {
      background: rgba(139,92,246,.2);
      border-color: rgba(139,92,246,.4);
    }

    .context-tool-name {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .context-tool-desc {
      font-size: 10px;
      color: #a78bfa;
      opacity: .8;
    }

    .divider {
      height: 1px;
      background: rgba(148,163,184,.1);
      margin: 0;
    }

    /* CENTER - Conversation */
    .center-bar {
      flex: 1 1 auto !important;
      display: flex !important;
      flex-direction: column !important;
      background: rgba(10,14,39,.4);
      border-right: 1px solid rgba(148,163,184,.1);
      overflow: hidden !important;
      min-width: 400px !important;
    }

    .messages {
      flex: 1 1 auto !important;
      overflow-y: auto !important;
      overflow-x: hidden !important;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      min-height: 0 !important;
    }

    .message {
      max-width: 90%;
      padding: 12px 16px;
      border-radius: 8px;
      animation: slideIn .3s ease-out;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .msg-user {
      align-self: flex-end;
      background: #3b82f6;
      color: white;
    }

    .msg-assistant {
      align-self: flex-start;
      background: rgba(100,116,139,.2);
      border: 1px solid rgba(148,163,184,.2);
    }

    .msg-summary {
      align-self: flex-start;
      background: rgba(34,197,94,.1);
      border-left: 3px solid #22c55e;
      padding-left: 12px;
    }

    .input-area {
      padding: 16px;
      border-top: 1px solid rgba(148,163,184,.1);
      background: rgba(15,23,42,.4);
      flex-shrink: 0 !important;
      flex-grow: 0 !important;
      order: 2 !important;
    }

    .input-group {
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }

    input {
      flex: 1;
      padding: 12px 14px;
      background: rgba(30,41,59,.6);
      border: 1px solid rgba(148,163,184,.2);
      color: #e2e8f0;
      border-radius: 6px;
      font-size: 14px;
      transition: border .2s;
    }

    input:focus {
      outline: none;
      border-color: rgba(59,130,246,.5);
      background: rgba(30,41,59,.8);
    }

    .btn-send {
      padding: 12px 20px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all .2s;
    }

    .btn-send:hover { background: #2563eb; }
    .btn-send:disabled { background: #64748b; cursor: not-allowed; }

    /* RIGHT BAR - Output Options */
    .right-bar {
      width: 320px !important;
      min-width: 320px !important;
      background: rgba(15,23,42,.6);
      border-left: 1px solid rgba(148,163,184,.1);
      display: flex !important;
      flex-direction: column;
      overflow-y: auto;
      padding: 16px;
      flex-shrink: 0 !important;
    }

    .section {
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 12px;
      text-transform: uppercase;
      color: #60a5fa;
      font-weight: 700;
      margin-bottom: 12px;
    }

    .action-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      padding: 10px 12px;
      background: rgba(59,130,246,.1);
      border: 1px solid rgba(59,130,246,.2);
      color: #60a5fa;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      transition: all .2s;
      text-align: left;
    }

    .action-btn:hover {
      background: rgba(59,130,246,.2);
      border-color: rgba(59,130,246,.4);
    }

    .action-btn.executing {
      background: rgba(251,146,60,.1);
      border-color: rgba(251,146,60,.3);
      color: #fb923c;
    }

    .action-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .action-item {
      padding: 10px;
      background: rgba(34,197,94,.05);
      border-left: 3px solid #22c55e;
      border-radius: 4px;
      font-size: 12px;
      color: #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .action-item .run-btn {
      padding: 4px 10px;
      background: #22c55e;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
      transition: all .2s;
    }

    .action-item .run-btn:hover { background: #16a34a; }

    .export-btn {
      width: 100%;
      padding: 10px 12px;
      background: rgba(139,92,246,.1);
      border: 1px solid rgba(139,92,246,.2);
      color: #a78bfa;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      transition: all .2s;
    }

    .export-btn:hover {
      background: rgba(139,92,246,.2);
      border-color: rgba(139,92,246,.4);
    }

    .asset-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px;
      background: rgba(100,116,139,.1);
      border-radius: 4px;
      font-size: 12px;
      margin-bottom: 6px;
    }

    .asset-link {
      color: #60a5fa;
      cursor: pointer;
      text-decoration: none;
      transition: color .2s;
    }

    .asset-link:hover { color: #93c5fd; }

    .scroll { overflow-y: auto; }
    .scroll::-webkit-scrollbar { width: 6px; }
    .scroll::-webkit-scrollbar-track { background: transparent; }
    .scroll::-webkit-scrollbar-thumb { background: rgba(148,163,184,.2); border-radius: 3px; }
  </style>
</head>
<body>
  <div class="workspace">
    <!-- TOP BAR -->
    <div class="top-bar">
      <div class="logo">üéØ TooLoo ‚Ä¢ Multi-Provider AI</div>
      <div class="status">
        <div class="dot"></div>
        <span id="statusText">Ready ‚Ä¢ 5 providers</span>
      </div>
      <div class="actions-top">
        <button class="btn" onclick="saveSession()">üíæ Save</button>
        <button class="btn" onclick="exportSession()">üì§ Export</button>
      </div>
    </div>

    <!-- MAIN LAYOUT -->
    <div class="main">
      <!-- LEFT: Menu Button + Context Bar -->
      <div class="left-bar">
        <!-- Session Menu Button -->
        <div class="session-menu-btn" onclick="openSessionMenu()">
          ‚ò∞ Session & Memory
        </div>

        <!-- Session Stats - Hidden in menu -->
        <div class="session-stats" id="sessionStats" style="display: none;">
            <div class="stat-mini">
              <div class="stat-mini-value" id="msgCountMini">0</div>
              <div class="stat-mini-label">Messages</div>
            </div>
            <div class="stat-mini">
              <div class="stat-mini-value" id="actionCountMini">0</div>
              <div class="stat-mini-label">Actions</div>
            </div>
            <div class="stat-mini">
              <div class="stat-mini-value" id="decisionCountMini">0</div>
              <div class="stat-mini-label">Decisions</div>
            </div>
            <div class="stat-mini">
              <div class="stat-mini-value" id="sessionTimeMini">0m</div>
              <div class="stat-mini-label">Time</div>
            </div>
          </div>
        </div>

        <!-- Dynamic Context Bar -->
        <div class="context-bar" id="contextBar">
          <!-- Populated dynamically based on conversation context -->
        </div>
      </div>

      <!-- CENTER: Conversation -->
      <div class="center-bar">
        <div class="messages" id="messages">
          <div class="msg-assistant">
            üëã Welcome to TooLoo Multi-Provider AI Workspace. I'm synthesizing responses from Claude, GPT-4, Gemini, DeepSeek, and Local models by default. Just ask your question!
          </div>
        </div>

        <div class="input-area">
          <div class="input-group">
            <input 
              type="text" 
              id="userInput" 
              placeholder="Ask all 5 AI providers... (e.g., 'Design a mobile app', 'Create a function for...', 'Analyze this code')"
              onkeypress="if(event.key==='Enter') sendMessage()"
            />
            <button class="btn-send" onclick="sendMessage()" id="sendBtn">Send</button>
          </div>
        </div>
      </div>

      <!-- RIGHT: Output Options -->
      <div class="right-bar scroll">
        <div class="section">
          <div class="section-title">‚ö° Execution</div>
          <button class="action-btn" onclick="executeSelected()">‚ñ∂ Execute Selected</button>
          <button class="action-btn" onclick="executeAll()">üöÄ Execute All</button>
        </div>

        <div class="section">
          <div class="section-title">üìã Actions</div>
          <div class="action-list" id="actionList">
            <div style="color: #64748b; font-size: 12px;">No actions yet. Send a message to generate actions.</div>
          </div>
        </div>

        <div class="section">
          <div class="section-title">üì§ Export & Preview</div>
          <button class="export-btn" onclick="exportMarkdown()">üìù Export as Markdown</button>
          <button class="export-btn" onclick="exportJSON()">üìä Export as JSON</button>
          <button class="export-btn" onclick="downloadCSV()">üìà Export as CSV</button>
        </div>

        <div class="section">
          <div class="section-title">üéØ Generated Assets</div>
          <div id="assetList" style="font-size: 12px; color: #64748b;">
            No assets yet. Execute actions to generate files.
          </div>
        </div>

        <div class="section">
          <div class="section-title">üß† Self-Improvement</div>
          <button class="action-btn" onclick="analyzeCodebase()">üìä Analyze Codebase</button>
          <button class="action-btn" onclick="selfAnalyze()">üîç Self-Analyze</button>
          <button class="action-btn" onclick="viewImprovementHistory()">üìú View History</button>
        </div>

        <div class="section">
          <div class="section-title">üé® Design & Production</div>
          <button class="action-btn" onclick="generateDesignSystem()">üé® Create Design System</button>
          <button class="action-btn" onclick="generateComponent()">üß© Generate Component</button>
          <button class="action-btn" onclick="designToCode()">üíª Design ‚Üí Code</button>
          <button class="action-btn" onclick="validateDesign()">‚úÖ Validate Design</button>
        </div>

        <div class="section">
          <div class="section-title">üí° Provider Insights</div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <div style="font-size: 11px; color: #94a3b8;">
              <strong>Claude:</strong> Best for analysis & reasoning
            </div>
            <div style="font-size: 11px; color: #94a3b8;">
              <strong>GPT-4:</strong> Great for creativity & synthesis
            </div>
            <div style="font-size: 11px; color: #94a3b8;">
              <strong>Gemini:</strong> Excellent for research & data
            </div>
            <div style="font-size: 11px; color: #94a3b8;">
              <strong>DeepSeek:</strong> Strong at technical depth
            </div>
            <div style="font-size: 11px; color: #94a3b8;">
              <strong>Local:</strong> Privacy-first alternative
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Menu Overlay -->
  <div class="menu-overlay" id="menuOverlay" onclick="closeSessionMenu(event)">
    <div class="menu-panel" onclick="event.stopPropagation()">
      <div class="menu-header">
        <h2>Session & Memory</h2>
        <button class="menu-close-btn" onclick="closeSessionMenu()">‚úï</button>
      </div>

      <div class="menu-section">
        <div class="menu-section-title">Session Stats</div>
        <div class="menu-stat">
          <span class="menu-stat-label">Messages</span>
          <span class="menu-stat-value" id="menuMsgCount">0</span>
        </div>
        <div class="menu-stat">
          <span class="menu-stat-label">Actions</span>
          <span class="menu-stat-value" id="menuActionCount">0</span>
        </div>
        <div class="menu-stat">
          <span class="menu-stat-label">Decisions</span>
          <span class="menu-stat-value" id="menuDecisionCount">0</span>
        </div>
        <div class="menu-stat">
          <span class="menu-stat-label">Session Time</span>
          <span class="menu-stat-value" id="menuSessionTime">0m</span>
        </div>
        <div class="menu-stat">
          <span class="menu-stat-label">Current Context</span>
          <span class="menu-stat-value" id="menuCurrentContext">General</span>
        </div>
      </div>

      <div class="menu-section">
        <div class="menu-section-title">Conversation Memory</div>
        <div id="conversationMemory" style="max-height: 200px; overflow-y: auto;">
          <div style="color: #94a3b8; font-size: 12px;">No conversation yet.</div>
        </div>
      </div>

      <div class="menu-section">
        <div class="menu-section-title">Quick Actions</div>
        <button class="menu-button" onclick="saveSession()">üíæ Save Session</button>
        <button class="menu-button" onclick="exportSession()">üì§ Export Session</button>
        <button class="menu-button" onclick="clearConversation()">üóëÔ∏è Clear Conversation</button>
        <button class="menu-button" onclick="toggleContextBar()">üëÅÔ∏è Toggle Context Bar</button>
      </div>

      <div class="menu-section">
        <div class="menu-section-title">Switch Context</div>
        <button class="menu-button" onclick="switchContext('general')">üéØ General</button>
        <button class="menu-button" onclick="switchContext('design')">üé® Design</button>
        <button class="menu-button" onclick="switchContext('development')">üíª Development</button>
        <button class="menu-button" onclick="switchContext('research')">üìö Research</button>
        <button class="menu-button" onclick="switchContext('planning')">üìã Planning</button>
      </div>
    </div>
  </div>

  <script>
    let sessionStartTime = Date.now();
    let messageCount = 0;
    let actionCount = 0;
    let decisionCount = 0;
    let actions = [];
    let assets = [];
    let conversationHistory = [];
    let conversationMemory = [];  // Track topics and contexts
    let sessionPanelOpen = true;
    let currentContext = 'general';
    let contextBarVisible = true;
    let conversationTopics = {};  // Track dominant topics

    // Context tips database
    const contextTips = {
      general: {
        tips: [
          { icon: 'üí°', text: 'Start by asking a <strong>design question</strong> or <strong>coding challenge</strong>' },
          { icon: 'üéØ', text: 'Use <strong>specific prompts</strong> for better results from all 5 providers' },
          { icon: 'üìä', text: 'All providers analyze in parallel for comprehensive insights' }
        ],
        tools: [
          { name: 'üîç Search', desc: 'Find similar past decisions' },
          { name: 'üìã Templates', desc: 'Use common prompt templates' },
          { name: '‚öôÔ∏è Settings', desc: 'Customize provider weights' }
        ]
      },
      design: {
        tips: [
          { icon: 'üé®', text: 'Use the <strong>Design panel</strong> to generate components' },
          { icon: '‚úÖ', text: 'Validate designs with <strong>accessibility checks</strong> (WCAG 2.1 AA)' },
          { icon: 'üì¶', text: 'Export as <strong>JSON, CSV, or Tailwind</strong> config' }
        ],
        tools: [
          { name: 'üß© Generate Component', desc: 'Create React with tests & a11y' },
          { name: 'üíª Design ‚Üí Code', desc: 'Description to production code' },
          { name: '‚úÖ Validate Design', desc: 'Check accessibility & consistency' },
          { name: 'üì§ Export System', desc: 'Save as tokens or config' }
        ]
      },
      development: {
        tips: [
          { icon: 'üî¨', text: 'Ask for <strong>code reviews</strong> and improvements' },
          { icon: 'üêõ', text: 'Describe <strong>bugs or errors</strong> for diagnosis' },
          { icon: '‚ö°', text: 'Request <strong>performance optimizations</strong>' }
        ],
        tools: [
          { name: 'üß† Self-Analyze', desc: 'TooLoo analyzes itself' },
          { name: 'üìä Codebase Audit', desc: 'Full system analysis' },
          { name: 'üîß Auto-Improve', desc: 'Generate improvements' },
          { name: 'üìú View History', desc: 'See past improvements' }
        ]
      },
      research: {
        tips: [
          { icon: 'üìö', text: 'Ask <strong>research questions</strong> for deep analysis' },
          { icon: 'üîó', text: 'Gemini excels at <strong>data aggregation</strong>' },
          { icon: 'üìä', text: 'Export findings as <strong>CSV or Markdown</strong>' }
        ],
        tools: [
          { name: 'üì§ Export CSV', desc: 'Download data for analysis' },
          { name: 'üìù Export Markdown', desc: 'Format for documentation' },
          { name: 'üîÑ Regenerate', desc: 'Ask providers again' },
          { name: 'üíæ Save Session', desc: 'Archive findings' }
        ]
      },
      planning: {
        tips: [
          { icon: 'üìã', text: 'Use <strong>decision log</strong> to track choices' },
          { icon: 'üéØ', text: 'DeepSeek is great for <strong>technical planning</strong>' },
          { icon: '‚ú®', text: 'Claude excels at <strong>structured breakdowns</strong>' }
        ],
        tools: [
          { name: 'üìã Actions', desc: 'Extracted tasks to execute' },
          { name: 'üíæ Decisions', desc: 'Log important choices' },
          { name: 'üì§ Export Plan', desc: 'Share with team' },
          { name: 'üîÑ Refine', desc: 'Ask for iterations' }
        ]
      }
    };

    // Detect context from conversation
    // ===== MENU MANAGEMENT =====
    function openSessionMenu() {
      const overlay = document.getElementById('menuOverlay');
      overlay.classList.add('open');
      updateMenuStats();
      updateConversationMemory();
    }

    function closeSessionMenu(e) {
      if (e && e.target.id !== 'menuOverlay') return;
      const overlay = document.getElementById('menuOverlay');
      overlay.classList.remove('open');
    }

    function updateMenuStats() {
      document.getElementById('menuMsgCount').textContent = messageCount;
      document.getElementById('menuActionCount').textContent = actionCount;
      document.getElementById('menuDecisionCount').textContent = decisionCount;
      
      const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000 / 60);
      document.getElementById('menuSessionTime').textContent = elapsed + 'm';
      document.getElementById('menuCurrentContext').textContent = currentContext.toUpperCase();
    }

    function updateConversationMemory() {
      const memory = document.getElementById('conversationMemory');
      if (conversationMemory.length === 0) {
        memory.innerHTML = '<div style="color: #94a3b8; font-size: 12px;">No conversation yet.</div>';
        return;
      }

      let html = '';
      conversationMemory.slice(-5).reverse().forEach((item, idx) => {
        html += `<div class="memory-item">
          <div class="memory-label">${item.context.toUpperCase()}</div>
          <div style="margin-top: 4px;">${item.snippet}</div>
        </div>`;
      });
      memory.innerHTML = html;
    }

    function switchContext(context) {
      updateContextBar(context);
      closeSessionMenu();
    }

    function toggleContextBar() {
      contextBarVisible = !contextBarVisible;
      const bar = document.getElementById('contextBar');
      bar.style.display = contextBarVisible ? 'flex' : 'none';
      closeSessionMenu();
    }

    function clearConversation() {
      if (confirm('Clear conversation? This cannot be undone.')) {
        conversationHistory = [];
        conversationMemory = [];
        document.getElementById('messages').innerHTML = `
          <div class="msg-assistant">
            üëã Conversation cleared. Ready for a fresh start!
          </div>
        `;
        messageCount = 0;
        actionCount = 0;
        decisionCount = 0;
        updateMenuStats();
        closeSessionMenu();
      }
    }

    // ===== CONTEXT DETECTION & ANALYSIS =====
    function detectContext(text) {
      const lower = text.toLowerCase();
      
      if (lower.includes('design') || lower.includes('ui') || lower.includes('component') || 
          lower.includes('button') || lower.includes('modal') || lower.includes('layout')) {
        return 'design';
      } else if (lower.includes('code') || lower.includes('function') || lower.includes('bug') || 
                 lower.includes('error') || lower.includes('optimize') || lower.includes('refactor')) {
        return 'development';
      } else if (lower.includes('research') || lower.includes('analyze') || lower.includes('data') || 
                 lower.includes('study') || lower.includes('investigate')) {
        return 'research';
      } else if (lower.includes('plan') || lower.includes('strategy') || lower.includes('workflow') || 
                 lower.includes('process') || lower.includes('goal')) {
        return 'planning';
      }
      return 'general';
    }

    // Update context bar based on current context
    function updateContextBar(context) {
      currentContext = context;
      const contextData = contextTips[context] || contextTips.general;
      const contextBar = document.getElementById('contextBar');

      let html = '';

      // Tips section
      html += `<div class="context-section">
        <div class="context-title">üí° Tips for ${context.toUpperCase()}</div>`;
      contextData.tips.forEach(tip => {
        html += `<div class="context-tip">${tip.icon} ${tip.text}</div>`;
      });
      html += '</div>';

      // Tools section
      html += `<div class="context-section">
        <div class="context-title">üîß Recommended Tools</div>
        <div class="context-tools">`;
      contextData.tools.forEach(tool => {
        html += `<div class="context-tool" onclick="executeContextTool('${tool.name}')">
          <div class="context-tool-name">${tool.name}</div>
          <div class="context-tool-desc">${tool.desc}</div>
        </div>`;
      });
      html += '</div></div>';

      // Provider insights
      html += `<div class="context-section">
        <div class="context-title">üß† Provider Strengths</div>`;
      
      const providerStrengths = {
        design: [
          { name: 'Claude', strength: 'Detailed component specs & accessibility' },
          { name: 'GPT-4', strength: 'Creative design patterns & interactions' },
          { name: 'Gemini', strength: 'Design trends & best practices' },
          { name: 'DeepSeek', strength: 'Technical CSS & responsive implementation' },
          { name: 'Local', strength: 'Privacy-first design systems' }
        ],
        development: [
          { name: 'Claude', strength: 'Code quality & reasoning' },
          { name: 'GPT-4', strength: 'Creative solutions & patterns' },
          { name: 'DeepSeek', strength: 'Deep technical analysis' },
          { name: 'Gemini', strength: 'Performance optimization' },
          { name: 'Local', strength: 'Offline development' }
        ],
        research: [
          { name: 'Gemini', strength: 'Data aggregation & synthesis' },
          { name: 'Claude', strength: 'Structured analysis' },
          { name: 'GPT-4', strength: 'Comprehensive coverage' },
          { name: 'DeepSeek', strength: 'Technical depth' },
          { name: 'Local', strength: 'Private research' }
        ],
        planning: [
          { name: 'Claude', strength: 'Strategic planning' },
          { name: 'DeepSeek', strength: 'Technical roadmaps' },
          { name: 'GPT-4', strength: 'Creative approaches' },
          { name: 'Gemini', strength: 'Market analysis' },
          { name: 'Local', strength: 'Custom frameworks' }
        ]
      };

      const strengths = providerStrengths[context] || providerStrengths.general || [];
      if (strengths.length === 0) {
        strengths.push(
          { name: 'Claude', strength: 'Best for analysis & reasoning' },
          { name: 'GPT-4', strength: 'Great for creativity & synthesis' },
          { name: 'Gemini', strength: 'Excellent for research & data' },
          { name: 'DeepSeek', strength: 'Strong at technical depth' },
          { name: 'Local', strength: 'Privacy-first alternative' }
        );
      }

      strengths.forEach(p => {
        html += `<div class="context-tool">
          <div class="context-tool-name">${p.name}</div>
          <div class="context-tool-desc">${p.strength}</div>
        </div>`;
      });

      html += '</div>';

      contextBar.innerHTML = html;
    }

    // Toggle session panel
    function toggleSessionPanel() {
      sessionPanelOpen = !sessionPanelOpen;
      const toggle = document.getElementById('sessionToggle');
      const stats = document.getElementById('sessionStats');

      if (sessionPanelOpen) {
        toggle.classList.remove('collapsed');
        stats.classList.remove('collapsed');
      } else {
        toggle.classList.add('collapsed');
        stats.classList.add('collapsed');
      }
    }

    function executeContextTool(toolName) {
      const toolMap = {
        'üîç Search': () => alert('Search feature coming soon'),
        'üìã Templates': () => alert('Templates feature coming soon'),
        '‚öôÔ∏è Settings': () => alert('Settings feature coming soon'),
        'üß© Generate Component': generateComponent,
        'üíª Design ‚Üí Code': designToCode,
        '‚úÖ Validate Design': validateDesign,
        'üì§ Export System': exportJSON,
        'üß† Self-Analyze': selfAnalyze,
        'üìä Codebase Audit': analyzeCodebase,
        'üîß Auto-Improve': generateImprovement,
        'üìú View History': viewImprovementHistory,
        'üì§ Export CSV': downloadCSV,
        'üìù Export Markdown': exportMarkdown,
        'üîÑ Regenerate': () => addMessageToUI('Regenerating responses...', 'assistant'),
        'üíæ Save Session': saveSession,
        'üìã Actions': () => document.querySelector('.right-bar').scrollTop = 0,
        'üíæ Decisions': () => alert('Decision log coming soon'),
        'üì§ Export Plan': exportJSON,
        'üîÑ Refine': () => alert('Refinement panel coming soon')
      };

      if (toolMap[toolName]) {
        toolMap[toolName]();
      }
    }

    // Update session time and mini stats
    setInterval(() => {
      const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
      const mins = Math.floor(elapsed / 60);
      const secs = elapsed % 60;
      const timeStr = mins > 0 ? `${mins}m` : `${secs}s`;
      
      document.getElementById('sessionTimeMini').textContent = timeStr;
      document.getElementById('msgCountMini').textContent = messageCount;
      document.getElementById('actionCountMini').textContent = actionCount;
      document.getElementById('decisionCountMini').textContent = decisionCount;
    }, 1000);

    async function sendMessage() {
      const input = document.getElementById('userInput');
      const userMsg = input.value.trim();
      if (!userMsg) return;

      // Detect context from user message
      const detectedContext = detectContext(userMsg);
      
      // Add user message to UI
      addMessageToUI(userMsg, 'user');
      input.value = '';
      messageCount++;
      document.getElementById('msgCountMini').textContent = messageCount;

      // Track conversation memory
      const userSnippet = userMsg.substring(0, 60) + (userMsg.length > 60 ? '...' : '');
      conversationMemory.push({
        context: detectedContext,
        snippet: userSnippet,
        role: 'user'
      });

      // Show loading state
      const loadingMsg = document.createElement('div');
      loadingMsg.className = 'msg-assistant';
      loadingMsg.innerHTML = 'üîÑ Synthesizing responses from all 5 providers...';
      document.getElementById('messages').appendChild(loadingMsg);
      document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;

      try {
        // Query all providers
        const responses = await queryAllProviders(userMsg);
        loadingMsg.remove();

        // Generate synthesized summary
        const summary = await generateSynthesis(userMsg, responses);
        addMessageToUI(summary, 'assistant');

        // ===== NEW: Analyze response for context shifts =====
        const responseContext = detectContext(summary);
        
        // If response context differs from user message context, update sidebar
        if (responseContext !== detectedContext) {
          updateContextBar(responseContext);
        } else {
          updateContextBar(detectedContext);
        }

        // Track response in memory
        const responseSnippet = summary.substring(0, 60) + (summary.length > 60 ? '...' : '');
        conversationMemory.push({
          context: responseContext,
          snippet: responseSnippet,
          role: 'assistant'
        });

        // Extract and display actions
        const extractedActions = await extractActions(userMsg, summary);
        if (extractedActions && extractedActions.length > 0) {
          actions = extractedActions;
          actionCount += extractedActions.length;
          document.getElementById('actionCountMini').textContent = actionCount;
          updateActionList();
        }

        conversationHistory.push({ role: 'user', content: userMsg });
        conversationHistory.push({ role: 'assistant', content: summary });
      } catch (error) {
        loadingMsg.remove();
        addMessageToUI(`‚ùå Error: ${error.message}`, 'assistant');
      }
    }

    async function queryAllProviders(query) {
      try {
        const response = await fetch('/api/v1/arena/query', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            query,
            providers: ['claude', 'gpt-4', 'gemini', 'deepseek', 'ollama']
          })
        });
        const data = await response.json();
        
        // Convert array responses to object keyed by provider
        if (data.responses && Array.isArray(data.responses)) {
          const result = {};
          data.responses.forEach(r => {
            result[r.provider] = r.text;
          });
          return result;
        }
        return data.responses || {};
      } catch (err) {
        console.error('Provider query failed:', err);
        return {};
      }
    }

    async function generateSynthesis(query, responses) {
      // Build response list for synthesis
      const responsesList = Object.entries(responses)
        .map(([provider, response]) => `**${provider}:** ${response}`)
        .join('\n\n');

      try {
        const response = await fetch('/api/v1/arena/tldr', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            query,
            responses: responsesList
          })
        });
        const data = await response.json();
        // Arena returns "tldr" field, not "summary"
        const synthesis = data.tldr || data.summary || responsesList;
        return synthesis;
      } catch (err) {
        // Fallback: just show responses if synthesis fails
        return `üìä **Multi-Provider Responses:**\n\n${responsesList}`;
      }
    }

    async function extractActions(query, summary) {
      try {
        if (!summary || summary.length < 20) {
          return [];
        }
        
        // Send as a simple query to arena to extract action items
        const response = await fetch('/api/v1/arena/query', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            query: `Extract specific action items from this text:\n\n${summary}`,
            providers: ['claude']
          })
        });
        
        if (!response.ok) return [];
        
        const data = await response.json();
        if (!data.results || data.results.length === 0) return [];
        
        // Parse action items from the response
        const actionText = data.results[0].text || '';
        const lines = actionText.split('\n').filter(l => l.match(/^[-‚Ä¢*]\s+/));
        
        return lines.map((line, i) => ({
          id: i,
          title: line.replace(/^[-‚Ä¢*]\s+/, '').trim(),
          type: 'custom',
          done: false
        })).filter(a => a.title.length > 0);
      } catch (err) {
        console.error('Action extraction error:', err);
        return [];
      }
    }

    function addMessageToUI(text, role) {
      const msgDiv = document.createElement('div');
      msgDiv.className = `message msg-${role}`;
      
      // Simple markdown-like formatting for bold and line breaks
      let formatted = text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/__(.*?)__/g, '<em>$1</em>')
        .replace(/\n/g, '<br />');
      
      msgDiv.innerHTML = formatted;
      msgDiv.style.whiteSpace = 'pre-wrap';
      msgDiv.style.wordWrap = 'break-word';
      document.getElementById('messages').appendChild(msgDiv);
      document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
    }

    function updateActionList() {
      const actionList = document.getElementById('actionList');
      if (actions.length === 0) {
        actionList.innerHTML = '<div style="color: #64748b; font-size: 12px;">No actions yet.</div>';
        return;
      }

      actionList.innerHTML = actions.map(action => `
        <div class="action-item">
          <div>
            <input type="checkbox" id="action-${action.id}" checked style="margin-right: 8px;" />
            <label for="action-${action.id}" style="cursor: pointer;">${action.title}</label>
          </div>
          <button class="run-btn" onclick="executeAction(${action.id})">‚ñ∂</button>
        </div>
      `).join('');
    }

    async function executeAction(id) {
      const action = actions.find(a => a.id === id);
      if (!action) return;

      action.executing = true;
      updateActionList();

      try {
        const response = await fetch('/api/v1/workflows/execute-task', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            task: action.title,
            description: `Execute action: ${action.title}`,
            taskType: 'action-item'
          })
        });

        const data = await response.json();
        if (data.ok && data.artifacts) {
          action.done = true;
          action.artifacts = data.artifacts;
          assets = [...assets, ...data.artifacts];
          updateActionList();
          updateAssetList();
          addMessageToUI(`‚úÖ Action executed: ${action.title}. Generated ${data.artifacts.length} artifact(s).`, 'assistant');
        }
      } catch (err) {
        addMessageToUI(`‚ùå Execution failed: ${err.message}`, 'assistant');
      }
    }

    function executeSelected() {
      const selected = actions.filter((_, i) => {
        const cb = document.getElementById(`action-${i}`);
        return cb && cb.checked;
      });
      selected.forEach(a => executeAction(a.id));
    }

    function executeAll() {
      actions.forEach(a => executeAction(a.id));
    }

    function updateAssetList() {
      const assetDiv = document.getElementById('assetList');
      if (assets.length === 0) {
        assetDiv.innerHTML = '<div style="font-size: 12px; color: #64748b;">No assets yet.</div>';
        return;
      }

      assetDiv.innerHTML = assets.map(asset => `
        <div class="asset-item">
          <span>${asset.name || asset}</span>
          <a href="${asset.url || asset}" target="_blank" class="asset-link" download>üì•</a>
        </div>
      `).join('');
    }

    function exportMarkdown() {
      const md = conversationHistory.map(msg => 
        `${msg.role === 'user' ? 'üë§ User' : 'ü§ñ Assistant'}:\n${msg.content}`
      ).join('\n\n---\n\n');
      downloadFile(md, 'conversation.md', 'text/markdown');
    }

    function exportJSON() {
      const json = JSON.stringify({ 
        timestamp: new Date().toISOString(),
        sessionDuration: Date.now() - sessionStartTime,
        messages: messageCount,
        actions: actionCount,
        assets: assets,
        conversation: conversationHistory
      }, null, 2);
      downloadFile(json, 'session.json', 'application/json');
    }

    function downloadCSV() {
      const csv = 'Type,Content\n' + conversationHistory.map(msg => 
        `"${msg.role}","${msg.content.replace(/"/g, '""')}"`
      ).join('\n');
      downloadFile(csv, 'conversation.csv', 'text/csv');
    }

    function downloadFile(content, filename, type) {
      const blob = new Blob([content], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function saveSession() {
      addMessageToUI('üíæ Session saved to local storage.', 'assistant');
      localStorage.setItem('tooloo-session', JSON.stringify({
        history: conversationHistory,
        actions: actions,
        assets: assets
      }));
    }

    function exportSession() {
      exportJSON();
    }

    // ===== SELF-IMPROVEMENT FUNCTIONS =====
    async function analyzeCodebase() {
      addMessageToUI('üî¨ Analyzing TooLoo codebase for improvements...', 'assistant');

      try {
        const response = await fetch('/api/v1/self-improve/self-analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ depth: 'deep' })
        });

        const data = await response.json();
        if (data.ok && data.analysis) {
          const analysis = data.analysis;
          let report = `üìä Codebase Analysis Report\n\n`;
          report += `Services: ${analysis.services.count} running\n`;
          report += `Performance: ${JSON.stringify(analysis.performance, null, 2)}\n`;
          report += `\nSuggestions:\n`;
          analysis.suggestions.forEach((s, i) => {
            report += `${i + 1}. [${s.priority}] ${s.suggestion}\n`;
          });

          addMessageToUI(report, 'assistant');
          decisionCount++;
          document.getElementById('decisionCount').textContent = decisionCount;
        }
      } catch (err) {
        addMessageToUI(`‚ùå Analysis failed: ${err.message}`, 'assistant');
      }
    }

    async function selfAnalyze() {
      addMessageToUI('üß† TooLoo is analyzing itself...', 'assistant');

      try {
        const response = await fetch('/api/v1/self-improve/self-analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ depth: 'shallow' })
        });

        const data = await response.json();
        if (data.ok) {
          const report = `
ü§ñ Self-Analysis Complete

Services Running: ${data.analysis.services.count}
Status: ${data.analysis.services.status}

Performance Metrics:
- Avg Response Time: ${data.analysis.performance.avgResponseTime}
- Uptime: ${data.analysis.performance.uptime}
- Error Rate: ${data.analysis.performance.errorRate}

${data.analysis.suggestions.length > 0 ? 'üí° Improvement Opportunities Found: ' + data.analysis.suggestions.length : '‚úÖ All systems optimal'}
          `;

          addMessageToUI(report, 'assistant');
        }
      } catch (err) {
        addMessageToUI(`‚ùå Self-analysis failed: ${err.message}`, 'assistant');
      }
    }

    async function viewImprovementHistory() {
      addMessageToUI('üìú Fetching self-improvement history...', 'assistant');

      try {
        const response = await fetch('/api/v1/self-improve/history');
        const data = await response.json();

        if (data.ok && data.history && data.history.length > 0) {
          let history = `üìú Last ${Math.min(data.count, 10)} Improvements\n\n`;
          data.history.slice(0, 10).forEach((change, i) => {
            history += `${i + 1}. ${change.file}\n`;
            history += `   Reason: ${change.reason}\n`;
            history += `   Lines: +${change.changes.linesAdded}/-${change.changes.linesRemoved}\n`;
            history += `   Date: ${new Date(change.timestamp).toLocaleString()}\n\n`;
          });

          addMessageToUI(history, 'assistant');
        } else {
          addMessageToUI('üì≠ No improvement history yet. TooLoo will start self-improving as you interact!', 'assistant');
        }
      } catch (err) {
        addMessageToUI(`‚ùå Could not fetch history: ${err.message}`, 'assistant');
      }
    }

    // ===== DESIGN & PRODUCTION FUNCTIONS =====
    async function generateDesignSystem() {
      addMessageToUI('üé® Creating design system from your brand...', 'assistant');

      try {
        const response = await fetch('/api/v1/design/generate-system', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            brandName: 'TooLoo App',
            brandColors: '#3b82f6',
            typography: { heading: 'Inter', body: 'Inter' }
          })
        });

        const data = await response.json();
        if (data.ok) {
          const system = data.system;
          const report = `
‚úÖ Design System Created

Brand: ${system.brand}
Colors: ${system.elementsCount} components
Elements: ${system.colorCount} colors

What's included:
- Color palette (primary, secondary, success, warning, error)
- Typography (heading, body, monospace)
- Spacing scale (xs to 2xl)
- Default components (button, card, input, modal, dropdown)
- Accessibility guidelines

Next: Generate components or export as Tailwind/SCSS
          `;
          addMessageToUI(report, 'assistant');
        }
      } catch (err) {
        addMessageToUI(`‚ùå Failed to create design system: ${err.message}`, 'assistant');
      }
    }

    async function generateComponent() {
      const prompt = 'Describe a component to generate (e.g., "large blue button with hover effect")';
      const description = prompt('Component description:', 'primary action button');
      if (!description) return;

      addMessageToUI(`üß© Generating ${description} component...`, 'assistant');

      try {
        const response = await fetch('/api/v1/design/generate-component', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: description.split(' ')[0].toLowerCase(),
            description: description,
            variant: 'react',
            withTest: true
          })
        });

        const data = await response.json();
        if (data.ok && data.component) {
          const comp = data.component;
          const report = `
‚úÖ Component Generated: ${comp.name}

Framework: React
Tokens Used: ${comp.designTokens.join(', ')}

Accessibility Checklist:
${comp.accessibility.join('\n')}

Generated:
- React component with variants and states
- Jest unit tests with full coverage
- Accessibility attributes (ARIA, role)
- Design system token integration
          `;
          addMessageToUI(report, 'assistant');

          // Save as downloadable
          const artifact = await fetch('/api/v1/workflows/execute-task', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              task: `Create ${comp.name} component`,
              description: comp.code,
              taskType: 'code'
            })
          }).then(r => r.json());

          if (artifact.ok && artifact.artifacts) {
            assets.push(...artifact.artifacts);
            updateAssetList();
          }
        }
      } catch (err) {
        addMessageToUI(`‚ùå Component generation failed: ${err.message}`, 'assistant');
      }
    }

    async function designToCode() {
      const design = prompt('Describe your design:', 'Mobile app landing page with hero section and CTA button');
      if (!design) return;

      addMessageToUI(`üíª Converting design to code: "${design}"...`, 'assistant');

      try {
        const response = await fetch('/api/v1/design/convert-to-code', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            designDescription: design,
            targetFramework: 'react',
            responsive: true,
            includeStyles: true
          })
        });

        const data = await response.json();
        if (data.ok && data.code) {
          const code_data = data.code;
          const report = `
‚úÖ Design-to-Code Complete

Framework: ${code_data.framework}
Responsive: ${code_data.responsive}
Design Tokens: ${code_data.designTokensUsed.join(', ')}

Generated:
- Full React component
- CSS with media queries
- CSS variables for design tokens
- Ready to use!
          `;
          addMessageToUI(report, 'assistant');

          // Save component
          const artifact = await fetch('/api/v1/workflows/execute-task', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              task: 'Convert design to React code',
              description: code_data.component,
              taskType: 'code'
            })
          }).then(r => r.json());

          if (artifact.ok && artifact.artifacts) {
            assets.push(...artifact.artifacts);
            updateAssetList();
            actionCount++;
            document.getElementById('actionCount').textContent = actionCount;
          }
        }
      } catch (err) {
        addMessageToUI(`‚ùå Design-to-code failed: ${err.message}`, 'assistant');
      }
    }

    async function validateDesign() {
      addMessageToUI('‚úÖ Validating design system compliance...', 'assistant');

      try {
        const response = await fetch('/api/v1/design/validate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            design: 'Generated component',
            checks: ['accessibility', 'consistency', 'responsive']
          })
        });

        const data = await response.json();
        if (data.ok && data.validation) {
          const validation = data.validation;
          const report = `
üé® Design Validation Report

Score: ${validation.score}/100
Issues Found: ${validation.issues.length}

${validation.issues.length === 0 ? '‚úÖ All checks passed!' : '‚ö†Ô∏è Issues:\n' + validation.issues.map((i, idx) => `${idx + 1}. ${i}`).join('\n')}

Checks Performed:
- ‚úì Accessibility (WCAG 2.1 AA)
- ‚úì Design System Consistency
- ‚úì Responsive Design
          `;
          addMessageToUI(report, 'assistant');
        }
      } catch (err) {
        addMessageToUI(`‚ùå Validation failed: ${err.message}`, 'assistant');
      }
    }

    async function generateImprovement() {
      addMessageToUI('üîß Generating code improvements...', 'assistant');

      try {
        const response = await fetch('/api/v1/self-improve/generate-fix', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ codeContext: 'Latest workspace.html' })
        });

        const data = await response.json();
        if (data.ok) {
          addMessageToUI(`‚úÖ Generated improvements. Ready to apply ${data.count} changes.`, 'assistant');
          decisionCount++;
          document.getElementById('decisionCountMini').textContent = decisionCount;
        }
      } catch (err) {
        addMessageToUI(`‚ùå Improvement generation failed: ${err.message}`, 'assistant');
      }
    }

    // Load session on startup
    window.onload = () => {
      const saved = localStorage.getItem('tooloo-session');
      if (saved) {
        try {
          const session = JSON.parse(saved);
          conversationHistory = session.history || [];
          actions = session.actions || [];
          assets = session.assets || [];
          messageCount = conversationHistory.length / 2;
          actionCount = actions.length;
          document.getElementById('msgCountMini').textContent = messageCount;
          document.getElementById('actionCountMini').textContent = actionCount;
          updateActionList();
          updateAssetList();
        } catch (e) {
          console.log('No saved session');
        }
      }

      // Initialize context bar with general tips
      updateContextBar('general');
      
      // Close menu on Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeSessionMenu();
        }
      });

      // Open menu with Ctrl+Shift+M or Cmd+Shift+M
      document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.code === 'KeyM') {
          e.preventDefault();
          openSessionMenu();
        }
      });
      
      document.getElementById('userInput').focus();
    };
  </script>
</body>
</html>
