<!doctype html>
<!-- @version 2.1.48 -->
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TooLoo.ai Control Room</title>
    <link rel="stylesheet" href="css/gemini-ui.css" />
  </head>
  <body>
    <div class="g3-layout">
      <div class="g3-sidebar">
        <div class="sidebar-header">Control Room</div>
        <div class="nav-item active" onclick="switchTab('dashboard')">
          üìä Dashboard
        </div>
        <div class="nav-item" onclick="switchTab('providers')">
          üîå Providers
        </div>
        <div class="nav-item" onclick="switchTab('github')">üêô GitHub</div>
        <div class="nav-item" onclick="switchTab('system')">üß† System</div>
        <div class="nav-item" onclick="switchTab('features')">‚ú® Features</div>
        <div class="nav-item" onclick="switchTab('settings')">‚öôÔ∏è Settings</div>

        <div
          style="
            margin-top: auto;
            padding-top: 1rem;
            border-top: 1px solid var(--g3-border-color);
          "
        >
          <div style="font-size: 0.75rem; color: var(--g3-text-tertiary)">
            System Time
          </div>
          <div
            id="timeDisplay"
            style="
              font-family: var(--g3-font-mono);
              color: var(--g3-text-primary);
            "
          >
            --:--:--
          </div>
        </div>
      </div>

      <div class="g3-main">
        <!-- DASHBOARD TAB -->
        <div class="tab-content active" id="dashboard-tab">
          <h2 style="margin-bottom: 20px; color: var(--brand)">
            System Overview
          </h2>

          <div class="grid-4" id="dashboardMetrics">
            <div class="card">
              <div class="card-header">
                <span class="card-title">Services Running</span>
              </div>
              <div class="card-value" id="servicesCount">-</div>
              <div class="card-meta">
                Last updated: <span id="servicesTime">--:--</span>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <span class="card-title">System Health</span>
              </div>
              <div class="card-value" id="healthPercent">-</div>
              <div class="card-meta">All services</div>
            </div>

            <div class="card">
              <div class="card-header">
                <span class="card-title">Uptime</span>
              </div>
              <div class="card-value" id="uptime">-</div>
              <div class="card-meta">Primary service</div>
            </div>

            <div class="card">
              <div class="card-header">
                <span class="card-title">Active Provider</span>
              </div>
              <div
                class="card-value"
                style="font-size: 18px"
                id="activeProvider"
              >
                -
              </div>
              <div class="card-meta" id="activeModel">Unknown</div>
            </div>
          </div>

          <div class="section-title">Services Status</div>
          <div id="servicesList" style="margin-bottom: 24px"></div>

          <div class="grid-2">
            <div class="card">
              <div class="card-header">
                <span class="card-title">Quick Actions</span>
              </div>
              <div style="display: flex; flex-direction: column; gap: 8px">
                <button
                  class="btn btn-primary"
                  onclick="window.location.href='/chat-pro-v2'"
                >
                  üí¨ Chat Pro
                </button>
                <button class="btn btn-success" onclick="startAllServices()">
                  ‚ñ∂Ô∏è Start All
                </button>
                <button class="btn btn-danger" onclick="stopAllServices()">
                  ‚èπÔ∏è Stop All
                </button>
                <button class="btn" onclick="toggleSandbox()" id="sandboxBtn">
                  üß™ Enable Sandbox
                </button>
                <button class="btn" onclick="refreshStatus()">
                  üîÑ Refresh Status
                </button>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <span class="card-title">System Info</span>
              </div>
              <div class="metric-row">
                <span class="metric-label">Node Version</span>
                <span class="metric-value" id="nodeVersion">-</span>
              </div>
              <div class="metric-row">
                <span class="metric-label">Memory Usage</span>
                <span class="metric-value" id="memoryUsage">-</span>
              </div>
              <div class="metric-row">
                <span class="metric-label">Environment</span>
                <span class="metric-value" id="envType">-</span>
              </div>
            </div>
          </div>
        </div>

        <!-- PROVIDERS TAB -->
        <div class="tab-content" id="providers-tab">
          <h2 style="margin-bottom: 20px; color: var(--brand)">
            Provider Management
          </h2>

          <div class="grid-2">
            <div class="card">
              <div class="card-header">
                <span class="card-title">Active Provider</span>
              </div>
              <div id="activeProviderInfo" style="padding: 12px 0">
                <div class="metric-row">
                  <span class="metric-label">Provider</span>
                  <span class="metric-value" id="providerName">-</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">Model</span>
                  <span class="metric-value" id="providerModel">-</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">Status</span>
                  <span class="metric-value" id="providerStatus">-</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">Latency</span>
                  <span class="metric-value" id="providerLatency">-ms</span>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <span class="card-title">Provider Priority</span>
              </div>
              <div id="providerPriority" style="padding: 12px 0">
                <!-- Loaded dynamically -->
              </div>
            </div>
          </div>

          <div class="section-title">Available Providers</div>
          <div id="providersList" style="margin-bottom: 24px"></div>

          <div class="card">
            <div class="card-header">
              <span class="card-title">Provider Configuration</span>
            </div>
            <div style="padding: 12px 0">
              <div style="margin-bottom: 12px">
                <label style="font-size: 12px; font-weight: 600"
                  >Budget Policy</label
                >
                <select
                  class="input-field"
                  id="budgetPolicy"
                  onchange="updateBudgetPolicy()"
                >
                  <option value="normal">Normal - 4 concurrent</option>
                  <option value="conservative">
                    Conservative - 2 concurrent
                  </option>
                  <option value="aggressive">Aggressive - 8 concurrent</option>
                </select>
              </div>
              <div>
                <label style="font-size: 12px; font-weight: 600"
                  >Criticality Level</label
                >
                <select
                  class="input-field"
                  id="criticality"
                  onchange="updateCriticality()"
                >
                  <option value="normal">Normal</option>
                  <option value="high">High</option>
                  <option value="critical">Critical</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- GITHUB TAB -->
        <div class="tab-content" id="github-tab">
          <h2 style="margin-bottom: 20px; color: var(--brand)">
            GitHub Integration
          </h2>

          <div class="grid-2">
            <div class="card">
              <div class="card-header">
                <span class="card-title">Repository Info</span>
              </div>
              <div id="repoInfo" style="padding: 12px 0">
                <div class="metric-row">
                  <span class="metric-label">Name</span>
                  <span class="metric-value" id="repoName">-</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">Branch</span>
                  <span class="metric-value" id="repoBranch">-</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">Status</span>
                  <span class="metric-value" id="repoStatus">-</span>
                </div>
              </div>
              <div style="margin-top: 12px">
                <button class="btn" onclick="refreshGitHub()">
                  üîÑ Refresh
                </button>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <span class="card-title">Quick Actions</span>
              </div>
              <div style="display: flex; flex-direction: column; gap: 8px">
                <button
                  class="btn btn-primary"
                  onclick="showCreateIssueModal()"
                >
                  ‚ûï New Issue
                </button>
                <button class="btn" onclick="showCreatePRModal()">
                  üîÄ New Pull Request
                </button>
              </div>
            </div>
          </div>

          <div class="section-title">Recent Issues</div>
          <div id="issuesList" style="margin-bottom: 24px"></div>
        </div>

        <!-- SYSTEM TAB -->
        <div class="tab-content" id="system-tab">
          <h2 style="margin-bottom: 20px; color: var(--brand)">
            System Internals
          </h2>

          <div class="grid-2">
            <div class="card">
              <div class="card-header">
                <span class="card-title">Self-Awareness</span>
              </div>
              <pre
                id="awarenessData"
                style="
                  font-size: 11px;
                  background: rgba(0, 0, 0, 0.2);
                  padding: 10px;
                  border-radius: 6px;
                  overflow: auto;
                  max-height: 200px;
                "
              >
Loading...</pre
              >
            </div>

            <div class="card">
              <div class="card-header">
                <span class="card-title">Introspection</span>
              </div>
              <pre
                id="introspectionData"
                style="
                  font-size: 11px;
                  background: rgba(0, 0, 0, 0.2);
                  padding: 10px;
                  border-radius: 6px;
                  overflow: auto;
                  max-height: 200px;
                "
              >
Loading...</pre
              >
            </div>
          </div>

          <div class="section-title">Self-Modification (Danger Zone)</div>
          <div class="card">
            <div class="card-header">
              <span class="card-title">Apply Self-Patch</span>
            </div>
            <div style="display: flex; flex-direction: column; gap: 12px">
              <div>
                <label style="font-size: 12px; font-weight: 600">Action</label>
                <select class="input-field" id="patchAction">
                  <option value="analyze">Analyze File</option>
                  <option value="create">Create File</option>
                  <option value="update">Update File</option>
                </select>
              </div>
              <div>
                <label style="font-size: 12px; font-weight: 600"
                  >File Path</label
                >
                <input
                  type="text"
                  class="input-field"
                  id="patchFile"
                  placeholder="src/..."
                />
              </div>
              <div>
                <label style="font-size: 12px; font-weight: 600"
                  >Content (for Create/Update)</label
                >
                <textarea
                  class="input-field"
                  id="patchContent"
                  rows="5"
                  style="font-family: monospace"
                ></textarea>
              </div>
              <div>
                <label style="font-size: 12px; font-weight: 600"
                  >Commit Message</label
                >
                <input
                  type="text"
                  class="input-field"
                  id="patchMessage"
                  placeholder="feat: update system..."
                />
              </div>
              <button class="btn btn-danger" onclick="applySelfPatch()">
                üöÄ Apply Patch
              </button>
              <div
                id="patchResult"
                style="margin-top: 10px; font-size: 12px"
              ></div>
            </div>
          </div>
        </div>

        <!-- FEATURES TAB -->
        <div class="tab-content" id="features-tab">
          <h2 style="margin-bottom: 20px; color: var(--brand)">
            Features & Capabilities
          </h2>

          <div id="featuresList">
            <!-- Loaded dynamically -->
          </div>
        </div>

        <!-- SETTINGS TAB -->
        <div class="tab-content" id="settings-tab">
          <h2 style="margin-bottom: 20px; color: var(--brand)">
            System Settings
          </h2>

          <div class="section-title">Environment</div>
          <div id="settingsList">
            <!-- Loaded dynamically -->
          </div>

          <div class="section-title">Advanced Options</div>
          <div class="card">
            <div style="display: flex; flex-direction: column; gap: 12px">
              <button class="btn btn-primary" onclick="resetSystem()">
                üîÑ Reset System
              </button>
              <button class="btn" onclick="exportLogs()">üì• Export Logs</button>
              <button class="btn" onclick="clearCache()">üóëÔ∏è Clear Cache</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = window.location.origin;
      let currentTab = "dashboard";

      // ========== TAB SWITCHING ==========
      function switchTab(tabName) {
        // Hide all tabs
        document
          .querySelectorAll(".tab-content")
          .forEach((el) => el.classList.remove("active"));
        document
          .querySelectorAll(".nav-item")
          .forEach((el) => el.classList.remove("active"));

        // Show selected tab
        document.getElementById(`${tabName}-tab`).classList.add("active");
        event.target.classList.add("active");
        currentTab = tabName;

        // Load tab data
        if (tabName === "dashboard") loadDashboard();
        else if (tabName === "providers") loadProviders();
        else if (tabName === "github") loadGitHub();
        else if (tabName === "system") loadSystem();
        else if (tabName === "features") loadFeatures();
        else if (tabName === "settings") loadSettings();
      }

      // ========== GITHUB ==========
      async function loadGitHub() {
        try {
          // Health/Status
          const healthRes = await fetch(`${API_BASE}/api/v1/github/health`);
          const healthData = await healthRes.json();

          // Info
          const infoRes = await fetch(`${API_BASE}/api/v1/github/info`);
          const infoData = await infoRes.json();

          // Issues
          const issuesRes = await fetch(
            `${API_BASE}/api/v1/github/issues?limit=5`
          );
          const issuesData = await issuesRes.json();

          // Update UI
          document.getElementById("repoStatus").textContent =
            healthData.status === "connected" ? "Connected" : "Disconnected";
          document.getElementById("repoStatus").style.color =
            healthData.status === "connected"
              ? "var(--success)"
              : "var(--danger)";

          if (infoData.ok && infoData.info) {
            document.getElementById("repoName").textContent =
              infoData.info.name;
            document.getElementById("repoBranch").textContent =
              infoData.info.defaultBranchRef?.name || "main";
          }

          if (issuesData.ok && issuesData.issues) {
            document.getElementById("issuesList").innerHTML = issuesData.issues
              .map(
                (i) => `
            <div class="service-item">
              <div class="service-info">
                <div class="service-name">#${i.number} ${i.title}</div>
                <div class="service-port" style="font-size: 10px;">${new Date(i.createdAt).toLocaleDateString()}</div>
              </div>
              <div class="service-actions">
                <a href="${i.url}" target="_blank" class="btn" style="text-decoration: none;">View</a>
              </div>
            </div>
          `
              )
              .join("");
          }
        } catch (err) {
          console.error("GitHub load error:", err);
          document.getElementById("repoStatus").textContent = "Error";
        }
      }

      function refreshGitHub() {
        loadGitHub();
      }

      function showCreateIssueModal() {
        const title = prompt("Issue Title:");
        if (!title) return;
        const body = prompt("Issue Description:");
        if (!body) return;

        fetch(`${API_BASE}/api/v1/github/create-issue`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title, body }),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.ok) {
              alert("Issue created: " + data.url);
              loadGitHub();
            } else {
              alert("Error: " + data.error);
            }
          });
      }

      function showCreatePRModal() {
        alert(
          "PR creation requires more inputs. Use the API directly for now."
        );
      }

      // ========== SYSTEM ==========
      async function loadSystem() {
        try {
          const awareRes = await fetch(`${API_BASE}/api/v1/system/awareness`);
          const awareData = await awareRes.json();
          document.getElementById("awarenessData").textContent = JSON.stringify(
            awareData,
            null,
            2
          );

          const introRes = await fetch(`${API_BASE}/api/v1/system/introspect`);
          const introData = await introRes.json();
          document.getElementById("introspectionData").textContent =
            JSON.stringify(introData, null, 2);
        } catch (err) {
          console.error("System load error:", err);
        }
      }

      async function applySelfPatch() {
        const action = document.getElementById("patchAction").value;
        const file = document.getElementById("patchFile").value;
        const content = document.getElementById("patchContent").value;
        const message = document.getElementById("patchMessage").value;
        const resultDiv = document.getElementById("patchResult");

        resultDiv.textContent = "Processing...";
        resultDiv.style.color = "var(--text-muted)";

        try {
          const res = await fetch(`${API_BASE}/api/v1/system/self-patch`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action, file, content, message }),
          });
          const data = await res.json();

          if (data.ok) {
            resultDiv.textContent = "Success: " + JSON.stringify(data);
            resultDiv.style.color = "var(--success)";
          } else {
            resultDiv.textContent = "Error: " + data.error;
            resultDiv.style.color = "var(--danger)";
          }
        } catch (err) {
          resultDiv.textContent = "Request Failed: " + err.message;
          resultDiv.style.color = "var(--danger)";
        }
      }

      // ========== DASHBOARD ==========
      async function loadDashboard() {
        try {
          // Get system processes
          const sysRes = await fetch(`${API_BASE}/api/v1/system/processes`);
          const sysData = await sysRes.json();

          // Get provider status
          const provRes = await fetch(`${API_BASE}/api/v1/providers/status`);
          const provData = await provRes.json();

          // Update metrics
          const processes = sysData.processes || [];
          const runningCount = processes.filter(
            (p) => p.status === "running"
          ).length;

          document.getElementById("servicesCount").textContent = runningCount;
          document.getElementById("healthPercent").textContent = "100%";
          document.getElementById("uptime").textContent = "--h --m";
          document.getElementById("activeProvider").textContent =
            provData.content?.active || provData.active || "Gemini";
          document.getElementById("activeModel").textContent =
            provData.content?.model || provData.model || "Gemini 3 Pro";

          // Render services list
          const servicesList = document.getElementById("servicesList");
          servicesList.innerHTML = processes
            .map(
              (p) => `
          <div class="service-item ${p.status === "running" ? "" : "offline"}">
            <div class="service-info">
              <div class="service-name">${p.name}</div>
              <div class="service-port">Port ${p.port}</div>
            </div>
            <div class="service-actions">
              ${p.status === "running" ? `<span style="font-size: 11px; color: var(--success);">‚óè Running</span>` : `<span style="font-size: 11px; color: var(--danger);">‚óè Offline</span>`}
            </div>
          </div>
        `
            )
            .join("");

          // Update time
          document.getElementById("timeDisplay").textContent =
            new Date().toLocaleTimeString();
        } catch (err) {
          console.error("Dashboard load error:", err);
          document.getElementById("servicesCount").textContent = "0";
          document.getElementById("servicesList").innerHTML =
            '<div class="error">Failed to load services</div>';
        }
      }

      // ========== PROVIDERS ==========
      async function loadProviders() {
        try {
          const res = await fetch(`${API_BASE}/api/v1/providers/status`);
          const data = await res.json();
          const provData = data.content || data;

          // Active provider info
          document.getElementById("providerName").textContent =
            provData.active || "Gemini";
          document.getElementById("providerModel").textContent =
            provData.model || "gemini-2.0-pro-exp-02-05";
          document.getElementById("providerStatus").textContent = "Active";
          document.getElementById("providerLatency").textContent =
            (provData.latency || 150) + "ms";

          // Provider priority
          const priority = provData.priority || [
            "Gemini",
            "Ollama",
            "Anthropic",
            "OpenAI",
          ];
          document.getElementById("providerPriority").innerHTML = priority
            .map(
              (p, i) =>
                `<div class="metric-row"><span>${i + 1}. ${p}</span></div>`
            )
            .join("");

          // Available providers list
          const providers = provData.available || [];
          document.getElementById("providersList").innerHTML = providers
            .map(
              (p) => `
          <div class="service-item">
            <div class="service-info">
              <div class="service-name">${p.name}</div>
              <div class="service-port">${p.status || "Ready"}</div>
            </div>
            <div class="service-actions">
              <button class="btn" onclick="selectProvider('${p.id}')">Use</button>
            </div>
          </div>
        `
            )
            .join("");
        } catch (err) {
          console.error("Providers load error:", err);
          document.getElementById("providersList").innerHTML =
            '<div class="error">Failed to load providers</div>';
        }
      }

      // ========== FEATURES ==========
      async function loadFeatures() {
        try {
          const res = await fetch(
            `${API_BASE}/api/v1/system/real-capabilities`
          );
          const data = await res.json();
          const capData = data.content || data;

          const features = capData.capabilities || [];
          document.getElementById("featuresList").innerHTML = features
            .map(
              (f) => `
          <div class="feature-item">
            <div>
              <div style="font-weight: 600; margin-bottom: 4px;">${f.name}</div>
              <div style="font-size: 11px; color: var(--text-muted);">${f.description}</div>
            </div>
            <div class="feature-status ${f.status !== "active" ? "partial" : ""}">
              ${f.status === "active" ? "‚úì Active" : "‚ö† " + (f.status || "Available")}
            </div>
          </div>
        `
            )
            .join("");
        } catch (err) {
          console.error("Features load error:", err);
          document.getElementById("featuresList").innerHTML =
            '<div class="error">Failed to load features</div>';
        }
      }

      // ========== SETTINGS ==========
      async function loadSettings() {
        try {
          const res = await fetch(`${API_BASE}/api/v1/system/config`);
          const data = await res.json();
          const cfgData = data.content || data;

          const settings = cfgData.settings || [];
          document.getElementById("settingsList").innerHTML = settings
            .map(
              (s) => `
          <div class="setting-row">
            <div class="setting-label">${s.name}</div>
            <div class="setting-value">${s.value || "Not set"}</div>
          </div>
        `
            )
            .join("");
        } catch (err) {
          console.error("Settings load error:", err);
          document.getElementById("settingsList").innerHTML =
            '<div class="error">Failed to load settings</div>';
        }
      }

      // ========== ACTIONS ==========
      async function startAllServices() {
        try {
          await fetch(`${API_BASE}/system/start`, { method: "POST" });
          loadDashboard();
        } catch (err) {
          console.error("Start failed:", err);
        }
      }

      async function stopAllServices() {
        if (confirm("Stop all services?")) {
          try {
            await fetch(`${API_BASE}/system/stop`, { method: "POST" });
            loadDashboard();
          } catch (err) {
            console.error("Stop failed:", err);
          }
        }
      }

      function refreshStatus() {
        loadDashboard();
      }

      function selectProvider(providerId) {
        console.log("Selecting provider:", providerId);
        loadProviders();
      }

      function updateBudgetPolicy() {
        const policy = document.getElementById("budgetPolicy").value;
        console.log("Budget policy:", policy);
      }

      function updateCriticality() {
        const level = document.getElementById("criticality").value;
        console.log("Criticality:", level);
      }

      function resetSystem() {
        if (confirm("Reset system? This will clear all data.")) {
          console.log("Resetting system...");
        }
      }

      function exportLogs() {
        console.log("Exporting logs...");
      }

      function clearCache() {
        localStorage.clear();
        console.log("Cache cleared");
      }

      // ========== INITIALIZATION ==========
      document.addEventListener("DOMContentLoaded", () => {
        loadDashboard();

        // Update time every second
        setInterval(() => {
          document.getElementById("timeDisplay").textContent =
            new Date().toLocaleTimeString();
        }, 1000);
      });
    </script>
  </body>
</html>
