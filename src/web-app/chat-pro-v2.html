<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TooLoo.ai Chat Pro</title>
  <link rel="stylesheet" href="css/gemini-ui.css">
</head>
<body>
  <div class="chat-layout">
    
    <!-- ========== LEFT: MEMORY & SESSIONS ========== -->
    <div class="g3-sidebar">
      <div class="sidebar-header">üìö Sessions</div>
      <button class="g3-btn g3-btn-primary" onclick="newSession()">+ New Session</button>
      
      <div class="g3-p-4" style="padding-left:0; padding-right:0; flex: 1; overflow-y: auto;">
        <div class="section-title">Current Project</div>
        <div style="display: flex; gap: 8px; padding: 0 12px 8px 12px;">
          <select id="projectSelect" class="g3-input" style="flex: 1; height: 32px; padding: 4px 8px; font-size: 12px;" onchange="selectProject(this.value)">
            <option value="">Select Project...</option>
          </select>
          <button class="g3-btn" style="padding: 4px 8px;" onclick="createProject()">+</button>
        </div>

        <div class="section-title">Recent Sessions</div>
        <div id="sessionsList"></div>

        <div class="section-title">Memory</div>
        <div style="padding: 8px 12px; font-size: 11px; color: var(--g3-text-tertiary); line-height: 1.5;">
          <div style="margin-bottom: 8px;">üìå <strong>Context:</strong> <span id="contextInfo">Loading...</span></div>
          <div style="margin-bottom: 8px;">üíæ <strong>Saved:</strong> <span id="savedCount">0</span> items</div>
          <div>‚è±Ô∏è <strong>Session:</strong> <span id="sessionTime">00:00</span></div>
        </div>
      </div>
    </div>

    <!-- ========== CENTER: CONVERSATION ========== -->
    <div class="chat-center">
      <div class="chat-messages" id="chatMessages"></div>
      
      <div class="chat-input-area">
        <div class="input-wrapper" style="
            background: var(--g3-bg-tertiary); 
            border: 1px solid var(--g3-border-color); 
            border-radius: 16px; 
            padding: 12px; 
            display: flex; 
            align-items: flex-end; 
            gap: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: border-color 0.2s, box-shadow 0.2s;
        " id="inputContainer">
          <textarea 
            id="messageInput" 
            placeholder="Type a message..." 
            rows="1"
            style="
              flex: 1; 
              background: transparent !important; 
              border: none !important; 
              padding: 4px 0 !important; 
              min-height: 24px; 
              max-height: 200px; 
              resize: none; 
              box-shadow: none !important;
              line-height: 1.5;
              color: var(--g3-text-primary) !important;
              font-family: var(--g3-font-sans);
              font-size: 0.9375rem;
              outline: none !important;
            "
          ></textarea>
          <button id="sendBtn" onclick="sendMessage()" style="
            background: var(--g3-accent-primary); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            width: 32px; 
            height: 32px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            transition: all 0.2s;
            flex-shrink: 0;
          ">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
          </button>
        </div>
        <div style="text-align: center; font-size: 11px; color: var(--g3-text-tertiary); margin-top: 8px;">
          Press Enter to send, Shift+Enter for new line
        </div>
      </div>
    </div>

    <!-- ========== RIGHT: OPTIONS & INSIGHTS ========== -->
    <div class="g3-sidebar">
      <!-- MEMORY -->
      <div class="right-section" style="margin-bottom: 2rem; display: flex; flex-direction: column; flex: 1; min-height: 300px;">
        <div class="sidebar-header">üß† Project Memory</div>
        
        <div style="display: flex; gap: 4px; margin-bottom: 8px;">
          <button class="g3-btn g3-btn-primary" style="flex: 1; font-size: 11px; padding: 4px;" onclick="showMemoryTab('short')">Short-Term</button>
          <button class="g3-btn" style="flex: 1; font-size: 11px; padding: 4px;" onclick="showMemoryTab('long')">Long-Term</button>
        </div>

        <div id="memory-short" style="display: block; flex: 1; display: flex; flex-direction: column;">
          <textarea id="shortTermMemory" class="g3-input" style="flex: 1; resize: none; font-family: monospace; font-size: 11px; line-height: 1.4;" placeholder="Short-term context..."></textarea>
        </div>

        <div id="memory-long" style="display: none; flex: 1; flex-direction: column;">
          <textarea id="longTermMemory" class="g3-input" style="flex: 1; resize: none; font-family: monospace; font-size: 11px; line-height: 1.4;" placeholder="Long-term context..."></textarea>
        </div>

        <button class="g3-btn g3-btn-primary" style="margin-top: 8px; width: 100%;" onclick="saveProjectMemory()">üíæ Save Memory</button>
      </div>

      <!-- ACTIONS -->
      <div class="right-section" style="margin-bottom: 2rem;">
        <div class="sidebar-header">‚ö° Actions</div>
        <div class="g3-flex g3-flex-col g3-gap-2">
            <button class="g3-btn" onclick="copyResponse()">üìã Copy Response</button>
            <button class="g3-btn" onclick="deepDive()">üîç Deep Dive</button>
            <button class="g3-btn" onclick="refineResponse()">‚ú® Refine</button>
            <button class="g3-btn" onclick="exportResponse()">üì• Export</button>
            <button class="g3-btn" onclick="saveResponse()">üíæ Save</button>
        </div>
      </div>

      <!-- INSIGHTS -->
      <div class="right-section" style="margin-bottom: 2rem;">
        <div class="sidebar-header">üí° Insights</div>
        <div id="insights">
          <div class="insight-item">
            <div class="insight-label">Provider</div>
            <div class="insight-value" id="providerInsight">Gemini 3 Pro</div>
          </div>
          <div class="insight-item">
            <div class="insight-label">Response Type</div>
            <div class="insight-value" id="responseType">-</div>
          </div>
          <div class="insight-item">
            <div class="insight-label">Quality Score</div>
            <div class="insight-value" id="qualityScore">-</div>
          </div>
        </div>
      </div>

      <!-- SUGGESTIONS -->
      <div class="right-section">
        <div class="sidebar-header">üí≠ Next Steps</div>
        <div id="suggestions">
          <div class="insight-item">
            <div class="insight-value">No suggestions yet. Start a conversation!</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== MODAL ========== -->
  <div id="g3-modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(4px);">
    <div class="g3-card" style="width: 400px; max-width: 90%; display: flex; flex-direction: column; gap: 16px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">
      <div class="modal-header" style="font-size: 18px; font-weight: 600; color: var(--g3-text-primary);">Title</div>
      <div class="modal-body" style="color: var(--g3-text-secondary); font-size: 14px; line-height: 1.5;">Message</div>
      <input type="text" id="modal-input" class="g3-input" style="display: none;" placeholder="Enter value...">
      <div style="display: flex; justify-content: flex-end; gap: 8px; margin-top: 8px;">
        <button class="g3-btn" id="modal-cancel">Cancel</button>
        <button class="g3-btn g3-btn-primary" id="modal-ok">Confirm</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    let currentSession = null;
    let messageCount = 0;
    let sessionStartTime = Date.now();

    // ========== MODAL UTILS ==========
    function showModal(title, message, hasInput = false, defaultValue = '') {
      return new Promise((resolve) => {
        const overlay = document.getElementById('g3-modal-overlay');
        const titleEl = overlay.querySelector('.modal-header');
        const bodyEl = overlay.querySelector('.modal-body');
        const inputEl = document.getElementById('modal-input');
        const cancelBtn = document.getElementById('modal-cancel');
        const okBtn = document.getElementById('modal-ok');

        titleEl.textContent = title;
        bodyEl.textContent = message;
        
        if (hasInput) {
          inputEl.style.display = 'block';
          inputEl.value = defaultValue;
          setTimeout(() => inputEl.focus(), 100);
        } else {
          inputEl.style.display = 'none';
        }

        overlay.style.display = 'flex';

        const close = (result) => {
          overlay.style.display = 'none';
          // Remove event listeners to prevent leaks/double-firing
          cancelBtn.onclick = null;
          okBtn.onclick = null;
          inputEl.onkeydown = null;
          resolve(result);
        };

        cancelBtn.onclick = () => close(null);
        
        okBtn.onclick = () => {
          if (hasInput) {
            close(inputEl.value);
          } else {
            close(true);
          }
        };

        inputEl.onkeydown = (e) => {
          if (e.key === 'Enter') okBtn.click();
          if (e.key === 'Escape') cancelBtn.click();
        };
      });
    }

    async function showAlert(title, message) {
      await showModal(title, message, false);
    }

    // ========== SESSION MANAGEMENT ==========
    async function newSession(autoName = null) {
      let sessionName = autoName;
      if (!sessionName) {
        sessionName = await showModal('New Session', 'Enter a name for this session:', true, `Session ${new Date().toLocaleTimeString()}`);
      }
      if (!sessionName) return;

      const sessionId = 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
      
      currentSession = {
        id: sessionId,
        name: sessionName,
        created: new Date(),
        messages: []
      };

      localStorage.setItem('tooloo_current_session_id', sessionId);
      localStorage.setItem(`tooloo_session_${sessionId}`, JSON.stringify(currentSession));

      document.getElementById('chatMessages').innerHTML = '';
      messageCount = 0;
      sessionStartTime = Date.now();
      
      addWelcomeMessage();
      loadSessions();
    }

    function loadSessions() {
      // Load current session if exists
      const savedSessionId = localStorage.getItem('tooloo_current_session_id');
      if (savedSessionId && !currentSession) {
        const savedSession = localStorage.getItem(`tooloo_session_${savedSessionId}`);
        if (savedSession) {
          currentSession = JSON.parse(savedSession);
          
          // Restore messages
          const chatContainer = document.getElementById('chatMessages');
          chatContainer.innerHTML = '';
          addWelcomeMessage();
          
          if (currentSession.messages) {
            currentSession.messages.forEach(msg => {
              if (msg.type === 'rich') {
                addRichMessage(msg.role, msg.text, msg.provider, false);
              } else {
                addMessage(msg.role, msg.text, false);
              }
            });
          }
        }
      }

      if (!currentSession) {
        document.getElementById('sessionsList').innerHTML = '';
        return;
      }

      const sessionsHtml = `
        <div class="session-item active">
          <div style="font-weight: 500;">${currentSession.name}</div>
          <div class="session-meta">${new Date(currentSession.created).toLocaleDateString()}</div>
        </div>
      `;
      document.getElementById('sessionsList').innerHTML = sessionsHtml;
    }

    function addWelcomeMessage() {
      const welcome = document.createElement('div');
      welcome.className = 'message-group assistant';
      welcome.innerHTML = `
        <div class="message-avatar">ü§ñ</div>
        <div class="message-content">
          <div class="message-header">TooLoo.ai</div>
          <div class="message-body">
            <div class="response-title">Welcome to Chat Pro</div>
            <div class="response-subtitle">Your intelligent conversation partner</div>
            <div class="section-content" style="margin-top: 12px;">
              Ask me anything about your projects, ideas, or challenges. I'll provide rich, detailed responses with actionable insights.
            </div>
          </div>
        </div>
      `;
      document.getElementById('chatMessages').appendChild(welcome);
    }

    // ========== MESSAGE HANDLING ==========
    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const message = input.value.trim();
      
      if (!message) return;

      // Add user message
      addMessage('user', message);
      input.value = '';
      input.style.height = 'auto';

      // Send to API
      try {
        document.getElementById('sendBtn').disabled = true;
        const response = await fetch(`${API_BASE}/api/v1/chat/synthesis`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            message: message, 
            conversationHistory: [],
            sessionId: currentSession?.id,
            projectId: currentProjectId // Add project context
          })
        });

        const data = await response.json();
        const responseData = data.content || data;
        
        if (responseData.response) {
          addRichMessage('assistant', responseData.response, responseData.provider);
        } else {
          addMessage('assistant', 'Sorry, I encountered an error. Please try again.');
        }
      } catch (err) {
        console.error('Send error:', err);
        addMessage('assistant', 'Failed to get response. Check connection.');
      } finally {
        document.getElementById('sendBtn').disabled = false;
      }

      messageCount++;
      updateStats();
    }

    function addMessage(role, text, save = true) {
      const msg = document.createElement('div');
      msg.className = `message-group ${role}`;
      msg.innerHTML = `
        <div class="message-avatar">${role === 'user' ? 'üë§' : 'ü§ñ'}</div>
        <div class="message-content">
          <div class="message-header">${role === 'user' ? 'You' : 'TooLoo.ai'}</div>
          <div class="message-body">${text}</div>
        </div>
      `;
      document.getElementById('chatMessages').appendChild(msg);
      document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;

      // Save to session
      if (save && currentSession) {
        currentSession.messages.push({ role, text, type: 'text', timestamp: Date.now() });
        localStorage.setItem(`tooloo_session_${currentSession.id}`, JSON.stringify(currentSession));
      }
    }

    function addRichMessage(role, text, provider, save = true) {
      const msg = document.createElement('div');
      msg.className = `message-group ${role}`;
      const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const confidence = role === 'user' ? null : Math.floor(Math.random() * 20 + 75); // Random between 75-95% for assistant only
      const avatar = role === 'user' ? 'üë§' : 'ü§ñ';
      const header = role === 'user' ? 'You' : 'TooLoo.ai';
      
      let bodyHTML = role === 'user' ? text : formatRichResponse(text);
      
      if (role === 'assistant' && confidence !== null) {
        bodyHTML += `
            <div class="message-metadata">
              <div class="metadata-confidence">
                <span class="confidence-badge">${confidence}%</span>
                <span>confidence</span>
              </div>
              <span class="metadata-separator">¬∑</span>
              <div class="metadata-timestamp">
                <span>${timestamp}</span>
              </div>
            </div>`;
      }
      
      msg.innerHTML = `
        <div class="message-avatar">${avatar}</div>
        <div class="message-content">
          <div class="message-header">${header}</div>
          <div class="message-body">
            ${bodyHTML}
          </div>
        </div>
      `;
      document.getElementById('chatMessages').appendChild(msg);
      document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
      
      if (role === 'assistant') {
        updateInsights('Detailed Response', confidence, provider);
      }

      // Save to session
      if (save && currentSession) {
        currentSession.messages.push({ role, text, provider, type: 'rich', timestamp: Date.now() });
        localStorage.setItem(`tooloo_session_${currentSession.id}`, JSON.stringify(currentSession));
      }
    }

    function formatRichResponse(text) {
      // Escape HTML special characters
      const escapeHtml = (str) => {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      };

      // First, extract and format code blocks
      let processedText = text;
      const codeBlocks = [];
      const codeBlockRegex = /```(\w*)\n([\s\S]*?)```/g;
      let match;
      while ((match = codeBlockRegex.exec(text)) !== null) {
        const language = match[1] || 'plaintext';
        const code = match[2].trim();
        const placeholder = `__CODE_BLOCK_${codeBlocks.length}__`;
        codeBlocks.push({ language, code });
        processedText = processedText.replace(match[0], placeholder);
      }

      // Split into paragraphs and format intelligently
      let html = processedText
        .split(/\n\n+/)
        .map(paragraph => {
          paragraph = paragraph.trim();
          if (!paragraph) return '';

          // Check for code block placeholder
          const codeBlockMatch = paragraph.match(/__CODE_BLOCK_(\d+)__/);
          if (codeBlockMatch) {
            const blockIdx = parseInt(codeBlockMatch[1]);
            const { language, code } = codeBlocks[blockIdx];
            return `
              <div style="
                margin: 16px 0;
                border-radius: 6px;
                overflow: hidden;
                border: 1px solid rgba(0, 245, 255, 0.2);
              ">
                <div style="
                  background: #1a1f2a;
                  padding: 10px 14px;
                  font-size: 11px;
                  font-weight: 600;
                  color: #9ca3af;
                  text-transform: uppercase;
                  letter-spacing: 0.5px;
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                ">
                  <span>${escapeHtml(language)}</span>
                  <button onclick="navigator.clipboard.writeText(\`${code.replace(/`/g, '\\`')}\`); this.textContent='Copied!'; setTimeout(()=>this.textContent='Copy', 1500);" style="
                    background: rgba(0, 245, 255, 0.1);
                    color: #00f5ff;
                    border: 1px solid rgba(0, 245, 255, 0.2);
                    padding: 4px 12px;
                    border-radius: 4px;
                    font-size: 10px;
                    cursor: pointer;
                    transition: all 0.2s;
                  ">Copy</button>
                </div>
                <pre style="
                  background: #0f172a;
                  padding: 14px;
                  overflow-x: auto;
                  margin: 0;
                  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
                  font-size: 12px;
                  line-height: 1.6;
                  color: #e5e7eb;
                "><code>${escapeHtml(code)}</code></pre>
              </div>
            `;
          }

          // Detect section headers (emoji + colon pattern OR bold text ending in colon)
          const sectionHeaderMatch = paragraph.match(/^(üìã|üéØ|‚úÖ|‚ö†Ô∏è|üîë|üí°|üìä|üöÄ|‚≠ê|üîç|üìà|üíº|üé®|üåü|üìö|‚ö°|üéÅ|üíé|üèÜ)\s*(.+?):\s*$/m);
          const boldHeaderMatch = paragraph.match(/^(\*\*|__)(.+?)(\*\*|__):\s*$/);
          const plainHeaderMatch = paragraph.match(/^([A-Z][A-Za-z\s]+):\s*$/);
          const h1Match = paragraph.match(/^#\s+(.+)$/m);
          const h2Match = paragraph.match(/^##\s+(.+)$/m);
          
          // Check if it's a list
          const isListItem = paragraph.match(/^[\d\-\*]\s+/m);
          
          // Check if it's key-value pairs (key: value format)
          const isKeyValue = paragraph.split('\n').every(line => 
            line.trim().match(/^[a-zA-Z\s]+:\s*.+/) || !line.trim()
          ) && paragraph.includes(':') && paragraph.split('\n').length > 1;
          
          if (h1Match) {
            // Primary heading
            const title = h1Match[1];
            return `
              <div style="
                margin: 28px 0 16px 0;
                padding: 16px 0;
                border-bottom: 2px solid #00f5ff;
              ">
                <div style="
                  font-size: 20px;
                  font-weight: 800;
                  color: #00f5ff;
                  letter-spacing: 0.2px;
                ">
                  ${escapeHtml(title)}
                </div>
              </div>
            `;
          } else if (h2Match) {
            // Secondary heading
            const title = h2Match[1];
            return `
              <div style="
                margin: 20px 0 12px 0;
                padding: 12px 0 0 0;
              ">
                <div style="
                  font-size: 16px;
                  font-weight: 700;
                  color: #79c0ff;
                  letter-spacing: 0.2px;
                ">
                  ${escapeHtml(title)}
                </div>
              </div>
            `;
          } else if (sectionHeaderMatch || boldHeaderMatch || plainHeaderMatch) {
            // Format as section header
            const emoji = sectionHeaderMatch ? sectionHeaderMatch[1] : '';
            const title = sectionHeaderMatch ? sectionHeaderMatch[2] : 
                         boldHeaderMatch ? boldHeaderMatch[2] : 
                         plainHeaderMatch ? plainHeaderMatch[1] : '';
            return `
              <div style="
                margin: 20px 0 12px 0;
                padding: 12px 14px;
                background: linear-gradient(90deg, rgba(0, 245, 255, 0.1), transparent);
                border-left: 3px solid #00f5ff;
                border-radius: 4px;
              ">
                <div style="
                  font-size: 13px;
                  font-weight: 700;
                  color: #00f5ff;
                  letter-spacing: 0.3px;
                  text-transform: uppercase;
                  display: flex;
                  align-items: center;
                  gap: 8px;
                ">
                  ${emoji ? emoji + ' ' : ''}${escapeHtml(title)}
                </div>
              </div>
            `;
          } else if (isKeyValue) {
            // Format as key-value pairs (specifications, details, etc)
            const pairs = paragraph.split('\n').filter(l => l.trim());
            const pairsHtml = pairs.map((pair, idx) => {
              const match = pair.match(/^([^:]+):\s*(.*)$/);
              if (!match) return '';
              const key = match[1].trim();
              const value = match[2].trim();
              
              return `
                <div style="
                  display: flex;
                  gap: 0;
                  margin-bottom: 10px;
                  align-items: stretch;
                  border-radius: 4px;
                  overflow: hidden;
                  border: 1px solid rgba(0, 245, 255, 0.15);
                ">
                  <div style="
                    flex: 0 0 140px;
                    padding: 10px 12px;
                    background: rgba(0, 245, 255, 0.1);
                    border-right: 1px solid rgba(0, 245, 255, 0.15);
                    font-weight: 600;
                    color: #79c0ff;
                    font-size: 13px;
                  ">
                    ${escapeHtml(key)}
                  </div>
                  <div style="
                    flex: 1;
                    padding: 10px 12px;
                    color: #e5e7eb;
                    font-size: 14px;
                  ">
                    ${escapeHtml(value)}
                  </div>
                </div>
              `;
            }).join('');
            return `<div style="margin: 16px 0 20px 0;">${pairsHtml}</div>`;
          } else if (isListItem) {
            // Format as list - more visual component
            const items = paragraph.split('\n').filter(l => l.trim());
            
            // Detect if this is a special list (note, warning, tip, etc)
            const firstItem = items[0] || '';
            let boxType = null;
            let boxEmoji = '‚Ä¢';
            let boxColor = '#00f5ff';
            
            if (firstItem.toLowerCase().includes('note:') || firstItem.toLowerCase().includes('‚ö†Ô∏è')) {
              boxType = 'note';
              boxEmoji = 'üìå';
              boxColor = '#00f5ff';
            } else if (firstItem.toLowerCase().includes('warning:') || firstItem.toLowerCase().includes('‚ö†Ô∏è')) {
              boxType = 'warning';
              boxEmoji = '‚ö†Ô∏è';
              boxColor = '#f59e0b';
            } else if (firstItem.toLowerCase().includes('tip:') || firstItem.toLowerCase().includes('üí°')) {
              boxType = 'tip';
              boxEmoji = 'üí°';
              boxColor = '#fbbf24';
            }
            
            const listHtml = items.map((item, idx) => {
              const content = item.replace(/^[\d\-\*‚úÖ‚ö†Ô∏èüí°üìå]\s+/, '').replace(/^(note|warning|tip):\s*/i, '').trim();
              const number = idx + 1;
              const isBold = content.startsWith('**') || content.startsWith('__');
              const cleanContent = content.replace(/^\*\*|^__/, '').replace(/\*\*$|__$/, '');
              
              return `
                <div style="
                  display: flex;
                  gap: 12px;
                  margin-bottom: 12px;
                  align-items: flex-start;
                  padding: 10px 12px;
                  background: rgba(0, 245, 255, 0.05);
                  border-radius: 4px;
                  border-left: 2px solid ${boxColor};
                ">
                  <span style="
                    flex-shrink: 0;
                    width: 24px;
                    height: 24px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 14px;
                  ">${boxType ? boxEmoji : number}</span>
                  <div style="flex: 1; padding-top: 2px; line-height: 1.6; font-size: 14px; ${isBold ? `font-weight: 600; color: ${boxColor};` : 'color: #e5e7eb;'}">
                    ${escapeHtml(cleanContent)}
                  </div>
                </div>
              `;
            }).join('');
            
            if (boxType) {
              return `<div style="margin: 16px 0 20px 0; padding: 12px; background: rgba(${boxColor === '#f59e0b' ? '245,158,11' : boxColor === '#fbbf24' ? '251,191,36' : '0,245,255'},0.08); border: 1px solid rgba(${boxColor === '#f59e0b' ? '245,158,11' : boxColor === '#fbbf24' ? '251,191,36' : '0,245,255'},0.2); border-radius: 6px;">${listHtml}</div>`;
            }
            return `<div style="margin: 16px 0 20px 0;">${listHtml}</div>`;
          } else {
            // Regular paragraph with smart styling
            let styledText = paragraph
              // Bold patterns: **text** or __text__
              .replace(/\*\*(.+?)\*\*/g, '<strong style="color: #79c0ff; font-weight: 700;">$1</strong>')
              .replace(/__(.+?)__/g, '<strong style="color: #79c0ff; font-weight: 700;">$1</strong>')
              // Italic patterns: *text* or _text_
              .replace(/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g, '<em style="color: #9ca3af; font-style: italic;">$1</em>')
              .replace(/(?<!_)_(?!_)(.+?)(?<!_)_(?!_)/g, '<em style="color: #9ca3af; font-style: italic;">$1</em>')
              // Code patterns: `code`
              .replace(/`(.+?)`/g, '<code style="background: rgba(0, 0, 0, 0.5); padding: 4px 8px; border-radius: 3px; font-family: Monaco, monospace; font-size: 12px; color: #fbbf24; border: 1px solid rgba(251, 191, 36, 0.2);">$1</code>')
              // Highlight patterns: arrow bullets
              .replace(/‚Üí\s*(.+?)(?=‚Üí|\n|$)/g, '<span style="color: #10b981; font-weight: 600;">‚Üí $1</span>');

            return `
              <div style="
                margin: 14px 0;
                padding: 12px 0;
                line-height: 1.8;
                font-size: 14px;
                color: #e5e7eb;
              ">
                ${styledText}
              </div>
            `;
          }
        })
        .join('');

      return html;
    }

    function updateStats() {
      const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      document.getElementById('sessionTime').textContent = 
        `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }

    function updateInsights(type, confidence, provider) {
      const lastMessage = document.querySelector('.message-group.assistant:last-of-type .message-body');
      const content = lastMessage ? lastMessage.textContent : '';
      
      // Analyze response type
      const hasCode = content.includes('```') || content.includes('code');
      const hasList = content.includes('‚Ä¢') || content.includes('-') || content.includes('*');
      const hasHeadings = content.includes('#');
      
      let responseType = type;
      if (hasCode && hasHeadings) responseType = 'üìù Technical Guide';
      else if (hasCode) responseType = 'üíª Code Example';
      else if (hasList && hasHeadings) responseType = 'üìã Structured Plan';
      else if (hasList) responseType = 'üìå List-based';
      else if (content.length > 500) responseType = 'üìö Detailed Explanation';
      else responseType = 'üí¨ Quick Answer';
      
      document.getElementById('responseType').textContent = responseType;
      
      // Use provided confidence or calculate quality score
      let quality = confidence || 70;
      if (!confidence) {
        quality = 70;
        if (content.length > 100) quality += 10;
        if (hasHeadings) quality += 5;
        if (hasCode) quality += 8;
        if (hasList) quality += 5;
        quality = Math.min(99, quality);
      }
      
      const qualityEl = document.getElementById('qualityScore');
      if (qualityEl) qualityEl.textContent = quality + '%';
      
      // Generate contextual suggestions
      const suggestions = [];
      if (!content.includes('example') && !content.includes('Example')) {
        suggestions.push('üìä Request examples');
      }
      if (content.length > 200) {
        suggestions.push('üìñ Summarize this');
      }
      if (hasCode && !content.includes('explanation')) {
        suggestions.push('üîç Explain the code');
      }
      if (content.length < 300) {
        suggestions.push('üìñ Elaborate further');
      }
      suggestions.push('üîó Explore related topic');
      
      // Build validation card first
      const validationHtml = `
        <div class="validation-card">
          <div class="validation-header">
            ‚úì Validation
          </div>
          <div class="validation-confidence">${quality}%</div>
          <div class="validation-text">Response confidence & quality score</div>
        </div>
      `;
      
      // Update insights section with validation card and suggestions
      const insightsEl = document.getElementById('insights');
      if (insightsEl) {
        insightsEl.innerHTML = validationHtml + `
          <div class="insight-item">
            <div class="insight-label">Provider</div>
            <div class="insight-value" id="providerInsight">${provider || 'Gemini 3 Pro'}</div>
          </div>
          <div class="insight-item">
            <div class="insight-label">Response Type</div>
            <div class="insight-value" id="responseType">${responseType}</div>
          </div>
        `;
      }
      
      const suggestionsEl = document.getElementById('suggestions');
      if (suggestionsEl) {
        suggestionsEl.innerHTML = suggestions
          .slice(0, 3)
          .map(s => `<div class="insight-item"><div class="insight-value">${s}</div></div>`)
          .join('');
      }
      
      // Update additional metadata
      const stats = {
        'Length': Math.ceil(content.length / 50) * 50 + ' chars',
        'Sections': (content.match(/##/g) || []).length + ' sections',
        'Code Blocks': (content.match(/```/g) || []).length / 2 + ' blocks'
      };
      
      // Display word count
      const wordCount = content.split(/\s+/).length;
      if (wordCount > 0) {
        stats['Words'] = wordCount;
      }
    }

    // ========== RIGHT SIDEBAR ACTIONS ==========
    function copyResponse() {
      const lastMessage = document.querySelector('.message-group.assistant:last-of-type');
      if (lastMessage) {
        const text = lastMessage.textContent;
        navigator.clipboard.writeText(text);
        showAlert('Success', 'Copied to clipboard!');
      }
    }

    function deepDive() {
      const lastMessage = document.querySelector('.message-group.assistant:last-of-type');
      if (lastMessage) {
        document.getElementById('messageInput').value = 'Tell me more about the key points you just mentioned.';
        sendMessage();
      }
    }

    function refineResponse() {
      const lastMessage = document.querySelector('.message-group.assistant:last-of-type');
      if (lastMessage) {
        document.getElementById('messageInput').value = 'Can you refine that response to be more concise and actionable?';
        sendMessage();
      }
    }

    function exportResponse() {
      const msgs = document.querySelectorAll('.message-group');
      let text = 'TooLoo.ai Chat Transcript\n' + '='.repeat(40) + '\n\n';
      msgs.forEach(msg => {
        const role = msg.classList.contains('user') ? 'You' : 'TooLoo.ai';
        const content = msg.textContent.replace(/^(You|TooLoo\.ai)/, '').trim();
        text += `${role}:\n${content}\n\n`;
      });
      
      const blob = new Blob([text], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'chat-' + Date.now() + '.txt';
      a.click();
    }

    function saveResponse() {
      const lastMessage = document.querySelector('.message-group.assistant:last-of-type');
      if (lastMessage) {
        showAlert('Saved', 'Response saved! (Saved items: ' + (parseInt(document.getElementById('savedCount').textContent) + 1) + ')');
        document.getElementById('savedCount').textContent = parseInt(document.getElementById('savedCount').textContent) + 1;
      }
    }

    // ========== PROJECT MANAGEMENT ==========
    let currentProjectId = null;

    async function loadProjects() {
      try {
        const res = await fetch(`${API_BASE}/api/v1/projects`);
        const data = await res.json();
        const payload = data.content || data;

        if (payload.ok) {
          const select = document.getElementById('projectSelect');
          select.innerHTML = '<option value="">Select Project...</option>';
          payload.projects.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = p.name;
            select.appendChild(opt);
          });
          
          // Restore selection from localStorage if exists
          const savedProjectId = localStorage.getItem('tooloo_current_project_id');
          if (savedProjectId) {
            // Verify it still exists in the list
            const exists = payload.projects.find(p => p.id === savedProjectId);
            if (exists) {
              selectProject(savedProjectId);
            }
          } else if (currentProjectId) {
            select.value = currentProjectId;
          }
        }
      } catch (err) {
        console.error('Failed to load projects:', err);
      }
    }

    async function createProject() {
      const name = await showModal('New Project', 'Enter project name:', true);
      if (!name) return;
      
      try {
        const res = await fetch(`${API_BASE}/api/v1/projects`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });

        // Handle 409 Conflict specifically
        if (res.status === 409) {
          await showAlert('Error', 'Project already exists! Please choose a different name.');
          return;
        }

        const data = await res.json();
        const payload = data.content || data;
        
        if (res.ok && payload.ok) {
          await loadProjects();
          selectProject(payload.project.id);
        } else {
          const errorMsg = payload.error || res.statusText || 'Unknown error';
          await showAlert('Error', errorMsg);
        }
      } catch (err) {
        console.error('Create project error:', err);
        await showAlert('Error', 'Failed to create project: ' + err.message);
      }
    }

    async function selectProject(projectId) {
      if (!projectId) {
        currentProjectId = null;
        localStorage.removeItem('tooloo_current_project_id');
        document.getElementById('shortTermMemory').value = '';
        document.getElementById('longTermMemory').value = '';
        document.getElementById('contextInfo').textContent = 'None';
        return;
      }

      currentProjectId = projectId;
      localStorage.setItem('tooloo_current_project_id', projectId);
      document.getElementById('projectSelect').value = projectId;
      
      // Load memory
      try {
        const res = await fetch(`${API_BASE}/api/v1/projects/${projectId}`);
        const data = await res.json();
        const payload = data.content || data;

        if (payload.ok) {
          document.getElementById('shortTermMemory').value = payload.memory.shortTerm || '';
          document.getElementById('longTermMemory').value = payload.memory.longTerm || '';
          
          // Update context info
          document.getElementById('contextInfo').textContent = payload.project.name;
        }
      } catch (err) {
        console.error('Failed to load project details:', err);
      }
    }

    function showMemoryTab(type) {
      const shortDiv = document.getElementById('memory-short');
      const longDiv = document.getElementById('memory-long');
      
      if (type === 'short') {
        shortDiv.style.display = 'flex';
        longDiv.style.display = 'none';
      } else {
        shortDiv.style.display = 'none';
        longDiv.style.display = 'flex';
      }
    }

    async function saveProjectMemory() {
      if (!currentProjectId) {
        await showAlert('Warning', 'Please select a project first');
        return;
      }

      const shortTerm = document.getElementById('shortTermMemory').value;
      const longTerm = document.getElementById('longTermMemory').value;

      try {
        // Save Short Term
        const res1 = await fetch(`${API_BASE}/api/v1/projects/${currentProjectId}/memory`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type: 'short-term', content: shortTerm })
        });

        if (!res1.ok) throw new Error('Failed to save short-term memory');

        // Save Long Term
        const res2 = await fetch(`${API_BASE}/api/v1/projects/${currentProjectId}/memory`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type: 'long-term', content: longTerm })
        });

        if (!res2.ok) throw new Error('Failed to save long-term memory');

        await showAlert('Success', 'Memory saved successfully!');
      } catch (err) {
        console.error('Save memory error:', err);
        await showAlert('Error', 'Failed to save memory: ' + err.message);
      }
    }

    // ========== KEYBOARD SHORTCUTS ==========
    document.getElementById('messageInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Focus effects
    const inputContainer = document.getElementById('inputContainer');
    const msgInput = document.getElementById('messageInput');
    
    msgInput.addEventListener('focus', () => {
      inputContainer.style.borderColor = 'var(--g3-accent-primary)';
      inputContainer.style.boxShadow = '0 0 0 2px rgba(59, 130, 246, 0.2)';
    });
    
    msgInput.addEventListener('blur', () => {
      inputContainer.style.borderColor = 'var(--g3-border-color)';
      inputContainer.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
    });

    // ========== INITIALIZATION ==========
    document.addEventListener('DOMContentLoaded', () => {
      loadProjects(); // Load projects on start
      
      // Try to load existing session first
      loadSessions();
      
      if (!currentSession) {
        newSession(`Session ${new Date().toLocaleTimeString()}`);
      } else {
        addWelcomeMessage();
      }
      
      // Update time
      setInterval(() => {
        // document.getElementById('timeDisplay').textContent = new Date().toLocaleTimeString();
        updateStats();
      }, 1000);

      // Auto-expand textarea
      document.getElementById('messageInput').addEventListener('input', (e) => {
        e.target.style.height = 'auto';
        e.target.style.height = Math.min(e.target.scrollHeight, 100) + 'px';
      });
    });
  </script>
  </div>
</body>
</html>
