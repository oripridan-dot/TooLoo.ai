<!DOCTYPE html>
<!-- @version 2.1.347 -->
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tooloo Synapsys // Orchestrator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=JetBrains+Mono:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #030712;
        color: #e2e8f0;
      }
      .mono {
        font-family: "JetBrains Mono", monospace;
      }
      .glass {
        background: rgba(17, 24, 39, 0.7);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      .glow-text {
        text-shadow: 0 0 10px rgba(6, 182, 212, 0.5);
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }

      /* Mermaid Styles */
      .mermaid {
        background: transparent;
        padding: 10px;
        text-align: center;
      }

      /* Thought Bubble Styles */
      .thought-bubble {
        margin: 8px 0 16px 0;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        background: rgba(17, 24, 39, 0.5);
        overflow: hidden;
        font-size: 13px;
      }
      .thought-header {
        padding: 8px 12px;
        background: rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        user-select: none;
      }
      .thought-header:hover {
        background: rgba(0, 0, 0, 0.3);
      }
      .thought-status {
        flex: 1;
        color: #9ca3af;
        font-weight: 500;
      }
      .thought-content {
        padding: 8px 12px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .thought-bubble.collapsed .thought-content {
        display: none;
      }
      .thought-step {
        display: flex;
        gap: 8px;
        align-items: flex-start;
        color: #9ca3af;
        font-family: "JetBrains Mono", monospace;
        font-size: 12px;
        line-height: 1.4;
      }
    </style>

    <!-- Markdown & Syntax Highlighting -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
  </head>
  <body class="h-screen w-screen overflow-hidden flex text-sm">
    <!-- 1. SIDEBAR: NEURAL TRUNK -->
    <aside class="w-64 flex flex-col border-r border-white/10 bg-gray-900/50">
      <!-- Identity -->
      <div class="p-4 border-b border-white/10 flex items-center gap-3">
        <div
          class="w-8 h-8 rounded bg-cyan-500/20 border border-cyan-500 flex items-center justify-center text-cyan-400 font-bold"
        >
          T
        </div>
        <div>
          <h1 class="font-bold tracking-tight">TooLoo.ai</h1>
          <p class="text-xs text-gray-500 mono">Synapsys v2.4</p>
        </div>
      </div>

      <!-- Navigation -->
      <nav class="flex-1 overflow-y-auto py-4">
        <div
          class="px-4 mb-2 text-xs font-bold text-gray-600 uppercase tracking-wider"
        >
          Core
        </div>
        <a
          href="index.html"
          class="block px-4 py-2 border-l-2 border-transparent hover:bg-white/5 text-gray-400"
          >Home</a
        >
        <a
          href="chat-pro-v2.html"
          class="block px-4 py-2 border-l-2 border-cyan-500 bg-cyan-500/10 text-cyan-300"
          >Chat Pro</a
        >
        <a
          href="projects.html"
          class="block px-4 py-2 border-l-2 border-transparent hover:bg-white/5 text-gray-400"
          >Projects</a
        >

        <div
          class="px-4 mt-6 mb-2 text-xs font-bold text-gray-600 uppercase tracking-wider"
        >
          Tools
        </div>
        <a
          href="visuals.html"
          class="block px-4 py-2 border-l-2 border-transparent hover:bg-white/5 text-gray-400"
          >Visual Designer</a
        >
        <a
          href="control-room.html"
          class="block px-4 py-2 border-l-2 border-transparent hover:bg-white/5 text-gray-400"
          >Control Room</a
        >
        <a
          href="#"
          class="block px-4 py-2 border-l-2 border-transparent hover:bg-white/5 text-gray-400"
          >System Awareness</a
        >

        <div
          class="px-4 mt-6 mb-2 text-xs font-bold text-gray-600 uppercase tracking-wider"
        >
          Active Sessions
        </div>
        <div id="sessionsList" class="space-y-1">
          <!-- Sessions injected here -->
        </div>
        <button
          onclick="newSession()"
          class="mx-4 mt-2 px-3 py-1.5 text-xs border border-white/10 rounded hover:bg-white/5 text-gray-400 w-auto"
        >
          + New Session
        </button>
      </nav>

      <!-- Model Status -->
      <div class="p-4 border-t border-white/10">
        <div class="flex items-center justify-between mb-2">
          <span class="text-xs text-gray-500">System Load</span>
          <span class="text-xs text-emerald-400 mono">12%</span>
        </div>
        <div class="h-1 w-full bg-gray-800 rounded-full overflow-hidden">
          <div class="h-full bg-cyan-500 w-[12%]"></div>
        </div>
      </div>
    </aside>

    <!-- 2. MAIN STAGE: THE SYNAPSE -->
    <main class="flex-1 flex flex-col relative">
      <!-- Header -->
      <header
        class="h-14 border-b border-white/10 flex items-center justify-between px-6 bg-gray-900/30"
      >
        <div class="flex items-center gap-2">
          <span
            class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"
          ></span>
          <span class="mono text-xs text-emerald-400"
            >GEMINI PRO // ONLINE</span
          >
        </div>
        <div class="flex gap-4 items-center">
          <!-- Project Selector -->
          <div class="relative group">
            <button
              class="text-xs text-gray-400 hover:text-white flex items-center gap-2"
              onclick="document.getElementById('projectSelect').click()"
            >
              <span id="currentProjectName">Select Project</span>
              <svg
                class="w-3 h-3"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 9l-7 7-7-7"
                ></path>
              </svg>
            </button>
            <select
              id="projectSelect"
              class="absolute opacity-0 top-0 left-0 w-full h-full cursor-pointer"
              onchange="selectProject(this.value)"
            >
              <option value="">Select Project...</option>
            </select>
          </div>

          <div class="h-4 w-px bg-white/10"></div>

          <button
            class="text-gray-400 hover:text-white transition"
            title="Settings"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
              ></path>
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
              ></path>
            </svg>
          </button>
        </div>
      </header>

      <!-- Chat Stream -->
      <div
        class="flex-1 overflow-y-auto p-6 space-y-6 scrollbar-hide"
        id="chatMessages"
      >
        <!-- Messages will be injected here -->
      </div>

      <!-- Input Matrix -->
      <div class="p-6 border-t border-white/10 bg-gray-900/50 backdrop-blur">
        <div class="max-w-3xl mx-auto relative" id="inputContainer">
          <textarea
            id="messageInput"
            class="w-full bg-gray-950/80 border border-white/10 rounded-lg p-4 pl-4 pr-32 focus:outline-none focus:border-cyan-500/50 focus:ring-1 focus:ring-cyan-500/50 text-gray-200 placeholder-gray-600 resize-none h-24 mono text-sm"
            placeholder="Input directive for Synapsys..."
          ></textarea>
          <div class="absolute bottom-4 right-4 flex gap-2">
            <select
              id="responsePreference"
              class="bg-gray-900 border border-white/10 text-gray-400 text-xs rounded px-2 py-1 focus:outline-none"
            >
              <option value="context-driven">Auto</option>
              <option value="detailed">Detailed</option>
              <option value="concise">Concise</option>
              <option value="code">Code</option>
            </select>
            <button
              id="sendBtn"
              onclick="sendMessage()"
              class="px-4 py-2 rounded bg-cyan-600 hover:bg-cyan-500 text-white text-xs font-bold tracking-wide transition"
            >
              EXECUTE
            </button>
          </div>
        </div>
      </div>
    </main>

    <!-- 3. RIGHT PANEL: TELEMETRY -->
    <aside
      class="w-72 border-l border-white/10 bg-gray-900/30 hidden xl:flex flex-col"
      id="rightSidebar"
    >
      <div class="p-4 border-b border-white/10">
        <h2
          class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-4"
        >
          Neural State
        </h2>

        <div class="space-y-4">
          <!-- Agent Status -->
          <div class="space-y-1">
            <div class="flex justify-between text-xs">
              <span class="text-gray-400">OpenAI (GPT-4)</span>
              <span class="text-emerald-500">Idle</span>
            </div>
            <div class="h-1 bg-gray-800 rounded-full">
              <div class="w-0 bg-emerald-500 h-full"></div>
            </div>
          </div>
          <div class="space-y-1">
            <div class="flex justify-between text-xs">
              <span class="text-gray-400">Anthropic (Claude 3.5)</span>
              <span class="text-emerald-500">Idle</span>
            </div>
            <div class="h-1 bg-gray-800 rounded-full">
              <div class="w-0 bg-emerald-500 h-full"></div>
            </div>
          </div>
          <div class="space-y-1">
            <div class="flex justify-between text-xs">
              <span class="text-white font-bold">Google (Gemini Pro)</span>
              <span class="text-cyan-400 animate-pulse">Processing</span>
            </div>
            <div class="h-1 bg-gray-800 rounded-full">
              <div class="w-3/4 bg-cyan-500 h-full"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="p-4 flex-1 overflow-y-auto">
        <h2
          class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-4"
        >
          Context Memory
        </h2>

        <!-- Memory Tabs -->
        <div class="flex gap-2 mb-3">
          <button
            onclick="showMemoryTab('short')"
            class="flex-1 py-1 text-xs bg-cyan-500/20 text-cyan-300 rounded border border-cyan-500/30"
          >
            Short-Term
          </button>
          <button
            onclick="showMemoryTab('long')"
            class="flex-1 py-1 text-xs bg-gray-800 text-gray-400 rounded border border-white/5 hover:bg-gray-700"
          >
            Long-Term
          </button>
        </div>

        <div id="memory-short" class="space-y-2">
          <textarea
            id="shortTermMemory"
            class="w-full h-32 bg-gray-950/50 border border-white/10 rounded p-2 text-xs text-gray-400 mono resize-none focus:outline-none focus:border-cyan-500/30"
            placeholder="Short-term context..."
          ></textarea>
        </div>

        <div id="memory-long" class="space-y-2 hidden">
          <textarea
            id="longTermMemory"
            class="w-full h-32 bg-gray-950/50 border border-white/10 rounded p-2 text-xs text-gray-400 mono resize-none focus:outline-none focus:border-cyan-500/30"
            placeholder="Long-term context..."
          ></textarea>
        </div>

        <button
          onclick="saveProjectMemory()"
          class="w-full mt-2 py-1.5 text-xs bg-gray-800 hover:bg-gray-700 text-gray-300 rounded border border-white/10 transition"
        >
          üíæ Save Memory
        </button>

        <div class="mt-6">
          <h2
            class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-4"
          >
            Insights
          </h2>
          <div id="insights" class="space-y-2">
            <div class="glass p-3 rounded text-xs text-gray-400">
              <span class="block text-cyan-400 mb-1">Provider</span>
              <span id="providerInsight">Gemini 3 Pro</span>
            </div>
            <div class="glass p-3 rounded text-xs text-gray-400">
              <span class="block text-cyan-400 mb-1">Quality</span>
              <span id="qualityScore">-</span>
            </div>
          </div>
        </div>
      </div>
    </aside>

    <!-- ========== MODAL ========== -->
    <div
      id="g3-modal-overlay"
      class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center"
    >
      <div
        class="bg-gray-900 border border-white/10 rounded-lg p-6 w-96 shadow-2xl"
      >
        <div class="modal-header text-lg font-bold text-white mb-2">Title</div>
        <div class="modal-body text-gray-400 text-sm mb-4">Message</div>
        <input
          type="text"
          id="modal-input"
          class="w-full bg-gray-950 border border-white/10 rounded p-2 text-sm text-white mb-4 hidden focus:outline-none focus:border-cyan-500"
          placeholder="Enter value..."
        />
        <div class="flex justify-end gap-2">
          <button
            id="modal-cancel"
            class="px-4 py-2 rounded text-sm text-gray-400 hover:text-white hover:bg-white/5"
          >
            Cancel
          </button>
          <button
            id="modal-ok"
            class="px-4 py-2 rounded text-sm bg-cyan-600 text-white hover:bg-cyan-500"
          >
            Confirm
          </button>
        </div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      mermaid.initialize({
        startOnLoad: false,
        theme: "dark",
        securityLevel: "loose",
        fontFamily: "Inter",
        themeVariables: {
          darkMode: true,
          background: "#111827",
          primaryColor: "#06b6d4",
          lineColor: "#94a3b8",
        },
      });

      const API_BASE = window.location.origin;
      let currentSession = null;
      let messageCount = 0;
      let sessionStartTime = Date.now();

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        loadProjects();
        loadSessions();
        if (!currentSession)
          newSession(`Session ${new Date().toLocaleTimeString()}`);

        // Auto-expand textarea
        const textarea = document.getElementById("messageInput");
        textarea.addEventListener("input", function () {
          this.style.height = "auto";
          this.style.height = this.scrollHeight + "px";
        });

        // Keyboard shortcuts
        textarea.addEventListener("keydown", (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
      });

      // Socket Connection
      let socket = null;
      let activeRequestId = null;
      let activeThoughtBubble = null;

      try {
        if (typeof io !== 'undefined') {
          socket = io();
          socket.on("connect", () =>
            console.log("Connected to Synapsys Event Stream"),
          );
          socket.on("synapsys:event", (event) => {
            if (!activeThoughtBubble) return;
            if (
              event.payload.requestId &&
              event.payload.requestId !== activeRequestId
            )
              return;
            updateThoughtBubble(event.type, event.payload);
          });
        } else {
          console.warn("Socket.io not loaded. Real-time updates disabled.");
        }
      } catch (e) {
        console.error("Socket initialization failed:", e);
      }

      function createThoughtBubble() {
        const bubble = document.createElement("div");
        bubble.className = "thought-bubble";
        bubble.innerHTML = `
        <div class="thought-header" onclick="this.parentElement.classList.toggle('collapsed')">
          <span class="thought-status">Thinking...</span>
          <span class="text-xs text-gray-500">‚ñº</span>
        </div>
        <div class="thought-content"></div>
      `;
        document.getElementById("chatMessages").appendChild(bubble);
        return bubble;
      }

      function updateThoughtBubble(type, payload) {
        if (!activeThoughtBubble) return;
        const content = activeThoughtBubble.querySelector(".thought-content");
        const status = activeThoughtBubble.querySelector(".thought-status");
        let stepHtml = "";

        if (type === "planning:plan:created") {
          status.textContent = `Planned ${payload.plan.steps.length} steps`;
          stepHtml = `<div class="thought-step"><span class="text-cyan-400">üìã</span><span>Plan created: ${payload.plan.goal}</span></div>`;
        } else if (type === "cortex:tool:call") {
          status.textContent = `Executing: ${payload.type}`;
          stepHtml = `<div class="thought-step"><span class="text-yellow-400">üõ†Ô∏è</span><span>Tool: ${payload.type}</span></div>`;
        } else if (type === "cortex:tool:result") {
          const icon = payload.result.ok ? "‚úÖ" : "‚ùå";
          stepHtml = `<div class="thought-step"><span>${icon}</span><span>Result: ${payload.result.ok ? "Success" : "Failed"}</span></div>`;
        }

        if (stepHtml) content.insertAdjacentHTML("beforeend", stepHtml);
      }

      // ========== SESSION MANAGEMENT ==========
      async function newSession(autoName = null) {
        let sessionName = autoName;
        if (!sessionName) {
          sessionName = await showModal(
            "New Session",
            "Enter a name for this session:",
            true,
            `Session ${new Date().toLocaleTimeString()}`,
          );
        }
        if (!sessionName) return;

        const sessionId =
          "session-" +
          Date.now() +
          "-" +
          Math.random().toString(36).substr(2, 9);
        currentSession = {
          id: sessionId,
          name: sessionName,
          created: new Date(),
          messages: [],
        };

        localStorage.setItem("tooloo_current_session_id", sessionId);
        localStorage.setItem(
          `tooloo_session_${sessionId}`,
          JSON.stringify(currentSession),
        );

        document.getElementById("chatMessages").innerHTML = "";
        loadSessions();
      }

      function loadSessions() {
        const sessions = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.startsWith("tooloo_session_")) {
            try {
              sessions.push(JSON.parse(localStorage.getItem(key)));
            } catch (e) {}
          }
        }
        sessions.sort((a, b) => new Date(b.created) - new Date(a.created));

        const sessionsHtml = sessions
          .map(
            (s) => `
          <div class="block px-4 py-2 text-xs ${s.id === currentSession?.id ? "text-white bg-white/5 border-l-2 border-cyan-500" : "text-gray-400 hover:text-white hover:bg-white/5 border-l-2 border-transparent"} cursor-pointer truncate" onclick="switchSession('${s.id}')">
            ${s.name}
          </div>
        `,
          )
          .join("");

        document.getElementById("sessionsList").innerHTML = sessionsHtml;
      }

      function switchSession(sessionId) {
        const savedSession = localStorage.getItem(
          `tooloo_session_${sessionId}`,
        );
        if (savedSession) {
          currentSession = JSON.parse(savedSession);
          localStorage.setItem("tooloo_current_session_id", sessionId);

          const chatContainer = document.getElementById("chatMessages");
          chatContainer.innerHTML = "";

          if (currentSession.messages) {
            currentSession.messages.forEach((msg) => {
              if (msg.type === "rich") {
                addRichMessage(
                  msg.role,
                  msg.text,
                  msg.provider,
                  false,
                  msg.confidence,
                  msg.sources,
                );
              } else {
                addMessage(msg.role, msg.text, false);
              }
            });
          }
          loadSessions(); // Update active state in sidebar
        }
      }

      // ========== MESSAGE HANDLING ==========
      async function sendMessage() {
        const input = document.getElementById("messageInput");
        const message = input.value.trim();
        if (!message) return;

        addMessage("user", message);
        input.value = "";
        input.style.height = "auto";

        const requestId = `req-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        activeRequestId = requestId;
        activeThoughtBubble = createThoughtBubble();

        try {
          const response = await fetch(`${API_BASE}/api/v1/chat/message`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              message: message,
              requestId: requestId,
              sessionId: currentSession?.id,
              projectId: currentProjectId,
              responseType: document.getElementById("responsePreference").value,
            }),
          });

          const data = await response.json();
          const responseData = data.data || data.content || data;
          const responseText = responseData.response || responseData.content || (typeof responseData === 'string' ? responseData : JSON.stringify(responseData));

          if (activeThoughtBubble) {
            activeThoughtBubble.classList.add("collapsed");
            activeThoughtBubble.querySelector(".thought-status").textContent =
              "Thinking Complete";
            activeThoughtBubble = null;
          }

          if (responseText) {
            addRichMessage(
              "assistant",
              responseText,
              responseData.provider || "System",
              true,
              responseData.confidence,
              responseData.sources,
            );
          } else {
            addMessage(
              "assistant",
              "Error: " + (responseData.error || "Unknown error"),
            );
          }
        } catch (err) {
          console.error(err);
          addMessage("assistant", "Failed to connect.");
        }
      }

      function addMessage(role, text, save = true) {
        const msg = document.createElement("div");
        msg.className = "flex gap-4 max-w-3xl mx-auto mb-6";

        const avatar = role === "user" ? "U" : "AI";
        const avatarClass =
          role === "user"
            ? "bg-gray-800 border-white/10"
            : "bg-cyan-500/20 border-cyan-500 text-cyan-400";
        const header = role === "user" ? "USER // NOW" : "TOOLOO // NOW";
        const headerClass = role === "user" ? "text-gray-500" : "text-cyan-400";

        msg.innerHTML = `
            <div class="w-8 h-8 rounded-full border flex items-center justify-center flex-shrink-0 text-xs ${avatarClass}">${avatar}</div>
            <div class="space-y-1 w-full">
                <div class="text-xs mono ${headerClass}">${header}</div>
                <div class="text-gray-300 leading-relaxed">${text}</div>
            </div>
        `;

        document.getElementById("chatMessages").appendChild(msg);
        document.getElementById("chatMessages").scrollTop =
          document.getElementById("chatMessages").scrollHeight;

        if (save && currentSession) {
          currentSession.messages.push({
            role,
            text,
            type: "text",
            timestamp: Date.now(),
          });
          localStorage.setItem(
            `tooloo_session_${currentSession.id}`,
            JSON.stringify(currentSession),
          );
        }
      }

      function addRichMessage(
        role,
        text,
        provider,
        save = true,
        confidence = 90,
        sources = [],
      ) {
        const msg = document.createElement("div");
        msg.className = "flex gap-4 max-w-3xl mx-auto mb-6";

        const formattedText = formatRichResponse(text);

        let sourcesHtml = "";
        if (sources && sources.length > 0) {
          sourcesHtml = `
                <div class="mt-4 pt-4 border-t border-white/10">
                    <div class="text-[10px] uppercase text-gray-500 font-bold mb-2">Sources</div>
                    ${sources
                      .map(
                        (s) => `
                        <div class="flex items-center gap-2 text-xs text-gray-400 mb-1">
                            <span class="text-cyan-400 mono">[${Math.round(s.relevance * 100)}%]</span>
                            <span class="truncate">${s.source}</span>
                        </div>
                    `,
                      )
                      .join("")}
                </div>
            `;
        }

        msg.innerHTML = `
            <div class="w-8 h-8 rounded-full bg-cyan-500/20 border border-cyan-500 flex items-center justify-center flex-shrink-0 text-cyan-400 text-xs">AI</div>
            <div class="space-y-2 w-full">
                <div class="flex items-center gap-2">
                    <span class="text-xs text-cyan-400 mono">TOOLOO // NOW</span>
                    <span class="text-[10px] px-1 rounded bg-gray-800 text-gray-400 border border-white/10">CONFIDENCE: ${confidence}%</span>
                </div>
                <div class="glass p-4 rounded-lg">
                    <div class="text-gray-300 space-y-4">${formattedText}</div>
                    ${sourcesHtml}
                </div>
            </div>
        `;

        document.getElementById("chatMessages").appendChild(msg);
        document.getElementById("chatMessages").scrollTop =
          document.getElementById("chatMessages").scrollHeight;

        try {
          setTimeout(
            () => mermaid.run({ nodes: msg.querySelectorAll(".mermaid") }),
            100,
          );
        } catch (e) {
          console.error("Mermaid render failed", e);
        }

        if (save && currentSession) {
          currentSession.messages.push({
            role,
            text,
            provider,
            type: "rich",
            timestamp: Date.now(),
            confidence,
            sources,
          });
          localStorage.setItem(
            `tooloo_session_${currentSession.id}`,
            JSON.stringify(currentSession),
          );
        }
      }

      // ========== MARKDOWN CONFIGURATION ==========
      // Initialize Highlight.js
      hljs.highlightAll();

      // Configure Marked
      const renderer = new marked.Renderer();

      renderer.code = function (code, language) {
        if (language === "mermaid") {
          return '<div class="mermaid">' + code + "</div>";
        }

        const validLanguage = hljs.getLanguage(language)
          ? language
          : "plaintext";
        try {
          const highlighted = hljs.highlight(code, {
            language: validLanguage,
          }).value;
          return (
            '<div class="bg-gray-950 p-4 rounded-lg border border-white/10 my-4 overflow-x-auto"><code class="hljs language-' +
            validLanguage +
            '">' +
            highlighted +
            "</code></div>"
          );
        } catch (e) {
          return (
            '<div class="bg-gray-950 p-4 rounded-lg border border-white/10 my-4 overflow-x-auto"><code>' +
            code +
            "</code></div>"
          );
        }
      };

      renderer.link = function (href, title, text) {
        return (
          '<a href="' +
          href +
          '" target="_blank" rel="noopener noreferrer" class="text-cyan-400 hover:underline" title="' +
          (title || "") +
          '">' +
          text +
          "</a>"
        );
      };

      renderer.heading = function (text, level) {
        const sizes = {
          1: "text-2xl font-bold text-white mt-6 mb-4 border-b border-white/10 pb-2",
          2: "text-xl font-bold text-white mt-5 mb-3",
          3: "text-lg font-bold text-cyan-300 mt-4 mb-2",
          4: "text-base font-bold text-gray-200 mt-3 mb-2",
        };
        const className = sizes[level] || sizes[4];
        return (
          "<h" +
          level +
          ' class="' +
          className +
          '">' +
          text +
          "</h" +
          level +
          ">"
        );
      };

      renderer.paragraph = function (text) {
        return '<p class="mb-3 text-gray-300 leading-relaxed">' + text + "</p>";
      };

      renderer.list = function (body, ordered, start) {
        const type = ordered ? "ol" : "ul";
        const className = ordered
          ? "list-decimal ml-5 mb-4 text-gray-300"
          : "list-disc ml-5 mb-4 text-gray-300";
        return (
          "<" + type + ' class="' + className + '">' + body + "</" + type + ">"
        );
      };

      marked.setOptions({
        renderer: renderer,
        gfm: true,
        breaks: true,
      });

      function formatRichResponse(text) {
        if (typeof text === 'object') {
          try {
            text = JSON.stringify(text, null, 2);
            return `<pre><code class="hljs language-json">${text}</code></pre>`;
          } catch (e) {
            text = "[Complex Object]";
          }
        }
        try {
          // Sanitize and parse
          const rawHtml = marked.parse(text || "");
          return DOMPurify.sanitize(rawHtml, {
            ADD_TAGS: ["div", "span", "code", "pre"],
            ADD_ATTR: ["class", "target", "rel"],
          });
        } catch (e) {
          console.error("Markdown parsing error:", e);
          return text;
        }
      }

      // ========== PROJECT MANAGEMENT ==========
      let currentProjectId = null;
      async function loadProjects() {
        try {
          const res = await fetch(`${API_BASE}/api/v1/projects`);
          const data = await res.json();
          const payload = data.content || data;
          if (payload.ok) {
            const select = document.getElementById("projectSelect");
            select.innerHTML = '<option value="">Select Project...</option>';
            payload.projects.forEach((p) => {
              const opt = document.createElement("option");
              opt.value = p.id;
              opt.textContent = p.name;
              select.appendChild(opt);
            });

            const savedId = localStorage.getItem("tooloo_current_project_id");
            if (savedId) selectProject(savedId);
          }
        } catch (e) {
          console.error(e);
        }
      }

      async function selectProject(id) {
        if (!id) {
          currentProjectId = null;
          document.getElementById("currentProjectName").textContent =
            "Select Project";
          return;
        }
        currentProjectId = id;
        localStorage.setItem("tooloo_current_project_id", id);
        document.getElementById("projectSelect").value = id;

        const select = document.getElementById("projectSelect");
        document.getElementById("currentProjectName").textContent =
          select.options[select.selectedIndex].text;

        // Load memory
        try {
          const res = await fetch(`${API_BASE}/api/v1/projects/${id}`);
          const data = await res.json();
          if (data.content?.memory) {
            document.getElementById("shortTermMemory").value =
              data.content.memory.shortTerm || "";
            document.getElementById("longTermMemory").value =
              data.content.memory.longTerm || "";
          }
        } catch (e) {}
      }

      async function saveProjectMemory() {
        if (!currentProjectId)
          return showModal("Error", "Select a project first.");
        const shortTerm = document.getElementById("shortTermMemory").value;
        const longTerm = document.getElementById("longTermMemory").value;

        await fetch(`${API_BASE}/api/v1/projects/${currentProjectId}/memory`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ type: "short-term", content: shortTerm }),
        });
        await fetch(`${API_BASE}/api/v1/projects/${currentProjectId}/memory`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ type: "long-term", content: longTerm }),
        });
        showModal("Success", "Memory saved.");
      }

      function showMemoryTab(type) {
        document.getElementById("memory-short").style.display =
          type === "short" ? "block" : "none";
        document.getElementById("memory-long").style.display =
          type === "long" ? "block" : "none";
      }

      // Modal Utils
      function showModal(title, message, hasInput = false, defaultValue = "") {
        return new Promise((resolve) => {
          const overlay = document.getElementById("g3-modal-overlay");
          overlay.querySelector(".modal-header").textContent = title;
          overlay.querySelector(".modal-body").textContent = message;
          const input = document.getElementById("modal-input");

          if (hasInput) {
            input.style.display = "block";
            input.value = defaultValue;
          } else {
            input.style.display = "none";
          }

          overlay.classList.remove("hidden");
          overlay.classList.add("flex");

          const close = (val) => {
            overlay.classList.add("hidden");
            overlay.classList.remove("flex");
            resolve(val);
          };

          document.getElementById("modal-cancel").onclick = () => close(null);
          document.getElementById("modal-ok").onclick = () =>
            close(hasInput ? input.value : true);
        });
      }
    </script>
  </body>
</html>
