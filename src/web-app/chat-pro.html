<!doctype html>
<!-- @version 2.1.242 -->
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TooLoo Pro ‚Ä¢ Creation Palette</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg-dark: #0f1117;
        --panel-bg: #161b22;
        --border: #30363d;
        --accent: #3b82f6;
      }
      body {
        background: var(--bg-dark);
        color: #e6edf3;
        font-family: "Inter", sans-serif;
        height: 100vh;
        overflow: hidden;
      }
      .mono {
        font-family: "JetBrains Mono", monospace;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .glass {
        background: rgba(22, 27, 34, 0.8);
        backdrop-filter: blur(12px);
      }

      /* Story Board Animations */
      @keyframes float {
        0% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-10px);
        }
        100% {
          transform: translateY(0px);
        }
      }
      .animate-float {
        animation: float 3s ease-in-out infinite;
      }

      /* Prompt Coach Indicators */
      .coach-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        transition: background-color 0.3s;
      }
      .coach-dot.red {
        background-color: #ef4444;
      }
      .coach-dot.yellow {
        background-color: #eab308;
      }
      .coach-dot.green {
        background-color: #22c55e;
      }
    </style>
  </head>
  <body class="flex h-full">
    <!-- 1. Media & Context Hub (Left) -->
    <aside
      class="w-64 border-r border-[#30363d] flex flex-col bg-[#161b22] transition-all duration-300"
      id="left-panel"
    >
      <div
        class="p-4 border-b border-[#30363d] font-semibold flex justify-between items-center"
      >
        <span>üìÇ Context</span>
        <button
          id="add-context-btn"
          class="text-xs bg-[#21262d] px-2 py-1 rounded hover:text-white text-gray-400"
        >
          + Add
        </button>
      </div>
      <div class="flex-1 overflow-y-auto p-2 space-y-2" id="context-list">
        <!-- Drag & Drop Zone -->
        <div
          id="drop-zone"
          class="border-2 border-dashed border-[#30363d] rounded-lg p-4 text-center text-sm text-gray-500 hover:border-[#3b82f6] transition-colors cursor-pointer"
        >
          Drop files, images, or code snippets here
        </div>
        <!-- Active Context Items will go here -->
      </div>
    </aside>

    <!-- 2. Generation Zone (Center) -->
    <main class="flex-1 flex flex-col relative">
      <!-- Mode Selector & Story Board (Top Bar) -->
      <header
        class="h-16 border-b border-[#30363d] flex items-center px-6 justify-between bg-[#0f1117]"
      >
        <div class="flex gap-1 bg-[#161b22] p-1 rounded-lg">
          <button
            class="mode-btn px-3 py-1 text-sm rounded bg-[#238636] text-white shadow-sm"
            data-mode="quick"
          >
            ‚ö° Quick
          </button>
          <button
            class="mode-btn px-3 py-1 text-sm rounded hover:bg-[#30363d] text-gray-400"
            data-mode="technical"
          >
            üî¨ Technical
          </button>
          <button
            class="mode-btn px-3 py-1 text-sm rounded hover:bg-[#30363d] text-gray-400"
            data-mode="creative"
          >
            üé® Creative
          </button>
          <button
            class="mode-btn px-3 py-1 text-sm rounded hover:bg-[#30363d] text-gray-400"
            data-mode="structured"
          >
            üìù Structured
          </button>
        </div>

        <!-- Visual Story Board Container -->
        <div id="story-board" class="flex items-center gap-3">
          <div id="story-icon" class="w-8 h-8 text-gray-500">
            <!-- SVG Icon injected by JS -->
          </div>
          <div id="story-text" class="text-sm text-gray-400 font-medium">
            Ready to create.
          </div>
        </div>
      </header>

      <!-- Chat/Output Area -->
      <div
        id="chat-container"
        class="flex-1 overflow-y-auto p-6 space-y-6 scroll-smooth"
      >
        <!-- Messages will be injected here -->
        <div class="flex gap-4 max-w-4xl mx-auto opacity-50">
          <div
            class="w-8 h-8 rounded bg-blue-600 flex items-center justify-center shrink-0 text-xs"
          >
            T
          </div>
          <div class="space-y-2">
            <div class="text-sm text-gray-400">TooLoo</div>
            <div class="prose prose-invert max-w-none text-sm">
              <p>Hello! I'm ready. Select a mode and start typing.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Input & Prompt Toolkit -->
      <div
        class="p-6 bg-gradient-to-t from-[#0f1117] via-[#0f1117] to-transparent"
      >
        <div
          class="max-w-4xl mx-auto bg-[#161b22] border border-[#30363d] rounded-xl shadow-2xl overflow-hidden relative transition-all duration-300 focus-within:ring-1 focus-within:ring-blue-500/50"
        >
          <!-- Prompt Coach Indicator -->
          <div
            id="coach-indicator"
            class="absolute top-3 right-3 flex items-center gap-2 opacity-0 transition-opacity duration-300"
          >
            <span
              id="coach-message"
              class="text-xs text-gray-500 bg-[#0f1117] px-2 py-1 rounded border border-[#30363d]"
            ></span>
            <div id="coach-dot" class="coach-dot bg-gray-500"></div>
          </div>

          <textarea
            id="user-input"
            class="w-full bg-transparent p-4 focus:outline-none min-h-[100px] resize-none text-sm leading-relaxed"
            placeholder="Describe your task or ask a question..."
          ></textarea>

          <div
            class="px-4 py-2 flex justify-between items-center bg-[#21262d]/50 border-t border-[#30363d]/50"
          >
            <div class="flex gap-2">
              <button
                class="text-gray-400 hover:text-white p-1 rounded hover:bg-[#30363d]"
                title="Attach File"
              >
                üìé
              </button>
              <button
                class="text-gray-400 hover:text-white p-1 rounded hover:bg-[#30363d]"
                title="Voice Input (Coming Soon)"
              >
                üéôÔ∏è
              </button>
            </div>
            <button
              id="send-btn"
              class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-1.5 rounded-lg text-sm font-medium transition-colors flex items-center gap-2"
            >
              <span>Generate</span>
              <span class="text-xs opacity-70">‚åò‚Üµ</span>
            </button>
          </div>
        </div>
      </div>
    </main>

    <!-- 3. Workflow & Orchestration (Right) -->
    <aside
      class="w-80 border-l border-[#30363d] bg-[#161b22] flex flex-col hidden md:flex"
      id="right-panel"
    >
      <div
        class="p-4 border-b border-[#30363d] font-semibold flex justify-between items-center"
      >
        <span>‚öôÔ∏è Insight</span>
        <div class="flex gap-1">
          <div
            class="w-2 h-2 rounded-full bg-green-500 animate-pulse"
            title="System Online"
          ></div>
        </div>
      </div>
      <div class="p-4 space-y-6 flex-1 overflow-y-auto">
        <!-- Agent Status -->
        <div>
          <div class="text-xs text-gray-500 uppercase font-bold mb-2">
            Agent Swarm
          </div>
          <div class="space-y-2" id="agent-status-list">
            <div
              class="flex justify-between text-sm p-2 bg-[#21262d] rounded border border-[#30363d]"
            >
              <span class="flex items-center gap-2"
                ><span class="w-2 h-2 rounded-full bg-gray-500"></span> Claude
                3.5</span
              >
              <span class="text-gray-500 text-xs">Idle</span>
            </div>
            <div
              class="flex justify-between text-sm p-2 bg-[#21262d] rounded border border-[#30363d]"
            >
              <span class="flex items-center gap-2"
                ><span class="w-2 h-2 rounded-full bg-gray-500"></span>
                GPT-4o</span
              >
              <span class="text-gray-500 text-xs">Idle</span>
            </div>
          </div>
        </div>

        <!-- Task DAG Visualization -->
        <div class="flex-1 flex flex-col">
          <div class="text-xs text-gray-500 uppercase font-bold mb-2">
            Execution Plan
          </div>
          <div
            id="plan-visualization"
            class="flex-1 border border-[#30363d] rounded bg-[#0d1117] p-2 space-y-2 overflow-y-auto min-h-[200px]"
          >
            <div class="text-center text-gray-600 text-xs mt-10">
              No active plan
            </div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Scripts -->
    <script src="js/story-board.js"></script>
    <script src="js/prompt-coach.js"></script>
    <script>
      // Main Application Logic
      const socket = io();
      const chatContainer = document.getElementById("chat-container");
      const userInput = document.getElementById("user-input");
      const sendBtn = document.getElementById("send-btn");
      const modeBtns = document.querySelectorAll(".mode-btn");
      let currentMode = "quick";

      // Mode Switching
      modeBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          modeBtns.forEach((b) => {
            b.classList.remove("bg-[#238636]", "text-white");
            b.classList.add("text-gray-400", "hover:bg-[#30363d]");
          });
          btn.classList.remove("text-gray-400", "hover:bg-[#30363d]");
          btn.classList.add("bg-[#238636]", "text-white");
          currentMode = btn.dataset.mode;

          // Update Story Board based on mode
          if (window.StoryBoard) {
            window.StoryBoard.setMode(currentMode);
          }
        });
      });

      // Send Message
      async function sendMessage() {
        const text = userInput.value.trim();
        if (!text) return;

        // Add User Message
        appendMessage("user", text);
        userInput.value = "";
        userInput.style.height = "auto";

        // Set Loading State
        if (window.StoryBoard) window.StoryBoard.setState("dreaming");

        try {
          const response = await fetch("/api/v1/chat/message", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              message: text,
              mode: currentMode,
              attachments: activeAttachments,
            }),
          });

          const data = await response.json();
          appendMessage("tooloo", data.response || "I've processed that.");

          if (window.StoryBoard) window.StoryBoard.setState("celebrating");
          setTimeout(() => {
            if (window.StoryBoard) window.StoryBoard.setState("listening");
          }, 3000);
        } catch (error) {
          console.error("Error:", error);
          appendMessage("tooloo", "Sorry, something went wrong.");
          if (window.StoryBoard) window.StoryBoard.setState("confused");
        }
      }

      sendBtn.addEventListener("click", sendMessage);
      userInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && (e.metaKey || e.ctrlKey)) {
          sendMessage();
        }
      });

      // Auto-resize textarea
      userInput.addEventListener("input", function () {
        this.style.height = "auto";
        this.style.height = this.scrollHeight + "px";
      });

      function appendMessage(role, text) {
        const div = document.createElement("div");
        div.className = "flex gap-4 max-w-4xl mx-auto animate-fade-in";

        const avatar =
          role === "user"
            ? `<div class="w-8 h-8 rounded bg-gray-600 flex items-center justify-center shrink-0 text-xs">U</div>`
            : `<div class="w-8 h-8 rounded bg-blue-600 flex items-center justify-center shrink-0 text-xs">T</div>`;

        div.innerHTML = `
                ${avatar}
                <div class="space-y-2 flex-1">
                    <div class="text-sm text-gray-400 capitalize">${role}</div>
                    <div class="prose prose-invert max-w-none text-sm whitespace-pre-wrap">${text}</div>
                </div>
            `;
        chatContainer.appendChild(div);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      // Socket Listeners for Orchestrator
      socket.on("orchestrator:update", (data) => {
        console.log("Orchestrator Update:", data);
        updatePlanVisualization(data.plan);

        // Update Story Board based on state
        if (data.state && window.StoryBoard) {
          // Map backend state to storyboard state
          let visualState = "listening";
          if (data.state === "planning") visualState = "dreaming";
          if (data.state.startsWith("executing")) visualState = "building";
          if (data.state === "idle") visualState = "listening";

          window.StoryBoard.setState(visualState, data.currentTask);
        }
      });

      function updatePlanVisualization(plan) {
        const container = document.getElementById("plan-visualization");
        if (!plan || plan.length === 0) {
          container.innerHTML =
            '<div class="text-center text-gray-600 text-xs mt-10">No active plan</div>';
          return;
        }

        container.innerHTML = plan
          .map(
            (task) => `
                <div class="p-2 rounded border ${task.status === "completed" ? "border-green-900 bg-green-900/20" : task.status === "active" ? "border-blue-500 bg-blue-900/20" : "border-[#30363d] bg-[#161b22]"}">
                    <div class="flex justify-between items-start">
                        <span class="text-xs font-medium ${task.status === "completed" ? "text-green-400" : "text-gray-300"}">${task.description}</span>
                        <span class="text-[10px] uppercase ${task.status === "active" ? "text-blue-400 animate-pulse" : "text-gray-600"}">${task.status}</span>
                    </div>
                </div>
            `,
          )
          .join("");
      }

      // Initialize Prompt Coach
      if (window.PromptCoach) {
        window.PromptCoach.init(
          userInput,
          document.getElementById("coach-indicator"),
        );
      }

      // File Upload Logic
      const dropZone = document.getElementById("drop-zone");
      const contextList = document.getElementById("context-list");
      let activeAttachments = [];

      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("border-blue-500", "bg-blue-900/20");
      });

      dropZone.addEventListener("dragleave", (e) => {
        e.preventDefault();
        dropZone.classList.remove("border-blue-500", "bg-blue-900/20");
      });

      dropZone.addEventListener("drop", async (e) => {
        e.preventDefault();
        dropZone.classList.remove("border-blue-500", "bg-blue-900/20");

        const files = e.dataTransfer.files;
        if (files.length === 0) return;

        for (const file of files) {
          await uploadFile(file);
        }
      });

      async function uploadFile(file) {
        // Optimistic UI
        const id = "temp-" + Date.now();
        const div = document.createElement("div");
        div.className =
          "p-2 bg-[#21262d] rounded text-sm flex items-center gap-2 animate-pulse";
        div.id = id;
        div.innerHTML = `<span class="text-blue-400">‚è≥</span> ${file.name}`;
        contextList.appendChild(div);

        const formData = new FormData();
        formData.append("file", file);

        try {
          const res = await fetch("/api/v1/context/upload", {
            method: "POST",
            body: formData,
          });
          const data = await res.json();

          // Update UI
          div.classList.remove("animate-pulse");
          div.innerHTML = `<span class="text-blue-400">üìÑ</span> ${data.originalName}`;

          activeAttachments.push(data);

          // Notify Coach
          if (window.PromptCoach) window.PromptCoach.analyze(); // Re-analyze with new context
        } catch (err) {
          console.error(err);
          div.innerHTML = `<span class="text-red-400">‚ùå</span> ${file.name} (Failed)`;
        }
      }
    </script>
  </body>
</html>
