name: TooLoo Synapsys CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - run: npm ci
      - run: npm run lint

  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - run: npm ci
      - run: npm run typecheck

  # P1.3: Wire Verification - Ensure frontend/backend API connections match
  wire-verify:
    runs-on: ubuntu-latest
    needs: [typecheck]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - run: npm ci
      - name: Verify Frontendâ†”Backend Wiring
        run: |
          echo "ðŸ”Œ Running wire verification..."
          npm run qa:check > wiring-report.json
          # Check coverage threshold (warn if below 80%)
          COVERAGE=$(cat wiring-report.json | node -e "const r=require('fs').readFileSync(0,'utf8'); const j=JSON.parse(r); console.log(j.coverage || 100)")
          echo "Wiring coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "âš ï¸ Warning: Wiring coverage is below 80%"
          fi
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: wiring-report
          path: wiring-report.json

  test:
    runs-on: ubuntu-latest
    needs: [lint, typecheck, wire-verify]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - run: npm ci
      - run: npm test

  fuzz:
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - run: npm ci
      - name: Start Server and Fuzz
        run: |
          npm run start:synapsys > /dev/null 2>&1 &
          timeout 60s bash -c 'until curl -s http://localhost:4000/api/v1/system/status > /dev/null; do sleep 1; done'
          npm run test:fuzz

  build:
    runs-on: ubuntu-latest
    needs: [fuzz]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - run: npm ci
      - run: npm run build:frontend
      - uses: actions/upload-artifact@v4
        with:
          name: build
          path: src/web-app/dist/
