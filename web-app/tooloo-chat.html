<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TooLoo.ai ‚Äì Chat</title>
<style>
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;background:#0f1420;color:#e8eef6;display:flex;flex-direction:column;height:100vh}
  header{padding:12px 16px;border-bottom:1px solid rgba(255,255,255,0.12);display:flex;gap:12px;align-items:center}
  a{color:#9ac6ff;text-decoration:none}
  .wrap{flex:1;display:flex;gap:12px;padding:12px;overflow:hidden}
  .pane{flex:1;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:12px;display:flex;flex-direction:column}
  .msgs{flex:1;overflow:auto;padding:12px}
  .msg{padding:8px 10px;margin:6px 0;border-radius:10px;max-width:72%}
  .me{background:#1d2736;margin-left:auto}
  .ai{background:#15202b}
  .sys{background:#0b1220;color:#9fb0c6;font-size:12px}
  form{display:flex;gap:8px;padding:10px;border-top:1px solid rgba(255,255,255,0.12)}
  input,button,textarea{font-family:inherit}
  textarea{flex:1;resize:none;border-radius:10px;border:1px solid rgba(255,255,255,0.18);background:#0b1220;color:#e8eef6;padding:10px;height:52px}
  button{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.2);background:#151f2c;color:#e8eef6}
  .side{width:300px}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.18);font-size:11px;margin-right:6px}
  .logo{font-weight:800}
  .note{padding:10px 12px;margin:8px;border-radius:10px;background:rgba(255,255,255,0.05);border:1px dashed rgba(255,255,255,0.18);font-size:12px;color:#9fb0c6}
</style>
</head>
<body>
  <header>
    <strong class="logo">üí¨ TooLoo Chat</strong>
    <span class="pill" id="policy">policy: ‚Äî</span>
    <span class="pill" id="mode">mode: ‚Äî</span>
    <span style="margin-left:auto"><a href="/control-room">‚Üê Control Room</a></span>
  </header>
  <div class="wrap">
    <div class="pane">
      <div class="msgs" id="msgs"></div>
      <form id="f">
        <textarea id="t" placeholder="Ask anything‚Ä¶"></textarea>
        <button type="submit">Send</button>
      </form>
    </div>
    <div class="pane side">
      <div class="msgs" id="side">
        <div class="note">Provider burst uses TTL cache by prompt. Try the same prompt twice to see cached hit.</div>
        <div class="note">Switch modes in Control Room to feel latency differences.</div>
      </div>
    </div>
  </div>
  <script>
    const $ = (id)=>document.getElementById(id);
    const msgs = $('msgs');
    const add = (cls, text)=>{ const d=document.createElement('div'); d.className=`msg ${cls}`; d.textContent=text; msgs.appendChild(d); msgs.scrollTop=msgs.scrollHeight; return d; };
    const safeJson = async (r)=>{ try{return await r.json();}catch{return null;} };
    const sid = (()=>{ try{ const k='tooloo.chat.sid'; let v=localStorage.getItem(k); if(!v){ v=Math.random().toString(36).slice(2,10); localStorage.setItem(k,v);} return v; }catch{ return 'default'; } })();
    async function refreshPolicy(){
      try{ const r = await fetch('/api/v1/providers/policy'); const j = await safeJson(r); if(j?.ok){ $('policy').textContent = `policy: ${j.policy.criticality}/${j.policy.maxConcurrency}`; } }catch{}
      try{ const s = await fetch('/system/status'); const j = await safeJson(s); $('mode').textContent = `mode: ${j?.autoCoach?.active? 'background':'chat'}`; }catch{}
    }
    refreshPolicy();
    setInterval(refreshPolicy, 4000);

    $('f').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const text = $('t').value.trim(); if(!text) return;
      $('t').value=''; add('me', text);
      // persist user message
      fetch('/api/v1/chat/append', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ sessionId: sid, role:'user', text }) }).catch(()=>{});
      // stream response
      try{
        const qs = new URLSearchParams({ prompt: text, ttlSeconds: '30' });
        const es = new EventSource('/api/v1/chat/burst-stream?'+qs.toString());
        const aiMsg = add('ai', '');
        let fullText = '';
        es.addEventListener('meta', (ev)=>{
          const m = JSON.parse(ev.data);
          if(m.cached){ const n=document.createElement('div'); n.className='msg sys'; n.textContent='cached response'; msgs.appendChild(n); msgs.scrollTop=msgs.scrollHeight; }
        });
        es.addEventListener('token', (ev)=>{
          const t = JSON.parse(ev.data);
          fullText += t.token;
          aiMsg.textContent = fullText;
          msgs.scrollTop = msgs.scrollHeight;
        });
        es.addEventListener('done', (ev)=>{
          const d = JSON.parse(ev.data);
          fullText = d.fullText;
          aiMsg.textContent = fullText;
          // persist assistant message
          fetch('/api/v1/chat/append', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ sessionId: sid, role:'assistant', text: fullText, meta:{} }) }).catch(()=>{});
          es.close();
        });
        es.onerror = ()=>{ es.close(); add('sys','Stream error'); };
      }catch(err){ add('sys','Network error: '+err.message); }
    });
  </script>
</body>
</html>
