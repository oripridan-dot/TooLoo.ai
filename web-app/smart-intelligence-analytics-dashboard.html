<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Intelligence Analytics Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      background: white;
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    h1 {
      font-size: 28px;
      color: #333;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #666;
      font-size: 14px;
    }

    .controls {
      display: flex;
      gap: 15px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    select, button {
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: white;
      color: #333;
    }

    select:hover, button:hover {
      border-color: #667eea;
      box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      font-weight: 600;
    }

    button:active {
      transform: scale(0.98);
    }

    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border-left: 4px solid #667eea;
    }

    .stat-label {
      color: #666;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #333;
      margin-bottom: 8px;
    }

    .stat-detail {
      color: #999;
      font-size: 12px;
    }

    .stat-card.critical {
      border-left-color: #ef4444;
    }

    .stat-card.high {
      border-left-color: #f97316;
    }

    .stat-card.moderate {
      border-left-color: #eab308;
    }

    .stat-card.success {
      border-left-color: #22c55e;
    }

    .chart-container {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .chart-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .distribution-chart {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
    }

    .distribution-bar {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .bar {
      width: 100%;
      height: 150px;
      background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
      border-radius: 6px 6px 0 0;
      margin-bottom: 10px;
      position: relative;
      min-height: 30px;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 12px;
      transition: all 0.3s ease;
    }

    .bar:hover {
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .bar.critical { background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%); }
    .bar.high { background: linear-gradient(180deg, #f97316 0%, #ea580c 100%); }
    .bar.moderate { background: linear-gradient(180deg, #eab308 0%, #ca8a04 100%); }
    .bar.low { background: linear-gradient(180deg, #3b82f6 0%, #1d4ed8 100%); }
    .bar.unverified { background: linear-gradient(180deg, #a1a1a1 0%, #787878 100%); }

    .bar.accept { background: linear-gradient(180deg, #22c55e 0%, #16a34a 100%); }
    .bar.caution { background: linear-gradient(180deg, #f97316 0%, #ea580c 100%); }
    .bar.review { background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%); }
    .bar.revise { background: linear-gradient(180deg, #991b1b 0%, #7c1d12 100%); }

    .bar-label {
      font-size: 12px;
      font-weight: 600;
      color: #333;
      text-align: center;
    }

    .bar-count {
      font-size: 11px;
      color: #666;
      margin-top: 3px;
    }

    .trend-chart {
      height: 250px;
      display: flex;
      align-items: flex-end;
      gap: 8px;
      margin-top: 20px;
    }

    .trend-point {
      flex: 1;
      background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
      border-radius: 4px 4px 0 0;
      min-height: 30px;
      position: relative;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      color: white;
      font-size: 11px;
      font-weight: 600;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .trend-point:hover {
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      transform: translateY(-2px);
    }

    .trend-label {
      position: absolute;
      bottom: -25px;
      font-size: 11px;
      color: #666;
      left: 50%;
      transform: translateX(-50%);
      white-space: nowrap;
    }

    .questions-list {
      list-style: none;
    }

    .question-item {
      padding: 15px;
      background: #f9f9f9;
      border-radius: 6px;
      margin-bottom: 10px;
      border-left: 3px solid #667eea;
    }

    .question-text {
      color: #333;
      font-size: 14px;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .question-count {
      display: inline-block;
      background: #667eea;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .spinner {
      border: 4px solid #f0f0f0;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .export-section {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .export-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .error-message {
      background: #fee;
      color: #c00;
      padding: 15px;
      border-radius: 6px;
      border-left: 4px solid #c00;
      margin-bottom: 20px;
    }

    .success-message {
      background: #efe;
      color: #060;
      padding: 15px;
      border-radius: 6px;
      border-left: 4px solid #060;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .dashboard {
        grid-template-columns: 1fr;
      }

      .distribution-chart {
        flex-wrap: wrap;
      }

      .distribution-bar {
        flex: 0 1 calc(50% - 8px);
      }

      .trend-chart {
        gap: 4px;
      }

      h1 {
        font-size: 22px;
      }

      .stat-value {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üìä Smart Intelligence Analytics Dashboard</h1>
      <p class="subtitle">Real-time validation metrics, confidence trends, and action statistics</p>
      
      <div class="controls">
        <div class="control-group">
          <label for="daysSelect">Time Range:</label>
          <select id="daysSelect">
            <option value="7">Last 7 days</option>
            <option value="14">Last 14 days</option>
            <option value="30" selected>Last 30 days</option>
            <option value="90">Last 90 days</option>
          </select>
        </div>
        <button id="refreshBtn">üîÑ Refresh Data</button>
        <button id="exportCsvBtn">‚¨áÔ∏è Export CSV</button>
        <button id="exportJsonBtn">‚¨áÔ∏è Export JSON</button>
      </div>
    </header>

    <div id="messages"></div>

    <!-- Key Metrics -->
    <div class="dashboard" id="statsGrid"></div>

    <!-- Confidence Distribution -->
    <div class="chart-container">
      <div class="chart-title">Confidence Distribution</div>
      <div class="distribution-chart" id="confidenceChart"></div>
    </div>

    <!-- Action Distribution -->
    <div class="chart-container">
      <div class="chart-title">Recommended Action Distribution</div>
      <div class="distribution-chart" id="actionChart"></div>
    </div>

    <!-- Confidence Trend -->
    <div class="chart-container">
      <div class="chart-title">Confidence Trend (Last 30 Days)</div>
      <div class="trend-chart" id="trendChart"></div>
    </div>

    <!-- Top Questions -->
    <div class="chart-container">
      <div class="chart-title">Top Validated Questions</div>
      <ul class="questions-list" id="questionsList"></ul>
    </div>

    <!-- Export Section -->
    <div class="export-section">
      <h3>üì¶ Export Data</h3>
      <p style="color: #666; margin-bottom: 15px;">Download validation patterns for external analysis or backup</p>
      <div class="export-buttons">
        <button id="exportCsvBtn2">üìÑ Export as CSV</button>
        <button id="exportJsonBtn2">üìã Export as JSON</button>
      </div>
    </div>
  </div>

  <script>
    // Use current domain for API calls (works in both local and Codespace)
    const API_BASE = `${window.location.protocol}//${window.location.host}`;
    let currentData = null;

    // Debounce function for refresh
    let refreshTimeout;
    function debounceRefresh() {
      clearTimeout(refreshTimeout);
      refreshTimeout = setTimeout(loadData, 300);
    }

    // Initialize
    document.getElementById('refreshBtn').addEventListener('click', loadData);
    document.getElementById('daysSelect').addEventListener('change', debounceRefresh);
    document.getElementById('exportCsvBtn').addEventListener('click', () => exportData('csv'));
    document.getElementById('exportJsonBtn').addEventListener('click', () => exportData('json'));
    document.getElementById('exportCsvBtn2').addEventListener('click', () => exportData('csv'));
    document.getElementById('exportJsonBtn2').addEventListener('click', () => exportData('json'));

    async function loadData() {
      const days = document.getElementById('daysSelect').value;
      showMessage('Loading analytics...', 'loading');

      try {
        // Load summary and trends in parallel
        const [summaryRes, trendRes, actionRes] = await Promise.all([
          fetch(`${API_BASE}/api/v1/smart-intelligence/analytics/summary?days=${days}`),
          fetch(`${API_BASE}/api/v1/smart-intelligence/analytics/trend?days=30`),
          fetch(`${API_BASE}/api/v1/smart-intelligence/analytics/actions?days=${days}`)
        ]);

        if (!summaryRes.ok || !trendRes.ok || !actionRes.ok) {
          throw new Error('Failed to load analytics data');
        }

        const summary = await summaryRes.json();
        const trend = await trendRes.json();
        const actions = await actionRes.json();

        currentData = { summary: summary.content.summary, trend: trend.content.trend, actions: actions.content.stats };

        if (!summary.content.summary) {
          showMessage('No validation patterns found yet. Start validating responses to see analytics.', 'info');
          return;
        }

        renderDashboard();
        showMessage('Analytics loaded successfully', 'success');

      } catch (error) {
        console.error('Data load error:', error);
        showMessage(`Error loading analytics: ${error.message}`, 'error');
      }
    }

    function renderDashboard() {
      if (!currentData?.summary) return;

      const summary = currentData.summary;

      // Render stats grid
      const statsHtml = `
        <div class="stat-card success">
          <div class="stat-label">Total Validations</div>
          <div class="stat-value">${summary.totalValidations}</div>
          <div class="stat-detail">patterns analyzed</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Average Confidence</div>
          <div class="stat-value">${summary.averageConfidence}%</div>
          <div class="stat-detail">across all validations</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Avg Insights Per Response</div>
          <div class="stat-value">${summary.averageInsights}</div>
          <div class="stat-detail">insights identified</div>
        </div>
        <div class="stat-card critical">
          <div class="stat-label">Avg Issues Per Response</div>
          <div class="stat-value">${summary.averageIssues}</div>
          <div class="stat-detail">issues found</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Avg Response Length</div>
          <div class="stat-value">${(summary.averageResponseLength / 100).toFixed(0)}00</div>
          <div class="stat-detail">characters</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Avg Processing Time</div>
          <div class="stat-value">${summary.processingTimeStats.average || 'N/A'}</div>
          <div class="stat-detail">milliseconds</div>
        </div>
      `;
      document.getElementById('statsGrid').innerHTML = statsHtml;

      // Render confidence distribution
      const confDist = summary.confidenceDistribution;
      const confMaxCount = Math.max(...Object.values(confDist));
      const confHtml = Object.entries(confDist)
        .map(([bracket, count]) => {
          const height = confMaxCount > 0 ? (count / confMaxCount) * 150 : 0;
          return `
            <div class="distribution-bar">
              <div class="bar ${bracket}" style="height: ${height}px; min-height: ${height === 0 ? '0' : '30px'};">
                ${count > 0 ? count : ''}
              </div>
              <div class="bar-label">${bracket.charAt(0).toUpperCase() + bracket.slice(1)}</div>
              <div class="bar-count">${count} patterns</div>
            </div>
          `;
        })
        .join('');
      document.getElementById('confidenceChart').innerHTML = confHtml;

      // Render action distribution
      const actionDist = summary.actionDistribution;
      const actionMaxCount = Math.max(...Object.values(actionDist));
      const actionHtml = Object.entries(actionDist)
        .map(([action, count]) => {
          const height = actionMaxCount > 0 ? (count / actionMaxCount) * 150 : 0;
          const actionKey = action.toLowerCase().replace(/\s+/g, '');
          return `
            <div class="distribution-bar">
              <div class="bar ${actionKey}" style="height: ${height}px; min-height: ${height === 0 ? '0' : '30px'};">
                ${count > 0 ? count : ''}
              </div>
              <div class="bar-label">${action.charAt(0).toUpperCase() + action.slice(1)}</div>
              <div class="bar-count">${count} patterns</div>
            </div>
          `;
        })
        .join('');
      document.getElementById('actionChart').innerHTML = actionHtml;

      // Render confidence trend
      if (currentData.trend) {
        const trendDates = Object.keys(currentData.trend).sort();
        const trendScores = Object.values(currentData.trend);
        const maxScore = Math.max(...trendScores);
        
        const trendHtml = trendDates
          .map(date => {
            const score = currentData.trend[date];
            const height = (score / maxScore) * 200;
            const dateObj = new Date(date);
            const dateLabel = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            return `
              <div class="trend-point" style="height: ${height}px;">
                <span style="position: absolute; bottom: 5px; font-size: 10px;">${score}</span>
                <div class="trend-label">${dateLabel}</div>
              </div>
            `;
          })
          .join('');
        document.getElementById('trendChart').innerHTML = trendHtml;
      }

      // Render top questions
      const questionsHtml = summary.topQuestions
        .map((item, idx) => `
          <li class="question-item">
            <div class="question-text">
              ${idx + 1}. ${item.question.substring(0, 100)}${item.question.length > 100 ? '...' : ''}
            </div>
            <span class="question-count">${item.count} validation${item.count !== 1 ? 's' : ''}</span>
          </li>
        `)
        .join('');
      document.getElementById('questionsList').innerHTML = questionsHtml || '<li class="question-item">No questions validated yet</li>';
    }

    async function exportData(format) {
      const days = document.getElementById('daysSelect').value;
      try {
        const url = `${API_BASE}/api/v1/smart-intelligence/analytics/export/${format}?days=${days}`;
        const response = await fetch(url);

        if (!response.ok) throw new Error(`Export failed with status ${response.status}`);

        const blob = await response.blob();
        const urlObj = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = urlObj;
        link.download = `validation-patterns-${new Date().toISOString().split('T')[0]}.${format}`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(urlObj);

        showMessage(`Data exported as ${format.toUpperCase()}`, 'success');
      } catch (error) {
        console.error('Export error:', error);
        showMessage(`Export failed: ${error.message}`, 'error');
      }
    }

    function showMessage(text, type = 'info') {
      const messagesDiv = document.getElementById('messages');
      let icon = '‚ÑπÔ∏è';
      let className = 'info';

      if (type === 'error') {
        icon = '‚ùå';
        className = 'error-message';
      } else if (type === 'success') {
        icon = '‚úÖ';
        className = 'success-message';
      } else if (type === 'loading') {
        icon = '<div class="spinner"></div>';
        className = 'loading';
      }

      if (type === 'loading') {
        messagesDiv.innerHTML = `<div class="${className}">${icon}<p>${text}</p></div>`;
      } else {
        messagesDiv.innerHTML = `<div class="${className}">${icon} ${text}</div>`;
      }

      if (type !== 'loading') {
        setTimeout(() => {
          messagesDiv.innerHTML = '';
        }, 5000);
      }
    }

    // Load data on page load
    loadData();
  </script>
</body>
</html>
