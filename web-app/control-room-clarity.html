<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TooLoo.ai – Design-Enhanced Control Room</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { 
      /* Enhanced Design System Tokens */
      --bg:#0B0D10; --surface:#14181E; --muted:#96A0AF; --text:#E6E9EE; --brand:#7C5CFF; --ok:#1fbf74; --warn:#ffbd2e; --bad:#ff5c7c;
      
      /* Advanced Color System (OKLCH-inspired) */
      --color-trust: #3b82f6; --color-growth: #10b981; --color-energy: #f59e0b; --color-premium: #7c5cff; --color-danger: #ef4444;
      
      /* Glass Morphism & Elevation */
      --surface-glass: rgba(255, 255, 255, 0.08); --surface-elevated: rgba(255, 255, 255, 0.12); --border-soft: rgba(255, 255, 255, 0.15);
      
      /* Motion Design Tokens */
      --ease-signature: cubic-bezier(0.34, 1.56, 0.64, 1); --ease-confident: cubic-bezier(0.4, 0, 0.2, 1); --ease-bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
      --duration-micro: 150ms; --duration-macro: 300ms; --duration-extended: 500ms;
      
      /* Typography System */
      --font-display: 'Playfair Display', serif; --font-body: 'Inter', system-ui, -apple-system, sans-serif;
      
      /* Spacing System (8px grid) */
      --space-1: 0.25rem; --space-2: 0.5rem; --space-3: 0.75rem; --space-4: 1rem; --space-6: 1.5rem; --space-8: 2rem; --space-12: 3rem;
    }
    
    /* Context Detection */
    @media (prefers-color-scheme: light) {
      :root { --bg: #f8fafc; --surface: #ffffff; --text: #0f172a; --muted: #64748b; }
    }
    @media (prefers-contrast: high) {
      :root { --surface-glass: rgba(255, 255, 255, 0.2); --border-soft: rgba(255, 255, 255, 0.3); }
    }
    
    * { box-sizing: border-box; }
    body { 
      margin:0; 
      font-family: var(--font-body); 
      background: radial-gradient(circle at top right, rgba(124, 92, 255, 0.15), transparent 50%), var(--bg); 
      color: var(--text);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    /* Enhanced Header with Glass Morphism */
    header { 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      padding: var(--space-4) var(--space-6); 
      background: linear-gradient(135deg, var(--surface-glass), rgba(20, 24, 30, 0.8));
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border-soft); 
      position: sticky; 
      top: 0; 
      z-index: 50;
      animation: slideDown var(--duration-extended) var(--ease-confident) both;
    }
    
    @keyframes slideDown {
      from { transform: translateY(-100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .brand-presence {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }
    
    .logo-mark {
      width: 32px;
      height: 32px;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--brand), var(--color-growth));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: white;
      animation: pulse-subtle 3s ease-in-out infinite;
    }
    
    @keyframes pulse-subtle {
      0%, 100% { transform: scale(1); box-shadow: 0 0 0 rgba(124, 92, 255, 0); }
      50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(124, 92, 255, 0.3); }
    }
    
    header h1 { 
      font-family: var(--font-display);
      font-size: 24px; 
      font-weight: 600;
      margin: 0; 
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, var(--text), var(--color-premium));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .header-subtitle {
      color: var(--muted);
      font-size: 14px;
      margin: 2px 0 0 0;
      font-weight: 500;
    }
    main { padding:20px; max-width:1200px; margin:0 auto; }
    .grid { display:grid; grid-template-columns: repeat(12, 1fr); gap:16px; }
    /* Enhanced Card System with Glass Morphism */
    .card { 
      background: linear-gradient(135deg, var(--surface-glass), rgba(20, 24, 30, 0.6));
      backdrop-filter: blur(16px);
      border: 1px solid var(--border-soft); 
      border-radius: 18px; 
      padding: var(--space-6);
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      transition: all var(--duration-macro) var(--ease-confident);
      animation: fadeInUp var(--duration-extended) var(--ease-signature) both;
    }
    
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 
        0 20px 40px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
      border-color: rgba(124, 92, 255, 0.3);
    }
    
    @keyframes fadeInUp {
      from { 
        opacity: 0; 
        transform: translateY(30px); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0); 
      }
    }
    
    /* Stagger animation delays */
    .card:nth-child(1) { animation-delay: 100ms; }
    .card:nth-child(2) { animation-delay: 200ms; }
    .card:nth-child(3) { animation-delay: 300ms; }
    .card:nth-child(4) { animation-delay: 400ms; }
    
    /* Grid System */
    .col-12{ grid-column: span 12; } .col-8{ grid-column: span 8; } .col-4{ grid-column: span 4; } .col-6{ grid-column: span 6; } .col-3{ grid-column: span 3; }
    /* Enhanced KPI System with Emotional States */
    .kpis { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
      gap: var(--space-4); 
    }
    
    .kpi { 
      background: linear-gradient(135deg, var(--surface-elevated), rgba(16, 21, 28, 0.8));
      border: 1px solid var(--border-soft); 
      border-radius: 16px; 
      padding: var(--space-4);
      position: relative;
      overflow: hidden;
      transition: all var(--duration-macro) var(--ease-confident);
    }
    
    .kpi::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--color-premium), var(--color-growth));
      opacity: 0;
      transition: opacity var(--duration-macro) var(--ease-confident);
    }
    
    .kpi:hover::before {
      opacity: 1;
    }
    
    .kpi:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 24px rgba(124, 92, 255, 0.15);
      border-color: rgba(124, 92, 255, 0.4);
    }
    
    .kpi h3 { 
      margin: 0 0 var(--space-2) 0; 
      font-size: 13px; 
      color: var(--muted); 
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .kpi .v { 
      font-size: 28px; 
      font-weight: 800;
      font-family: var(--font-display);
      background: linear-gradient(135deg, var(--text), var(--color-premium));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1.2;
    }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    /* Enhanced Pills with Contextual States */
    .pill { 
      padding: var(--space-2) var(--space-3); 
      border-radius: 999px; 
      font-size: 12px; 
      font-weight: 600;
      border: 1px solid var(--border-soft); 
      color: var(--text); 
      background: var(--surface-glass);
      backdrop-filter: blur(8px);
      transition: all var(--duration-micro) var(--ease-confident);
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
    }
    
    .pill:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .pill.interactive {
      cursor: pointer;
      text-decoration: none;
    }
    
    .pill.interactive:hover {
      background: var(--surface-elevated);
      border-color: var(--color-premium);
    }
    
    /* Contextual Status Colors */
    .ok { 
      color: var(--color-growth); 
      background: rgba(16, 185, 129, 0.1);
      border-color: rgba(16, 185, 129, 0.2);
    } 
    .warn { 
      color: var(--color-energy); 
      background: rgba(245, 158, 11, 0.1);
      border-color: rgba(245, 158, 11, 0.2);
    } 
    .bad { 
      color: var(--color-danger); 
      background: rgba(239, 68, 68, 0.1);
      border-color: rgba(239, 68, 68, 0.2);
    }
    .domains { display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; }
    .domain { background:#10151c; border:1px solid #1b2230; border-radius:10px; padding:12px; }
    .domain h4 { margin:0 0 8px 0; font-size:13px; font-weight:600; }
    .bar { height:8px; border-radius:6px; background:#1a2230; overflow:hidden; }
    .bar > i { display:block; height:100%; background: linear-gradient(90deg, #8b7dff, #00e9b0); }
    .muted { color:var(--muted); font-size:12px; }
    footer { color:#728097; font-size:12px; text-align:center; padding:12px; }
    .ts { color:#7b8794; font-size:11px; }
    .spark { height:32px; width:100%; display:block; }
    /* Enhanced Toast System */
    .toast { 
      position: fixed; 
      left: 50%; 
      bottom: var(--space-8); 
      transform: translateX(-50%) translateY(20px); 
      background: linear-gradient(135deg, var(--surface-glass), rgba(15, 21, 33, 0.9));
      backdrop-filter: blur(16px);
      border: 1px solid var(--border-soft); 
      color: var(--text); 
      padding: var(--space-4) var(--space-6); 
      border-radius: 16px; 
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.4);
      font-size: 14px;
      font-weight: 500;
      opacity: 0; 
      pointer-events: none; 
      transition: all var(--duration-macro) var(--ease-signature); 
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: var(--space-3);
      max-width: 400px;
      min-width: 200px;
    }
    
    .toast.show { 
      opacity: 1; 
      transform: translateX(-50%) translateY(0);
      animation: toastEntry var(--duration-extended) var(--ease-signature) both;
    }
    
    @keyframes toastEntry {
      0% {
        opacity: 0;
        transform: translateX(-50%) translateY(20px) scale(0.95);
      }
      60% {
        opacity: 1;
        transform: translateX(-50%) translateY(-5px) scale(1.02);
      }
      100% {
        opacity: 1;
        transform: translateX(-50%) translateY(0) scale(1);
      }
    }
    
    .toast-emoji {
      font-size: 18px;
      filter: drop-shadow(0 0 8px currentColor);
    }
    
    .toast-text {
      flex: 1;
      line-height: 1.4;
    }
    
    .toast.success { 
      border-color: rgba(16, 185, 129, 0.4);
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(15, 21, 33, 0.9));
      color: var(--color-growth);
    }
    
    .toast.error { 
      border-color: rgba(239, 68, 68, 0.4);
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(15, 21, 33, 0.9));
      color: var(--color-danger);
    }
    
    .toast.info { 
      border-color: rgba(59, 130, 246, 0.4);
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(15, 21, 33, 0.9));
      color: var(--color-trust);
    }
    /* Enhanced Ticker with Sophisticated Animation */
    .ticker { 
      position: relative; 
      height: 32px; 
      overflow: hidden; 
      border: 1px solid var(--border-soft); 
      border-radius: 12px; 
      background: linear-gradient(135deg, var(--surface-glass), rgba(14, 20, 32, 0.8));
      backdrop-filter: blur(8px);
      padding: var(--space-2) var(--space-3);
      display: flex;
      align-items: center;
    }
    
    .ticker .track { 
      position: absolute; 
      white-space: nowrap; 
      will-change: transform; 
      animation: ticker-scroll 25s linear infinite;
      display: flex;
      align-items: center;
      gap: var(--space-4);
    }
    
    @keyframes ticker-scroll { 
      from { transform: translateX(0); } 
      to { transform: translateX(-50%); } 
    }
    
    .tick-item { 
      color: var(--text); 
      margin-right: var(--space-6); 
      font-size: 13px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
    }
    
    .tick-item .ok { 
      color: var(--color-growth);
      filter: drop-shadow(0 0 4px rgba(16, 185, 129, 0.3));
    }
    .tick-item .bad { 
      color: var(--color-danger);
      filter: drop-shadow(0 0 4px rgba(239, 68, 68, 0.3));
    }
    
    /* Enhanced Button System */
    .btn-enhanced {
      padding: var(--space-3) var(--space-4);
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      background: linear-gradient(135deg, var(--surface-elevated), rgba(255, 255, 255, 0.05));
      color: var(--text);
      font-family: var(--font-body);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--duration-macro) var(--ease-signature);
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      text-decoration: none;
      backdrop-filter: blur(8px);
      position: relative;
      overflow: hidden;
    }
    
    .btn-enhanced::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.3), transparent);
      transition: all 0.5s ease;
      border-radius: 50%;
      transform: translate(-50%, -50%);
    }
    
    .btn-enhanced:hover::before {
      width: 300px;
      height: 300px;
    }
    
    .btn-enhanced:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }
    
    .btn-enhanced:active {
      transform: translateY(0);
      transition-duration: var(--duration-micro);
    }
    
    /* Contextual Button Variants */
    .btn-success {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.05));
      border-color: rgba(16, 185, 129, 0.3);
      color: var(--color-growth);
    }
    
    .btn-success:hover {
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.25);
      border-color: rgba(16, 185, 129, 0.5);
    }
    
    .btn-energy {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.05));
      border-color: rgba(245, 158, 11, 0.3);
      color: var(--color-energy);
    }
    
    .btn-energy:hover {
      box-shadow: 0 8px 25px rgba(245, 158, 11, 0.25);
      border-color: rgba(245, 158, 11, 0.5);
    }
    
    .btn-premium {
      background: linear-gradient(135deg, rgba(124, 92, 255, 0.2), rgba(124, 92, 255, 0.05));
      border-color: rgba(124, 92, 255, 0.3);
      color: var(--color-premium);
    }
    
    .btn-premium:hover {
      box-shadow: 0 8px 25px rgba(124, 92, 255, 0.25);
      border-color: rgba(124, 92, 255, 0.5);
    }
    
    .btn-neutral {
      background: linear-gradient(135deg, var(--surface-glass), rgba(100, 116, 139, 0.05));
      border-color: rgba(100, 116, 139, 0.2);
      color: var(--muted);
    }
    
    .btn-neutral:hover {
      box-shadow: 0 8px 25px rgba(100, 116, 139, 0.15);
      border-color: rgba(100, 116, 139, 0.4);
      color: var(--text);
    }
    
    /* Responsive Design Enhancements */
    @media (max-width: 768px) {
      .kpis {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .btn-enhanced {
        font-size: 13px;
        padding: var(--space-2) var(--space-3);
      }
      
      header h1 {
        font-size: 20px;
      }
      
      .logo-mark {
        width: 28px;
        height: 28px;
      }
    }
    
    /* Motion Preference Respect */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
      
      .card:hover {
        transform: none;
      }
      
      .btn-enhanced:hover {
        transform: none;
      }
      
      .logo-mark {
        animation: none;
      }
    }
  </style>
  <script>
    async function j(url){ const r = await fetch(url); if (!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
    function pct(n){ return Math.max(0, Math.min(100, Number(n||0))).toFixed(0)+'%'; }
    function el(id){ return document.getElementById(id); }
    function set(id, text){ const n=el(id); if(n) n.textContent = text; }
    function cls(elm, cond, c){ if (!elm) return; elm.classList.toggle(c, !!cond); }
    // Enhanced Toast System with Emotional Intelligence
    let _toastTimer = null;
    function showToast(msg, type='info', ttl=1400){ 
      const t = el('toast'); 
      if(!t) return; 
      
      // Enhance message with personality
      const enhancedMsg = enhanceToastMessage(msg, type);
      const emoji = getToastEmoji(type);
      
      t.className = `toast ${type || 'info'}`; 
      t.innerHTML = `<span class="toast-emoji">${emoji}</span><span class="toast-text">${enhancedMsg}</span>`; 
      t.classList.add('show'); 
      
      clearTimeout(_toastTimer); 
      _toastTimer = setTimeout(()=>{ 
        t.classList.remove('show'); 
      }, ttl); 
    }
    
    function enhanceToastMessage(msg, type) {
      const enhancements = {
        success: text => text.includes('!') ? text : `${text}! Looking great! 🎉`,
        error: text => text.includes('failed') ? `Hmm, ${text.toLowerCase()}. Let's try again! 💪` : text,
        info: text => text
      };
      return enhancements[type]?.(msg) || msg;
    }
    
    function getToastEmoji(type) {
      const emojis = {
        success: '✨',
        error: '⚠️',
        info: 'ℹ️'
      };
      return emojis[type] || 'ℹ️';
    }
    // Optional top-up control via query param (?topup=1)
    function shouldTopUp(){ try{ const q=new URLSearchParams(location.search); return q.get('topup')==='1'; }catch{return false;} }
    function renderDomains(list){ const c=el('domains'); c.innerHTML='';
      const byName = (a,b)=> String(a.name||'').localeCompare(String(b.name||''));
      (list||[]).sort(byName).forEach(d=>{
        const div=document.createElement('div'); div.className='domain';
        const m=Math.round(d.mastery||0); const conf=Math.round(d.confidence||0);
        div.innerHTML=`<h4>${d.name||d.topic}</h4>
          <div class='bar'><i style='width:${m}%;'></i></div>
          <div class='row muted'><span>Mastery: <b>${m}%</b></span><span>Confidence: ${conf}%</span><span>Attempts: ${d.attempts||0}</span>${d.background?'<span class="pill">Background</span>':''}</div>`;
        c.appendChild(div);
      });
    }
  async function drawSpark(){ try{ const perf = await j('/api/v1/reports/performance?recentWindow=50'); const s = perf?.series?.progress||[]; const c = document.getElementById('spark'); if(!c) return; const ctx=c.getContext('2d'); const W=c.width=c.clientWidth; const H=c.height=c.clientHeight; ctx.clearRect(0,0,W,H); const pad=4; const xs=(i)=> pad + (W-2*pad) * (i/Math.max(1,s.length-1)); const ys=(v)=> H-pad - (H-2*pad)*(v/100); ctx.strokeStyle='#7C5CFF'; ctx.lineWidth=1.5; ctx.beginPath(); s.forEach((p,i)=>{ const x=xs(i), y=ys(p.v||0); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }); ctx.stroke(); }catch(e){} }
  async function resetAndSprint(){
    try{
      if(!confirm('Reset capabilities and run a fast sprint?')) return;
      // Reset
      await fetch('/api/v1/capabilities/reset', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ autoStart:false }) });
      // First sprint (aggressive)
      await fetch('/api/v1/capabilities/sprint', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ mode:'aggressive', maxConcurrency:80 }) });
      // Optional quick top-up to push toward 100%
      if (shouldTopUp()){
        try{
          const st = await j('/api/v1/capabilities/status');
          const pending = Number(st?.activation?.totalPending||0);
          if (pending>0){
            await fetch('/api/v1/capabilities/sprint', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ mode:'production', maxConcurrency:40 }) });
          }
        }catch{}
      }
      showToast('Reset complete • Sprint started • Opening Dashboard…','success', 1200);
      setTimeout(()=>{ window.location.href = '/capabilities-dashboard'; }, 1200);
    }catch(e){ showToast('Action failed','error', 1600); }
  }
  async function refresh(){
      const ts = new Date().toLocaleTimeString(); set('ts', ts);
      try {
        const [train, providers, budget, sys, coach, meta, caps, auto, perf] = await Promise.all([
          j('/api/v1/training/overview'),
          j('/api/v1/providers/status').catch(()=>({})),
          j('/api/v1/budget').catch(()=>({})),
          j('/system/status').catch(()=>({})),
          j('/api/v1/auto-coach/status').catch(()=>({})),
          j('/api/v4/meta-learning/status').catch(()=>({})),
          j('/api/v1/capabilities/status').catch(()=>({})),
          j('/api/v1/capabilities/auto/status').catch(()=>({})),
          j('/api/v1/reports/performance?recentWindow=50').catch(()=>({}))
        ]);

        const data = train?.data || {};
        const domains = Array.isArray(data.domains)? data.domains : [];
        const avg = domains.length? Math.round(domains.reduce((s,d)=>s+(d.mastery||0),0)/domains.length) : 0;
        const weakest = domains.slice().sort((a,b)=>(a.mastery||0)-(b.mastery||0))[0] || null;
        set('avg', pct(avg));
        set('weakestName', weakest? (weakest.name||weakest.topic): '—');
        set('weakestVal', weakest? pct(weakest.mastery): '—');
        const next = (data.nextUpTargets||[])[0] || null;
        set('nextName', next? (next.name||next.topic): '—');
        set('nextVal', next? pct(next.mastery): '—');
        renderDomains(domains);

        // Selection & rounds
        const sel = data.selection || {}; set('threshold', sel.targetThreshold!=null? sel.targetThreshold+'%' : '—');
        // Coach/meta
        const coachOn = coach?.status?.active || false; set('coach', coachOn? 'On' : 'Off');
        const readyPct = Math.round(((meta?.status?.readiness)||0)*100); set('meta', isFinite(readyPct)? readyPct+'%' : '—');
        // Budget/providers
        const budgetStr = budget?.budget? (`$${Number(budget.budget.spent||0).toFixed(2)}/$${Number(budget.budget.limit||0).toFixed(2)}`) : '—';
        set('budget', budgetStr);
        const available = Object.values(providers?.status||providers||{}).filter(s=>s?.available && s?.enabled).length;
        set('providers', available>0? String(available)+' up' : '—');
        // Enhanced Services health with personality
        const svc = sys?.services || {}; 
        const allUp = ['training','meta','budget','coach','cup'].every(k=> svc[k]);
        const health = el('health'); 
        if (health) {
          if (allUp) {
            health.innerHTML = '✨ Everything Perfect';
            health.className = 'pill ok';
          } else {
            health.innerHTML = '⚠️ Some Issues';
            health.className = 'pill warn';
          }
        }
        
        const capsHealthEl = el('capsHealth'); 
        if (capsHealthEl) {
          if (svc.capabilities) {
            capsHealthEl.innerHTML = '⚡ Active';
            capsHealthEl.className = 'pill ok';
          } else {
            capsHealthEl.innerHTML = '⏸️ Down';
            capsHealthEl.className = 'pill bad';
          }
        }

        // Capabilities KPIs (optional)
        if (caps?.activation){
          set('capsProgress', (caps.activation.progress||0)+'%');
          set('capsPerf', (caps.activation.performanceImpact?.estimatedPerformanceGain||0)+'%');
        }
        if (auto?.auto){
          set('autoStatus', auto.auto.enabled? 'On' : 'Off');
          set('autoCycles', String(auto.auto.cycles||0));
        }
        // Sparkline of recent progress
        drawSpark();
        // Recent success KPI
        if (perf?.summary){
          const v = perf.summary.recentSuccessRate;
          const elKpi = document.getElementById('recentSuccessKpi');
          if (elKpi) elKpi.textContent = isFinite(v)? (v+'%') : '—';
        }
        // Mini recent activations ticker
        if (caps?.activation){
          renderTicker(caps.activation);
        }
      } catch(e){ const health = el('health'); health.textContent='Status refresh failed'; cls(health, true, 'bad'); }
    }
    // Enhanced initialization with personality
    document.addEventListener('DOMContentLoaded', ()=>{
      // Add contextual theming detection
      detectAndApplyContext();
      
      // Initial load with sophisticated feedback
      showToast('🚀 TooLoo Control Room Enhanced', 'info', 2000);
      
      // Start data refresh cycle
      refresh(); 
      setInterval(refresh, 5000);
      
      // Add subtle parallax effect on scroll
      window.addEventListener('scroll', handleParallax, { passive: true });
    });
    
    function detectAndApplyContext() {
      const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const isHighContrast = window.matchMedia('(prefers-contrast: high)').matches;
      const reduceMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      
      document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
      document.documentElement.setAttribute('data-contrast', isHighContrast ? 'high' : 'normal');
      document.documentElement.setAttribute('data-motion', reduceMotion ? 'reduced' : 'full');
    }
    
    function handleParallax() {
      const scrolled = window.pageYOffset;
      const parallaxElements = document.querySelectorAll('.card');
      
      if (document.documentElement.getAttribute('data-motion') !== 'reduced') {
        parallaxElements.forEach((el, i) => {
          const speed = 0.1 + (i * 0.05);
          el.style.transform = `translateY(${scrolled * speed}px)`;
        });
      }
    }
    // Ticker renderer
    function renderTicker(activation){ try{
      const t = el('capsTicker'); if(!t) return;
      const recent = (activation?.recentActivations||[]).slice(-12);
      if (!recent.length){ t.innerHTML = '<span class="muted">No recent activations</span>'; return; }
      const toItem = a=> `<span class="tick-item">${(a.component||'comp')}.${(a.method||'func')} <span class="${a.success?'ok':'bad'}">${a.success?'✓':'✗'}</span></span>`;
      const content = recent.map(toItem).join('<span class="muted">•</span>');
      // Duplicate content to enable seamless marquee effect
      t.innerHTML = `<div class="track">${content} <span class="muted">•</span> ${content}</div>`;
    }catch(e){}
    }
  </script>
</head>
<body>
  <div id="toast" class="toast"></div>
  <header>
    <div class="brand-presence">
      <div class="logo-mark" title="TooLoo.ai">T</div>
      <div>
        <h1>TooLoo Design-Enhanced Control Room</h1>
        <p class="header-subtitle">Everything's running beautifully! <small id="ts" class="ts"></small></p>
      </div>
    </div>
    <div class="row">
      <a href="/knowledge" class="pill interactive" style="text-decoration:none;">📚 Knowledge</a>
      <a href="/segmentation" class="pill interactive" style="text-decoration:none;">🧩 Segmentation</a>
      <a href="/capabilities" class="pill interactive" style="text-decoration:none;">⚡ Capabilities</a>
      <span id="health" class="pill">🔄 Loading…</span>
    </div>
  </header>
  <main>
    <div class="grid">
      <div class="col-12 card">
        <div class="kpis">
          <div class="kpi"><h3>Average Mastery</h3><div id="avg" class="v">—</div></div>
          <div class="kpi"><h3>Weakest Domain</h3><div class="v"><span id="weakestName">—</span> <span class="muted" id="weakestVal"></span></div></div>
          <div class="kpi"><h3>Next Up</h3><div class="v"><span id="nextName">—</span> <span class="muted" id="nextVal"></span></div></div>
          <div class="kpi"><h3>Target Threshold</h3><div id="threshold" class="v">—</div></div>
          <div class="kpi"><h3>Auto‑Coach</h3><div id="coach" class="v">—</div></div>
          <div class="kpi"><h3>Meta‑Learning Readiness</h3><div id="meta" class="v">—</div></div>
          <div class="kpi"><h3>Capabilities Progress</h3><div id="capsProgress" class="v">—</div></div>
          <div class="kpi"><h3>Perf Gain (est.)</h3><div id="capsPerf" class="v">—</div></div>
          <div class="kpi"><h3>Recent Success (last 50)</h3><div id="recentSuccessKpi" class="v">—</div></div>
          <div class="kpi"><h3>Auto‑Activate</h3><div class="v"><span id="autoStatus">—</span> <span class="muted" id="autoCycles"></span></div></div>
          <div class="kpi"><h3>Activation Spark</h3><canvas id="spark" class="spark"></canvas></div>
          <div class="kpi"><h3>Recent Activations</h3><div id="capsTicker" class="ticker"><span class="muted">—</span></div></div>
        </div>
      </div>

      <div class="col-8 card">
        <h3 style="margin:0 0 8px 0; font-size:14px;">Domains</h3>
        <div id="domains" class="domains"></div>
      </div>
      <div class="col-4 card">
        <h3 style="margin:0 0 8px 0; font-size:14px;">System</h3>
        <div class="row" style="margin:8px 0;">
          <span class="pill">Providers: <b id="providers">—</b></span>
          <span class="pill">Budget: <b id="budget">—</b></span>
          <span class="pill">Capabilities: <b id="capsHealth">—</b></span>
          <a href="/capabilities-dashboard" class="pill" style="text-decoration:none;">Capabilities Dashboard →</a>
        </div>
        <p class="muted">This page is read‑mostly. Use Capability Activation for detailed controls. Quick actions:</p>
        <div class="row">
          <button class="btn-enhanced btn-success" onclick="fetch('/api/v1/capabilities/auto/start', {method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ intervalMs: 2000, mode: 'production', maxPerCycle: 8, maxPerComponent: 3, sequencing: 'intelligent' })}).then(()=>setTimeout(refresh,500))">▶️ Start Auto</button>
          <button class="btn-enhanced btn-neutral" onclick="fetch('/api/v1/capabilities/auto/stop', {method:'POST'}).then(()=>setTimeout(refresh,500))">⏹️ Stop Auto</button>
          <button class="btn-enhanced btn-energy" onclick="(async()=>{ try{ const st=await j('/api/v1/capabilities/status'); if((st?.activation?.progress||0)>=100){ showToast('Already at 100%! 🎉', 'success'); return;} if(!confirm('Run Auto Sprint (5 fast cycles)?')) return; const r=await fetch('/api/v1/capabilities/auto/sprint', {method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ cycles:5, mode:'aggressive', maxPerCycle:100, maxPerComponent:30, intervalMs:500 })}); const jx=await r.json(); showToast(jx?.ok? ('Auto Sprint complete: +'+(jx.autoSprint?.activatedDelta||0)) : 'Auto Sprint failed', jx?.ok ? 'success' : 'error'); setTimeout(refresh, 700); }catch(e){ showToast('Auto Sprint failed', 'error'); } })()">🚀 Auto Sprint</button>
          <button class="btn-enhanced btn-premium" onclick="resetAndSprint()">✨ Reset + Sprint →</button>
          <a href="/capabilities" class="pill interactive" style="text-decoration:none;">⚡ Go to Capabilities →</a>
        </div>
      </div>

      <div class="col-12 card">
        <h3 style="margin:0 0 8px 0; font-size:14px;">Capabilities Overview</h3>
        <div id="capsContainer" class="row" style="gap:10px; flex-wrap:wrap;"></div>
        <div id="capsRecent" class="muted" style="margin-top:8px;"></div>
        <script>
          function renderCaps(status){
            const c = document.getElementById('capsContainer'); if(!c) return; c.innerHTML='';
            const act = status?.activation; if(!act) return;
            const comps = act.components || {};
            const entries = Object.entries(comps);
            entries.forEach(([name, s])=>{
              const wrap = document.createElement('div'); wrap.className='domain'; wrap.style.minWidth='180px'; wrap.style.flex='1 1 180px';
              const prog = s.discovered>0? Math.round((s.activated||0)/s.discovered*100) : 0;
              wrap.innerHTML = `<h4 style="text-transform:capitalize;">${name.replace(/([A-Z])/g,' $1').trim()}</h4>
                <div class='bar'><i style='width:${prog}%;'></i></div>
                <div class='row muted'><span>Active: <b>${s.activated}/${s.discovered}</b></span><span>Failed: ${s.failed||0}</span></div>`;
              c.appendChild(wrap);
            });
            const recent = (act.recentActivations||[]).slice(-10).map(a=>`[${new Date(a.timestamp).toLocaleTimeString()}] ${a.component}.${a.method} ${a.success?'✅':'❌'}`).join(' · ');
            const rc = document.getElementById('capsRecent'); if(rc) rc.textContent = recent || 'No recent activations';
          }
          // augment refresh hook
          const _oldRefresh = refresh;
          refresh = async function(){
            await _oldRefresh();
            try{ const st = await j('/api/v1/capabilities/status'); renderCaps(st); }catch{}
          };
        </script>
      </div>
    </div>
  </main>
  <footer>
    Live metrics auto‑refresh every 5s
  </footer>
</body>
</html>