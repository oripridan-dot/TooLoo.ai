<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TooLoo.ai â€“ Control Room Home</title>
<style>
  *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;background:linear-gradient(135deg,#0f1420,#121827);color:#e8eef6}
  .wrap{max-width:1120px;margin:0 auto;padding:16px}
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  .logo{font-weight:800;font-size:18px;background:linear-gradient(45deg,#00e9b0,#7c5cff);background-clip:text;-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px}
  .card{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:12px;padding:14px}
  .title{font-size:12px;color:#b7c3d6;text-transform:uppercase;letter-spacing:.4px;margin-bottom:6px}
  .value{font-size:28px;font-weight:800;color:#00e9b0}
  .sub{font-size:11px;color:#9fb0c6;margin-top:4px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .pill{padding:4px 10px;border-radius:999px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.18);font-size:11px}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .btn{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.2);background:rgba(0,0,0,0.2);color:#e8eef6;text-decoration:none;font-weight:600}
  .btn.primary{background:#151f2c;border-color:#2a3a52}
  .nav{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-top:14px}
  .nav a{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:12px;padding:14px;text-decoration:none;color:#e8eef6;display:block}
  .nav a:hover{background:rgba(255,255,255,0.1)}
  .dots{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px}
  .ok{background:#00ff88}.bad{background:#ff5c7c}
</style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="logo">ðŸ§  TooLoo.ai Control Room</div>
      <div class="row">
        <span class="pill" id="modePill">Mode: â€”</span>
        <span class="pill" id="policyPill">Policy: â€”</span>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="title">Services</div>
        <div class="row" id="svcRow">Checkingâ€¦</div>
        <div class="sub" id="svcPorts">â€”</div>
      </div>
      <div class="card">
        <a href="/tooloo-chat">TooLoo Chat</a>
        <div class="value" id="avgMastery">â€”</div>
        <div class="sub" id="nextDomain">â€”</div>
        <div class="sub" id="masterySpark"> </div>
      </div>
      <div class="card">
        <div class="title">Autoâ€‘Coach</div>
        <div class="value" id="coachStatus">â€”</div>
        <div class="sub" id="fastLane">â€”</div>
        <div class="actions">
          <button class="btn" id="chatPriorityBtn">ðŸ’¬ Chat Priority</button>
          <button class="btn" id="bgPriorityBtn">ðŸŒ™ Background</button>
        </div>
      </div>
      <div class="card">
        <div class="title">Provider Policy</div>
        <div class="value" id="policyValue">â€”</div>
        <div class="sub">Criticality & maxConcurrency used by bursts</div>
      </div>
      <div class="card">
        <div class="title">Orchestrator</div>
        <div class="value" id="orchStatus">â€”</div>
        <div class="sub" id="orchPid">PID: â€”</div>
        <div class="actions">
          <button class="btn" id="orchStartBtn">Start</button>
          <button class="btn" id="orchStopBtn">Stop</button>
        </div>
      </div>
    </div>

    <div class="nav">
      <a href="/tooloo-chat">Tooloo Chat</a>
      <a href="/control-room/advanced">Advanced Control Room</a>
      <a href="/segmentation">Segmentation Demo</a>
      <a href="/capabilities-dashboard">Capabilities Dashboard</a>
      <a href="/design-suite">Design Suite</a>
      <a href="/tooloo-showcase">Showcase</a>
      <a href="/temp/index">Artifacts</a>
    </div>

    <div style="margin-top:20px;padding-top:14px;border-top:1px solid rgba(255,255,255,0.1);font-size:11px;color:#9fb0c6;display:flex;gap:16px;flex-wrap:wrap">
      <a href="/feedback" style="color:#00e9b0;text-decoration:none">ðŸ’¬ Send Feedback</a>
      <a href="/BETA-DISCLAIMER.html" style="color:#00e9b0;text-decoration:none">Beta Disclaimer</a>
      <a href="/TERMS-OF-SERVICE.html" style="color:#00e9b0;text-decoration:none">Terms of Service</a>
      <a href="/PRIVACY-POLICY.html" style="color:#00e9b0;text-decoration:none">Privacy Policy</a>
    </div>
  </div>
  <script>
    const $ = (id) => document.getElementById(id);
    
    // Enhanced JSON parsing with error logging
    const safeJson = async (res) => { 
      try { 
        return await res.json(); 
      } catch (e) { 
        console.error('JSON parse error:', e);
        return null; 
      } 
    };

    // Error handler for user feedback
    const showError = (element, message) => {
      if (element) {
        element.textContent = message;
        element.style.color = '#ff5c7c';
      }
      console.error('[TooLoo]', message);
    };

    async function loadStatus(){
      try{
        // System status
        try{
          const s = await fetch('/system/status', { signal: AbortSignal.timeout(5000) });
          if (!s.ok) throw new Error(`HTTP ${s.status}`);
          const j = await safeJson(s);
          if(j?.ok){
            const svcs = j.services||{};
            const dot = (ok)=>`<span class="dots ${ok?'ok':'bad'}"></span>`;
            $('svcRow').innerHTML = `Web ${dot(true)} Training ${dot(svcs.training)} Meta ${dot(svcs.meta)} Budget ${dot(svcs.budget)} Coach ${dot(svcs.coach)}`;
            $('svcPorts').textContent = `Ports: web ${j.ports.web}, training ${j.ports.training}, budget ${j.ports.budget}, coach ${j.ports.coach}`;
            $('coachStatus').textContent = j.autoCoach?.active? 'On':'Off';
            $('orchStatus').textContent = j.orchestrator?.running ? 'Running' : 'Stopped';
            $('orchPid').textContent = `PID: ${j.orchestrator?.pid||'â€”'}`;
          }else{
            showError($('svcRow'), 'System status unavailable');
          }
        }catch(e){
          console.warn('System status fetch failed:', e.message);
          $('svcRow').textContent = 'Status check failed';
        }

        // Provider policy
        try{
          const p = await fetch('/api/v1/providers/policy', { signal: AbortSignal.timeout(5000) });
          if (p.ok) {
            const pj = await safeJson(p);
            if(pj?.ok){
              $('policyPill').textContent = `Policy: ${pj.policy.criticality} â€¢ ${pj.policy.maxConcurrency}`;
              $('policyValue').textContent = `${pj.policy.criticality.toUpperCase()} â€¢ ${pj.policy.maxConcurrency}`;
            }
          }
        }catch(e){
          console.warn('Provider policy fetch failed:', e.message);
        }

        // Training overview and next domain
        try{
          const [oRes, ndRes] = await Promise.all([
            fetch('/api/v1/training/overview', { signal: AbortSignal.timeout(5000) }),
            fetch('/api/v1/next-domain', { signal: AbortSignal.timeout(5000) })
          ]);
          
          if (oRes.ok) {
            const oj = await safeJson(oRes);
            if(oj?.ok){
              const domains = oj.data?.domains||[];
              const avg = domains.length? Math.round(domains.reduce((a,d)=>a+d.mastery,0)/domains.length):0;
              $('avgMastery').textContent = `${avg}%`;
              if(domains.length){
                $('masterySpark').innerHTML = domains.map(d=>`<span style="display:inline-block;width:22px;height:18px;margin-right:2px;background:linear-gradient(180deg,#00e9b0 ${(100-d.mastery)}%,#7c5cff ${d.mastery}%);border-radius:4px;text-align:center;font-size:10px;color:#fff;vertical-align:bottom;" title="${d.domain}: ${d.mastery}%">${d.mastery}</span>`).join('');
              }
            }
          }
          
          if (ndRes.ok) {
            const nd = await safeJson(ndRes);
            if(nd?.ok){ 
              $('nextDomain').textContent = `Next: ${nd.next.domain} â€¢ readiness ${nd.next.readiness}%`;
            }
          }
        }catch(e){
          console.warn('Training data fetch failed:', e.message);
          $('avgMastery').textContent = 'â€”';
        }

        // Auto-coach status
        try{
          const ac = await fetch('/api/v1/auto-coach/status', { signal: AbortSignal.timeout(5000) });
          if (ac.ok) {
            const aj = await safeJson(ac);
            if (aj?.status?.thresholds) {
              const th = aj.status.thresholds;
              const fl = th.fastLane?.enabled? 'On':'Off';
              $('fastLane').textContent = `Fast Lane: ${fl} â€¢ Î¼ ${th.microBatchesPerTick||1} â€¢ B ${th.batchSize||1}`;
            }
          }
        }catch(e){
          console.warn('Auto-coach status fetch failed:', e.message);
        }
      }catch(e){
        console.error('Load status error:', e);
      }
    }

    // Priority mode handlers with feedback
    $('chatPriorityBtn').addEventListener('click', async ()=>{
      try{ 
        const res = await fetch('/api/v1/system/priority/chat', { method:'POST', signal: AbortSignal.timeout(5000) });
        if (res.ok) {
          loadStatus(); 
          $('modePill').textContent='Mode: Chat';
        } else {
          showError($('modePill'), 'Failed to set chat priority');
        }
      }catch(e){
        showError($('modePill'), 'Error setting priority');
        console.error(e);
      }
    });

    $('bgPriorityBtn').addEventListener('click', async ()=>{
      try{
        const res = await fetch('/api/v1/system/priority/background', { method:'POST', signal: AbortSignal.timeout(5000) });
        if (res.ok) {
          loadStatus(); 
          $('modePill').textContent='Mode: Background';
        } else {
          showError($('modePill'), 'Failed to set background priority');
        }
      }catch(e){
        showError($('modePill'), 'Error setting priority');
        console.error(e);
      }
    });

    // Orchestrator controls with feedback
    $('orchStartBtn').addEventListener('click', async ()=>{
      try{
        const res = await fetch('/system/start', { 
          method:'POST', 
          headers:{'Content-Type':'application/json'}, 
          body:JSON.stringify({autoOpen:false}),
          signal: AbortSignal.timeout(10000)
        });
        if (res.ok) {
          setTimeout(loadStatus, 1200);
        } else {
          showError($('orchStatus'), 'Failed to start orchestrator');
        }
      }catch(e){
        showError($('orchStatus'), 'Start failed - check connection');
        console.error(e);
      }
    });

    $('orchStopBtn').addEventListener('click', async ()=>{
      try{
        const res = await fetch('/system/stop', { method:'POST', signal: AbortSignal.timeout(5000) });
        if (res.ok) {
          setTimeout(loadStatus, 1200);
        } else {
          showError($('orchStatus'), 'Failed to stop orchestrator');
        }
      }catch(e){
        showError($('orchStatus'), 'Stop failed - check connection');
        console.error(e);
      }
    });

    // Initial load and periodic refresh
    loadStatus();
    setInterval(loadStatus, 4000);
  </script>
</body>
</html>
