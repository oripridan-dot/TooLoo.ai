<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>TooLoo Outcomes Dashboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
 body { font-family: system-ui, Inter, Arial, sans-serif; margin:0; background:#0f1115; color:#e8ecf1; }
 header { padding:16px 24px; background:#181b21; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #262a31; }
 h1 { font-size:18px; margin:0; letter-spacing:0.5px; }
 .tag { background:#243140; padding:2px 8px; border-radius:12px; font-size:12px; margin-left:8px; }
 main { padding:24px; display:grid; gap:24px; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); }
 .card { background:#181b21; border:1px solid #262a31; border-radius:12px; padding:18px 20px; position:relative; overflow:hidden; display:flex; flex-direction:column; gap:12px; }
 .card h2 { font-size:14px; margin:0; font-weight:600; text-transform:uppercase; letter-spacing:1px; color:#8da2b8; }
 .metric { font-size:32px; font-weight:600; line-height:1; }
 .trend { font-size:12px; font-weight:500; }
 .trend.up { color:#3ddc91; } .trend.down { color:#ff5f56; } .trend.flat { color:#8da2b8; }
 table { width:100%; border-collapse:collapse; font-size:13px; }
 th, td { padding:6px 8px; text-align:left; border-bottom:1px solid #262a31; }
 th { font-weight:600; font-size:11px; letter-spacing:0.7px; text-transform:uppercase; color:#8da2b8; }
 tbody tr:hover { background:#1f242c; }
 .rice { font-variant-numeric:tabular-nums; }
 .pill { padding:2px 6px; border-radius:6px; background:#243140; font-size:11px; margin-right:4px; display:inline-block; }
 .refresh { position:absolute; top:10px; right:10px; background:#243140; border:1px solid #2f3b49; color:#c5d3e1; border-radius:6px; padding:4px 8px; cursor:pointer; font-size:11px; }
 .refresh:hover { background:#2f3b49; }
 .footer { grid-column:1/-1; text-align:center; font-size:11px; opacity:0.5; margin-top:8px; }
 .sparkline { height:40px; width:100%; }
 svg { overflow:visible; }
 .section { display:flex; flex-direction:column; gap:16px; }
 .empty { font-size:12px; color:#6b7b8c; }
</style>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
      <h1>Outcomes Snapshot</h1>
      <span class="tag" id="env-tag">FILE</span>
      <div style="display:flex;align-items:center;gap:6px;">
        <input id="api-host" placeholder="http://localhost:3001" style="padding:4px 8px;background:#14171d;color:#e8ecf1;border:1px solid #262a31;border-radius:6px;font-size:12px;width:190px;" />
        <button class="refresh" style="position:static;" onclick="setHost()">Set Host</button>
      </div>
    </div>
    <div id="last-updated" style="font-size:12px;color:#8da2b8;">--</div>
  </header>
  <main>
    <div class="card" id="metrics-card">
  <!-- <button class="refresh" onclick="recomputeMetrics()">Recompute</button> -->
      <h2>Extraction Quality</h2>
      <div style="display:flex; gap:24px; flex-wrap:wrap;">
        <div>
          <div class="metric" id="f1">--</div>
          <div class="trend" id="f1-trend">F1</div>
        </div>
        <div>
          <div class="metric" id="precision">--</div>
          <div class="trend">Precision</div>
        </div>
        <!doctype html>
        <html lang="en">
        <head>
          <meta charset="utf-8" />
          <meta name="viewport" content="width=device-width, initial-scale=1" />
          <title>TooLoo.ai Outcomes Dashboard</title>
          <style>
            :root{ --bg:#0b0f17; --card:#131a26; --text:#e6edf3; --muted:#8ea0b3; --accent:#59d; }
            body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background:var(--bg); color:var(--text); }
            header{ padding:16px 20px; border-bottom:1px solid #1f2a3a; position:sticky; top:0; background:rgba(11,15,23,.85); backdrop-filter:saturate(140%) blur(8px); }
            h1{ margin:0; font-size:18px; letter-spacing:.3px; }
            main{ padding:20px; display:grid; grid-template-columns: repeat(auto-fit,minmax(320px,1fr)); gap:16px; }
            .card{ background:var(--card); border:1px solid #1f2a3a; border-radius:12px; padding:16px; }
            h2{ font-size:14px; color:#b8c7d9; margin:0 0 12px; text-transform:uppercase; letter-spacing:.5px; }
            .kv{ display:grid; grid-template-columns: 1fr auto; gap:8px 12px; font-size:14px; }
            .kv div{ color:var(--muted); }
            code, pre{ background:#0e141f; color:#cfe3ff; padding:8px; border-radius:8px; display:block; overflow:auto; border:1px solid #1f2a3a; }
            .tag{ display:inline-block; background:#0f1724; border:1px solid #264063; color:#bcd; padding:3px 8px; border-radius:999px; font-size:12px; margin:2px 4px 0 0; }
            .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
            .btn{ background:#183055; color:#e6edf3; border:1px solid #2e4f80; padding:8px 10px; border-radius:8px; cursor:pointer; font-size:13px; }
            .btn:hover{ background:#1a3866; }
            .ok{ color:#8fdd8c; }
            .warn{ color:#ffd782; }
          </style>
          <script>
            // Helper to open the API in a Codespaces environment where Vite proxy might not be present
            window.API = '';
          </script>
  
        </head>
        <body>
          <header>
            <h1>TooLoo.ai · Outcomes Dashboard</h1>
          </header>
          <main>
            <section class="card" id="leap">
              <h2>Leaps & Capabilities</h2>
              <div class="row" id="caps"></div>
              <div style="margin-top:10px" class="row">
                <button class="btn" onclick="runScenario('sales-onboarding')">Run: Sales → Onboarding</button>
                <button class="btn" onclick="runScenario('incident-escalations')">Run: Incident → Escalations</button>
                <button class="btn" onclick="runScenario('codeqa')">Run: Code Review → Content QA</button>
                <button class="btn" onclick="runAll()">Run All</button>
              </div>
            </section>

            <section class="card" id="emerging">
              <h2>Emerging Next Leap</h2>
              <div class="kv">
                <div>Name</div><div id="em-name">--</div>
                <div>Confidence</div><div id="em-conf">--</div>
                <div>Saturation</div><div id="em-sat">--</div>
                <div>Rationale</div><div id="em-rationale" style="max-width:560px; color:#b8c7d9">--</div>
              </div>
              <div class="row" style="margin-top:10px">
                <button class="btn" onclick="implementEmerging()">Implement</button>
                <button class="btn" onclick="runProofsForConfidence()">Run Proofs</button>
                <span id="em-alert" class="tag" style="display:none"></span>
              </div>
              <div style="margin-top:6px; font-size:12px; color:#8ea0b3;">Auto-check nightly at 02:00 and alert if confidence > 0.70</div>
            </section>

            <section class="card" id="meta">
              <h2>Meta-Learning Status</h2>
              <div class="kv" id="metaKVs"></div>
            </section>

            <section class="card" id="proofs">
              <h2>Recent Cross-Domain Proofs</h2>
              <div id="proofList"></div>
            </section>
          </main>

          <script>
            const base = window.API || '';
            async function j(url, opts){
              const r = await fetch(base+url, { headers: { 'Content-Type':'application/json' }, ...(opts||{}) });
              if(!r.ok) throw new Error('HTTP '+r.status);
              return r.json();
            }

            function chip(txt){ const s=document.createElement('span'); s.className='tag'; s.textContent=txt; return s; }

            async function loadCaps(){
              const st = await j('/api/v3/evolution/status');
              const capsNode = document.querySelector('#caps');
              capsNode.innerHTML='';
              const caps = st.status.capabilities || {};
              Object.keys(caps).filter(k=>caps[k]).forEach(k=> capsNode.appendChild(chip(k)));
            }

            async function loadMeta(){
              const st = await j('/api/v4/meta-learning/status');
              const kv = document.querySelector('#metaKVs');
              kv.innerHTML='';
              const metrics = st.status.metrics?.current || {};
              const fields = [
                ['Learning Velocity', metrics.learningVelocity],
                ['Adaptation Speed', metrics.adaptationSpeed],
                ['Knowledge Retention', metrics.knowledgeRetention],
                ['Transfer Efficiency', metrics.transferEfficiency]
              ];
              for (const [k,v] of fields){
                const a=document.createElement('div'); a.textContent=k; kv.appendChild(a);
                const b=document.createElement('div'); b.textContent = (v!=null? Number(v).toFixed(2):'-'); kv.appendChild(b);
              }
            }

            function proofRow(p){
              const d=document.createElement('div');
              d.style.margin='10px 0';
              const dom = p.crossDomainProof?.domains || p.domains || {};
              d.innerHTML = `<div><span class="ok">${(p.crossDomainProof?.scenario||p.scenario||'')}</span> ${dom.from||''} → ${dom.to||''}</div>
              <div class="row">` + (p.crossDomainProof?.mappings||p.mappings||[]).slice(0,3).map(m=>`<span class='tag'>${m.from}→${m.to}</span>`).join('') + `</div>
              <div class="kv"><div>Baseline</div><div>${(p.crossDomainProof?.baselineAccuracy||p.baselineAccuracy||'').toFixed? (p.crossDomainProof?.baselineAccuracy||p.baselineAccuracy).toFixed(2) : '-'}</div>
              <div>Transferred</div><div>${(p.crossDomainProof?.transferredAccuracy||p.transferredAccuracy||'').toFixed? (p.crossDomainProof?.transferredAccuracy||p.transferredAccuracy).toFixed(2) : '-'}</div></div>`;
              return d;
            }

            async function loadProofs(){
              const r = await j('/api/v3/evolution/cross-domain/proofs?limit=10');
              const list = document.querySelector('#proofList');
              list.innerHTML='';
              (r.proofs||[]).forEach(p=> list.appendChild(proofRow(p)) );
            }

            async function loadEmerging(){
              const r = await j('/api/v3/evolution/emerging-next-leap');
              const name = r.next?.name || '—';
              const conf = (r.confidence!=null)? (Number(r.confidence)*100).toFixed(0)+'%' : '—';
              const sat = r.saturation!=null ? `${(r.saturation*100).toFixed(0)}% (${r.saturationLabel})` : '—';
              document.querySelector('#em-name').textContent = name;
              document.querySelector('#em-conf').textContent = conf;
              document.querySelector('#em-sat').textContent = sat;
              document.querySelector('#em-rationale').textContent = r.rationale || '—';
              const alertNode = document.querySelector('#em-alert');
              if (r.confidence && r.confidence > 0.7){
                alertNode.style.display = 'inline-block';
                alertNode.textContent = 'Ready to pursue';
              } else {
                alertNode.style.display = 'none';
              }
              window.__emerging = r; // cache
            }

            async function implementEmerging(){
              try{
                const leapName = window.__emerging?.next?.name;
                if(!leapName) return alert('No emerging leap available');
                const res = await j('/api/v3/evolution/implement-leap', { method:'POST', body: JSON.stringify({ confirm:true, leapName }) });
                alert('Implemented: '+(res.result?.leap||leapName));
                await loadCaps();
                await loadMeta();
                await loadEmerging();
              }catch(e){ alert('Failed to implement: '+e.message); }
            }

            async function runProofsForConfidence(){
              try {
                await runAll();
                await loadEmerging();
              } catch(e){ alert('Failed: '+e.message); }
            }

            function scheduleNightlyEmergingCheck(){
              // Check every minute; if time is 02:00 local, refresh emerging and show alert if >0.7
              const tick = async ()=>{
                const now = new Date();
                if (now.getHours()===2 && now.getMinutes()===0){
                  try { await loadEmerging(); } catch {}
                }
              };
              setInterval(tick, 60000);
            }

            async function runScenario(key){
              try {
                await j('/api/v3/evolution/cross-domain/run', { method:'POST', body: JSON.stringify({ scenario:key }) });
                await loadProofs();
                await loadMeta();
              } catch(e){ alert('Failed: '+e.message); }
            }

            async function runAll(){
              try {
                await j('/api/v3/evolution/cross-domain/run-all', { method:'POST' });
                await loadProofs();
                await loadMeta();
              } catch(e){ alert('Failed: '+e.message); }
            }

            (async function init(){
              try {
                await loadCaps();
                await loadMeta();
                await loadProofs();
                await loadEmerging();
                scheduleNightlyEmergingCheck();
              } catch(e){ console.warn('Init error', e); }
            })();
          </script>
          <script>
            // System Summaries tile
            (function addSystemSummaries(){
              const main = document.querySelector('main');
              const sec = document.createElement('section');
              sec.className='card';
              sec.innerHTML = `
                <h2>System Summaries</h2>
                <div class="row" style="margin-bottom:8px; gap:8px;">
                  <button class="btn" id="btn-sum-logs">Summarize Logs</button>
                  <button class="btn" id="btn-sum-evo">Summarize Evolution</button>
                  <button class="btn" id="btn-sum-files">Workspace Macro Summary</button>
                </div>
                <div class="kv" id="sum-kv">
                  <div>Last Logs Run</div><div id="sum-logs-at">—</div>
                  <div>Last Evolution Run</div><div id="sum-evo-at">—</div>
                  <div>Last Files Run</div><div id="sum-files-at">—</div>
                </div>
                <div style="margin-top:10px">
                  <div style="font-size:12px; color:#b8c7d9; margin-bottom:6px;">Macro Teaser</div>
                  <div id="macro-teaser" style="font-size:13px; color:#e6edf3; max-height:100px; overflow:auto; background:#0e141f; border:1px solid #1f2a3a; border-radius:8px; padding:8px;"></div>
                </div>`;
              main.appendChild(sec);
              async function refreshStatus(){
                try{
                  const st = await j('/api/v1/summarize/status');
                  document.querySelector('#sum-logs-at').textContent = st.status.lastRuns?.logs || '—';
                  document.querySelector('#sum-evo-at').textContent = st.status.lastRuns?.evolution || '—';
                  document.querySelector('#sum-files-at').textContent = st.status.lastRuns?.files || '—';
                  const macro = st.status.latest?.files?.macro || null;
                  document.querySelector('#macro-teaser').textContent = macro?.text ? macro.text.slice(0, 800) : '—';
                } catch(e){ console.warn('Summaries status error', e); }
              }
              document.querySelector('#btn-sum-logs').onclick = async ()=>{ try { await j('/api/v1/summarize/logs'); await refreshStatus(); } catch(e){ alert('Failed: '+e.message); } };
              document.querySelector('#btn-sum-evo').onclick = async ()=>{ try { await j('/api/v1/summarize/evolution'); await refreshStatus(); } catch(e){ alert('Failed: '+e.message); } };
              document.querySelector('#btn-sum-files').onclick = async ()=>{ try { await j('/api/v1/summarize/files', { method:'POST', body: JSON.stringify({ maxFiles:50, returnPerFile:false }) }); await refreshStatus(); } catch(e){ alert('Failed: '+e.message); } };
              refreshStatus();
              setInterval(refreshStatus, 60000);
            })();
          </script>
        </body>
        </html>
