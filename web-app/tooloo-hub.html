<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TooLoo Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background: #f7f8fa; margin: 0; color: #222; }
    header { background: #7C5CFF; color: #fff; padding: 1.2em 2em; font-size: 1.5em; font-weight: 600; }
    .container { max-width: 1200px; margin: 2em auto; padding: 2em; background: #fff; border-radius: 16px; box-shadow: 0 2px 16px #e6e9ee; }
    .row { display: flex; gap: 2em; margin-bottom: 2em; }
    .col { flex: 1; }
    .section-title { font-size: 1.2em; font-weight: 600; margin-bottom: 0.5em; color: #7C5CFF; }
    textarea, input, button { font-family: inherit; font-size: 1em; }
    textarea { width: 100%; min-height: 80px; border-radius: 8px; border: 1px solid #cfd6e0; padding: 0.7em; margin-bottom: 0.5em; }
    button { background: #7C5CFF; color: #fff; border: none; border-radius: 8px; padding: 0.7em 1.5em; cursor: pointer; font-weight: 600; }
    .artifact-gallery { display: flex; gap: 1em; flex-wrap: wrap; }
    .artifact { background: #f2f4f8; border-radius: 8px; padding: 1em; box-shadow: 0 1px 6px #e6e9ee; min-width: 220px; max-width: 320px; }
    iframe, .preview-img { width: 100%; border-radius: 8px; border: 1px solid #cfd6e0; }
    .status-box { background: #f2f4f8; border-radius: 8px; padding: 1em; margin-bottom: 1em; }
    .links { margin-top: 1em; }
    .links a { color: #7C5CFF; text-decoration: none; margin-right: 1.5em; font-weight: 600; }
  .chat-msg { margin-bottom: 1.1em; line-height: 1.55; }
    .chat-msg .user { font-weight: 600; color: #222; margin-bottom: 0.5em; }
    .chat-msg .tooloo-reply { color: #333; }
    .chat-msg .tooloo-reply h1, .chat-msg .tooloo-reply h2, .chat-msg .tooloo-reply h3 { color: #7C5CFF; margin: 0.8em 0 0.4em 0; font-weight: 600; }
  .chat-msg .tooloo-reply h1 { font-size: 1.22em; }
  .chat-msg .tooloo-reply h2 { font-size: 1.12em; }
  .chat-msg .tooloo-reply h3 { font-size: 1.02em; }
    .chat-msg .tooloo-reply strong { color: #7C5CFF; font-weight: 600; }
  .chat-msg .tooloo-reply ul, .chat-msg .tooloo-reply ol { margin: 0.4em 0; padding-left: 1.25em; }
  .chat-msg .tooloo-reply li { margin: 0.25em 0; }
  .chat-msg .tooloo-reply p { margin: 0.45em 0; }
    .chat-msg .tooloo-reply code { background: #f2f4f8; padding: 0.1em 0.3em; border-radius: 3px; font-family: 'Courier New', monospace; font-size: 0.9em; }
  .chat-msg .tooloo-reply pre { background: #f7f8fa; border: 1px solid #e6e9ee; padding: 0.6em; border-radius: 8px; overflow-x: auto; }

    /* Modes: lean vs detailed */
    body.mode-lean { font-size: 15px; }
    body.mode-lean .chat-msg .tooloo-reply p { margin: 0.35em 0; }
    body.mode-lean .chat-msg .tooloo-reply ul, body.mode-lean .chat-msg .tooloo-reply ol { margin: 0.3em 0; }
    body.mode-detailed { font-size: 16.5px; }
    body.mode-detailed .chat-msg .tooloo-reply p { margin: 0.6em 0; }
    body.mode-detailed .chat-msg .tooloo-reply ul, body.mode-detailed .chat-msg .tooloo-reply ol { margin: 0.55em 0; }
  </style>
</head>
<body>
  <header>TooLoo Hub: Your Meeting Room</header>
  <div class="container">
    <div class="row" style="margin-bottom:1em; align-items:center; gap:1em;">
      <button onclick="startSystem()">Start System</button>
      <button onclick="runSystemCheck()">Run System Check</button>
      <button onclick="syncGithubIssues()">Sync GitHub Issues</button>
      <span id="actionMsg" style="margin-left:1em;color:#555;"></span>
    </div>
    <div class="row">
      <div class="col">
        <div class="section-title">Prompt Engineering & Chat</div>
        <textarea id="promptInput" placeholder="Share your idea, prompt, or question..."></textarea>
        <button onclick="sendPrompt()">Send to TooLoo</button>
        <div id="chatHistory" style="margin-top:1em;"></div>
      </div>
      <div class="col">
        <div class="section-title">Live System Status</div>
        <div id="systemStatus" class="status-box">Loading...</div>
        <div class="section-title">Active Routes</div>
        <div id="routeStatus" class="status-box">Loading...</div>
        <div class="section-title">Conversation Intelligence</div>
        <div id="intelligencePanel" class="status-box">Start a chat to see segments, patterns, traits, and next steps.</div>
        <div class="links">
          <a href="/control-room" target="_blank">Control Room</a>
          <a href="/design-suite" target="_blank">Design Suite</a>
          <a href="/temp/index" target="_blank">Artifacts</a>
        </div>
      </div>
    </div>
    <div class="section-title">Visual Artifact Gallery</div>
    <div id="artifactGallery" class="artifact-gallery"></div>
  </div>
  <script>
    // Lean, safe structured renderer for hierarchy: headings, lists, bold, inline code, fenced blocks
    function escapeHtml(s){
      return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }
    function formatInline(s){
      // inline code `x`, bold **x** (after escaping)
      return s
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    }
    function parseHierarchical(text){
      if (!text) return '';
      // Handle fenced code blocks first
      const fences = [];
      let safe = text.replace(/```([\s\S]*?)```/g, (_,code)=>{
        const idx = fences.push(`<pre><code>${escapeHtml(code)}</code></pre>`) - 1;
        return `[[FENCE_${idx}]]`;
      });
      const lines = safe.split(/\r?\n/);
      let html = '';
      let inUL = false, inOL = false;
      const closeLists = ()=>{
        if (inUL){ html += '</ul>'; inUL=false; }
        if (inOL){ html += '</ol>'; inOL=false; }
      };
      for (let raw of lines){
        let line = raw.trimEnd();
        if (!line.trim()) { closeLists(); continue; }
        // Headings
        let m;
        if (m = line.match(/^###\s+(.+)/)) { closeLists(); html += `<h3>${formatInline(escapeHtml(m[1]))}</h3>`; continue; }
        if (m = line.match(/^##\s+(.+)/)) { closeLists(); html += `<h2>${formatInline(escapeHtml(m[1]))}</h2>`; continue; }
        if (m = line.match(/^#\s+(.+)/)) { closeLists(); html += `<h1>${formatInline(escapeHtml(m[1]))}</h1>`; continue; }
        // Ordered list
        if (m = line.match(/^\d+\.\s+(.+)/)) {
          if (inUL){ html += '</ul>'; inUL=false; }
          if (!inOL){ html += '<ol>'; inOL=true; }
          html += `<li>${formatInline(escapeHtml(m[1]))}</li>`; continue;
        }
        // Unordered list
        if (m = line.match(/^(?:[-*•])\s+(.+)/)) {
          if (inOL){ html += '</ol>'; inOL=false; }
          if (!inUL){ html += '<ul>'; inUL=true; }
          html += `<li>${formatInline(escapeHtml(m[1]))}</li>`; continue;
        }
        // Paragraph
        closeLists();
        html += `<p>${formatInline(escapeHtml(line))}</p>`;
      }
      closeLists();
      // Restore fences
      html = html.replace(/\[\[FENCE_(\d+)\]\]/g, (_,i)=> fences[Number(i)] || '');
      return html;
    }

    // --- Chat session + transcripts ---
    const sessionId = `s_${Date.now().toString(36)}${Math.random().toString(36).slice(2,6)}`;
    const chatMessages = []; // {role:'user'|'assistant', content:string}
    async function appendTranscript(role, content){
      try{
        await fetch('/api/v1/chat/append', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ sessionId, role, content, ts: Date.now() }) });
      }catch{}
    }

    // --- UI Control Protocol ---
    // TooLoo can append a fenced block to control the UI without affecting shown content:
    // ```ui\n{"action":"setMode","mode":"lean"}\n```
    // or an array of commands
    const UI_BLOCK_RE = /```ui\s+([\s\S]*?)```/g;
    function extractUIBlocks(text){
      const cmds = [];
      let m;
      while ((m = UI_BLOCK_RE.exec(text)) !== null) {
        const raw = m[1].trim();
        try{
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) cmds.push(...parsed);
          else if (parsed && typeof parsed === 'object') cmds.push(parsed);
        }catch{}
      }
      return cmds;
    }
    function stripUIBlocks(text){
      return text.replace(UI_BLOCK_RE, '').trim();
    }
    async function applyUICommand(cmd){
      if (!cmd || typeof cmd !== 'object') return;
      switch(cmd.action){
        case 'setMode': {
          const mode = cmd.mode === 'detailed' ? 'mode-detailed' : 'mode-lean';
          document.body.classList.remove('mode-lean','mode-detailed');
          document.body.classList.add(mode);
          break;
        }
        case 'toggleSection': {
          const id = String(cmd.id||'').trim();
          if (!id) break;
          const el = document.getElementById(id);
          if (el) el.style.display = (cmd.show===false) ? 'none' : '';
          break;
        }
        case 'open': {
          const url = String(cmd.url||'');
          if (url && /^\//.test(url)) window.open(url, '_blank');
          break;
        }
        case 'priority': {
          const mode = cmd.mode==='background' ? 'background' : 'chat';
          fetch(`/api/v1/system/priority/${mode}`, { method:'POST' }).catch(()=>{});
          break;
        }
        case 'startSystem': {
          startSystem();
          break;
        }
        case 'systemCheck': {
          runSystemCheck();
          break;
        }
        case 'scrollTo': {
          const id = String(cmd.id||''); const el = id? document.getElementById(id): null;
          (el||window).scrollIntoView ? el.scrollIntoView({ behavior:'smooth', block:'start' }) : window.scrollTo({ top:0, behavior:'smooth' });
          break;
        }
        case 'setTheme': {
          // placeholder: adjust header color quickly
          if (cmd.primaryColor) document.querySelector('header').style.background = cmd.primaryColor;
          break;
        }
        case 'setChatStyle': {
          // tweak chat density
          if (cmd.compact===true) document.body.classList.add('mode-lean');
          if (cmd.compact===false) document.body.classList.add('mode-detailed');
          break;
        }
        case 'showHint': {
          const msg = String(cmd.text||'');
          if (msg) { const n = document.getElementById('actionMsg'); n.textContent = msg; setTimeout(()=>{ n.textContent=''; }, 2500); }
          break;
        }
        default: {
          // ignore unknown
        }
      }
    }
    async function applyUICommands(cmds){
      for (const c of cmds) await applyUICommand(c);
    }
    async function sendPrompt() {
      const input = document.getElementById('promptInput').value.trim();
      if (!input) return;
      const chatDiv = document.getElementById('chatHistory');
      const msgId = `m_${Date.now()}`;
      chatDiv.innerHTML += `<div class='chat-msg' id="${msgId}"><div class='user'>You: ${input}</div><div class='tooloo-reply'></div></div>`;
      document.getElementById('promptInput').value = '';
      chatMessages.push({ role:'user', content: input });
      appendTranscript('user', input);
      // Stream via SSE from burst-stream; fallback if not available
      try {
        const params = new URLSearchParams({ prompt: input, ttlSeconds: '30' });
        const es = new EventSource(`/api/v1/chat/burst-stream?${params.toString()}`);
        const replyEl = document.querySelector(`#${msgId} .tooloo-reply`);
        let buffer = '';
        es.addEventListener('token', (ev)=>{
          try { 
            const d = JSON.parse(ev.data); 
            buffer += d.token || ''; 
            replyEl.innerHTML = parseHierarchical(buffer);
          } catch {}
        });
        es.addEventListener('done', ()=>{ 
          es.close(); 
          const cmds = extractUIBlocks(buffer);
          const visible = stripUIBlocks(buffer);
          replyEl.innerHTML = parseHierarchical(visible);
          applyUICommands(cmds);
          chatMessages.push({ role:'assistant', content: visible });
          appendTranscript('assistant', visible);
          analyzeConversation().catch(()=>{});
        });
        es.addEventListener('meta', ()=>{});
        es.onerror = ()=>{ es.close(); if (!buffer) replyEl.textContent = '(providers offline or busy)'; };
      } catch(e) {
        const replyEl = document.querySelector(`#${msgId} .tooloo-reply`);
        replyEl.textContent = '(error starting stream)';
      }
    }

    // --- Conversation Intelligence: segmentation + next steps ---
    async function analyzeConversation(){
      if (chatMessages.length < 2) return; // need at least one exchange
      const payload = {
        messages: chatMessages.map((m, idx)=> ({ id:`c${idx}`, author: m.role, content: m.content, index: idx }))
      };
      const panel = document.getElementById('intelligencePanel');
      panel.innerHTML = 'Analyzing conversation...';
      try{
        const r = await fetch('/api/v1/segmentation/analyze', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        if (!r.ok) throw new Error('segmentation failed');
        const j = await r.json();
        if (!j.ok) throw new Error(j.error||'analysis error');
        renderIntelligence(j.analysis);
        generateNextSteps(j.analysis).catch(()=>{});
      }catch(e){ panel.innerHTML = 'Analysis unavailable.'; }
    }
    function renderIntelligence(analysis){
      const panel = document.getElementById('intelligencePanel');
      const segs = (analysis.segments||[]).map(s=>`<li><strong>${escapeHtml(s.title)}</strong> – ${escapeHtml(s.summary||'')}</li>`).join('');
      const patCount = (analysis.patternCandidates||[]).length;
      const traits = analysis.traitVector||{};
      const traitRow = (name,val)=>{
        const pct = Math.round((val||0)*100);
        return `<div style='margin:0.25em 0'><span style='display:inline-block;width:140px'>${escapeHtml(name)}</span><span style='display:inline-block;background:#eef;border-radius:6px;width:55%;height:8px;vertical-align:middle;overflow:hidden'><span style='display:inline-block;background:#7C5CFF;height:8px;width:${pct}%'></span></span> <span style='color:#555'>${pct}%</span></div>`;
      };
      const traitHtml = Object.entries(traits).map(([k,v])=> traitRow(k,v)).join('');
      panel.innerHTML = `
        <h3>Segments</h3>
        <ul>${segs || '<li>No segments detected</li>'}</ul>
        <h3>Patterns</h3>
        <p>${patCount} candidates</p>
        <h3>Traits</h3>
        ${traitHtml || '<p>No traits yet</p>'}
        <h3>Next Steps</h3>
        <div id='nextStepsBox'>Generating...</div>
      `;
    }
    async function generateNextSteps(analysis){
      const summary = {
        segments: (analysis.segments||[]).slice(0,6).map(s=>({ title:s.title, summary:s.summary })),
        traits: analysis.traitVector||{}
      };
      const prompt = `Given this conversation analysis (JSON):\n${JSON.stringify(summary)}\n\nProduce a concise, actionable Next Steps plan that moves the idea forward.\nRequirements:\n- Start with a short title.\n- 3–7 bullet actions.\n- Each action begins with a strong verb.\n- Keep it lean and specific.\n`;
      try{
        const r = await fetch('/api/v1/providers/burst', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ prompt, ttlSeconds: 60 }) });
        const j = await r.json();
        const box = document.getElementById('nextStepsBox');
        if (j?.ok) box.innerHTML = parseHierarchical(j.text||''); else box.textContent = 'Failed to generate next steps.';
      }catch{ document.getElementById('nextStepsBox').textContent = 'Failed to generate next steps.'; }
    }
    async function loadSystemStatus() {
      try {
        const r = await fetch('/api/v1/system/check');
        const j = await r.json();
        let html = `<b>Time:</b> ${j.time || ''}<br>`;
        if (j.results) {
          Object.entries(j.results).forEach(([svc, res]) => {
            html += `<b>${svc}:</b> `;
            Object.entries(res).forEach(([k, v]) => {
              html += `${k}: <span style='color:${v.ok?'#00E9B0':'#FF5C7C'}'>${v.ok?'OK':'FAIL'}</span> `;
            });
            html += '<br>';
          });
        } else {
          html += 'No results.';
        }
        document.getElementById('systemStatus').innerHTML = html;
      } catch(e) {
        document.getElementById('systemStatus').innerHTML = 'Error loading system status.';
      }
    }
    async function runSystemCheck(){
      document.getElementById('actionMsg').textContent = 'Running system check...';
      await loadSystemStatus();
      document.getElementById('actionMsg').textContent = 'System check complete.';
      setTimeout(()=>{ document.getElementById('actionMsg').textContent=''; }, 2000);
    }
    async function loadRouteStatus() {
      try {
        const r = await fetch('/api/v1/system/routes');
        const j = await r.json();
        let html = '';
        if (j.routes) {
          j.routes.forEach(route => {
            html += `<b>${route.name}:</b> ${route.route.type.toUpperCase()} <span style='color:#7C5CFF'>${route.route.base}</span><br>`;
          });
        } else {
          html += 'No routes.';
        }
        document.getElementById('routeStatus').innerHTML = html;
      } catch(e) {
        document.getElementById('routeStatus').innerHTML = 'Error loading routes.';
      }
    }
    async function loadArtifacts() {
      try {
        const r = await fetch('/temp/index');
        const html = await r.text();
        // Parse links from temp/index page
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const links = doc.querySelectorAll('ul li a');
        const gallery = document.getElementById('artifactGallery');
        gallery.innerHTML = '';
        links.forEach(link => {
          const url = link.getAttribute('href');
          const name = link.textContent;
          let preview;
          if (url.endsWith('.pdf')) {
            preview = `<iframe src='${url}' height='180'></iframe>`;
          } else if (url.endsWith('.html')) {
            preview = `<iframe src='${url}' height='180'></iframe>`;
          } else if (url.endsWith('.jsonl')) {
            preview = `<div class='preview-img'>Chat transcript</div>`;
          } else {
            preview = `<div class='preview-img'>${name}</div>`;
          }
          gallery.innerHTML += `<div class='artifact'><div><b>${name}</b></div>${preview}</div>`;
        });
      } catch(e) {
        document.getElementById('artifactGallery').innerHTML = 'Error loading artifacts.';
      }
    }
    async function startSystem(){
      try{
        document.getElementById('actionMsg').textContent = 'Starting system...';
        const r = await fetch('/system/start', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ autoOpen:false }) });
        const j = await r.json();
        document.getElementById('actionMsg').textContent = j.ok ? 'System started.' : 'Failed to start.';
        setTimeout(()=>{ document.getElementById('actionMsg').textContent=''; loadSystemStatus(); }, 1500);
      }catch{ document.getElementById('actionMsg').textContent = 'Failed to start.'; }
    }
    async function syncGithubIssues(){
      try{
        document.getElementById('actionMsg').textContent = 'Syncing GitHub issues...';
        const r = await fetch('/api/v1/sources/github/issues/sync', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({}) });
        const j = await r.json();
        document.getElementById('actionMsg').textContent = j.ok ? `Synced ${j.count||0} topics.` : 'Sync failed.';
        setTimeout(()=>{ document.getElementById('actionMsg').textContent=''; }, 2000);
      }catch{ document.getElementById('actionMsg').textContent = 'Sync failed.'; }
    }
    loadSystemStatus();
    loadRouteStatus();
    loadArtifacts();
    setInterval(loadSystemStatus, 10000);
    setInterval(loadRouteStatus, 15000);
    setInterval(loadArtifacts, 30000);
  </script>
</body>
</html>
