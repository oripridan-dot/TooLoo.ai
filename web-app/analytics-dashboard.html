<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TooLoo Analytics Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #e2e8f0;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      margin-bottom: 40px;
      border-bottom: 1px solid #334155;
      padding-bottom: 20px;
    }

    h1 {
      font-size: 32px;
      margin-bottom: 5px;
      background: linear-gradient(135deg, #60a5fa, #a78bfa);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .subtitle {
      color: #94a3b8;
      font-size: 14px;
    }

    .controls {
      display: flex;
      gap: 10px;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    button {
      padding: 10px 20px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }

    button:hover {
      background: #2563eb;
      transform: translateY(-2px);
    }

    button.secondary {
      background: #475569;
    }

    button.secondary:hover {
      background: #334155;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 20px;
      transition: all 0.3s;
    }

    .card:hover {
      border-color: #475569;
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.1);
    }

    .card-title {
      font-size: 14px;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
    }

    .metric-value {
      font-size: 32px;
      font-weight: 700;
      color: #60a5fa;
      margin-bottom: 5px;
    }

    .metric-label {
      font-size: 12px;
      color: #64748b;
    }

    .metric-change {
      display: inline-block;
      margin-top: 10px;
      padding: 4px 8px;
      background: #0f172a;
      border-radius: 4px;
      font-size: 12px;
      color: #10b981;
    }

    .metric-change.negative {
      color: #ef4444;
    }

    .chart-container {
      margin: 30px 0;
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 20px;
    }

    .chart-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #e2e8f0;
    }

    canvas {
      width: 100% !important;
      height: auto !important;
    }

    .heatmap-container {
      background: #0f172a;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }

    .heatmap-canvas {
      width: 100%;
      height: 400px;
      border: 1px solid #334155;
      border-radius: 4px;
      display: block;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }

    th {
      background: #0f172a;
      padding: 12px;
      text-align: left;
      font-size: 12px;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid #334155;
    }

    td {
      padding: 12px;
      border-bottom: 1px solid #334155;
      font-size: 14px;
    }

    tr:hover {
      background: #0f172a;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-active {
      background: #10b981;
      color: #000;
    }

    .status-idle {
      background: #f59e0b;
      color: #000;
    }

    .status-inactive {
      background: #6b7280;
      color: #fff;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #94a3b8;
    }

    .error {
      background: #7f1d1d;
      border: 1px solid #dc2626;
      color: #fecaca;
      padding: 12px;
      border-radius: 6px;
      margin: 10px 0;
    }

    .success {
      background: #064e3b;
      border: 1px solid #10b981;
      color: #a7f3d0;
      padding: 12px;
      border-radius: 6px;
      margin: 10px 0;
    }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }

    .stat-item {
      background: #0f172a;
      padding: 15px;
      border-radius: 6px;
      border-left: 3px solid #3b82f6;
    }

    .stat-item.alt {
      border-left-color: #a78bfa;
    }

    .stat-item.alt2 {
      border-left-color: #ec4899;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: #60a5fa;
    }

    .stat-name {
      font-size: 11px;
      color: #94a3b8;
      text-transform: uppercase;
      margin-top: 5px;
      letter-spacing: 0.5px;
    }

    .refresh-time {
      font-size: 12px;
      color: #64748b;
      margin-top: 20px;
      text-align: right;
    }

    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }

      h1 {
        font-size: 24px;
      }

      .metric-value {
        font-size: 24px;
      }

      .controls {
        flex-direction: column;
      }

      button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üìä TooLoo Analytics Dashboard</h1>
      <p class="subtitle">Real-time UI activity monitoring, engagement metrics & performance insights</p>
    </header>

    <div class="controls">
      <button onclick="refreshData()">üîÑ Refresh Now</button>
      <button class="secondary" onclick="toggleAutoRefresh()">‚è±Ô∏è Auto Refresh: <span id="autoRefreshStatus">ON</span></button>
      <button class="secondary" onclick="exportData()">üì• Export Report</button>
    </div>

    <!-- Preload Data Indicator -->
    <div id="preloadIndicator" class="card" style="margin-bottom: 20px; background: #1f2937; border-left: 4px solid #8b5cf6;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <div style="font-size: 12px; color: #a78bfa; text-transform: uppercase; margin-bottom: 8px;">üìä Data Source</div>
          <div style="font-size: 14px; color: #e2e8f0;">
            <span id="preloadCount">0</span> <span style="color: #94a3b8;">preload</span> + 
            <span id="realCount">0</span> <span style="color: #94a3b8;">real</span> = 
            <span id="totalCount">0</span> <span style="color: #94a3b8;">total sessions</span>
          </div>
          <div style="font-size: 12px; color: #64748b; margin-top: 8px;">
            <span id="preloadPercentage">0</span>% preload, <span id="realPercentage">0</span>% real
          </div>
        </div>
        <div style="text-align: right;">
          <div id="preloadNote" style="font-size: 12px; color: #a78bfa; font-weight: 600;"></div>
        </div>
      </div>
    </div>

    <div id="messages"></div>

    <!-- Key Metrics -->
    <div class="grid">
      <div class="card">
        <div class="card-title">Active Sessions</div>
        <div class="metric-value" id="activeSessions">0</div>
        <div class="metric-label">Currently browsing</div>
      </div>

      <div class="card">
        <div class="card-title">Total Events</div>
        <div class="metric-value" id="totalEvents">0</div>
        <div class="metric-label">All interactions tracked</div>
      </div>

      <div class="card">
        <div class="card-title">Avg Session Duration</div>
        <div class="metric-value" id="avgDuration">0s</div>
        <div class="metric-label">Minutes of engagement</div>
      </div>

      <div class="card">
        <div class="card-title">Events per Session</div>
        <div class="metric-value" id="eventsPerSession">0</div>
        <div class="metric-label">Average interactions</div>
      </div>
    </div>

    <!-- Performance Metrics -->
    <div class="chart-container">
      <div class="chart-title">‚ö° Core Web Vitals</div>
      <div class="stat-grid">
        <div class="stat-item">
          <div class="stat-value" id="fcp">--</div>
          <div class="stat-name">FCP (ms)</div>
        </div>
        <div class="stat-item alt">
          <div class="stat-value" id="lcp">--</div>
          <div class="stat-name">LCP (ms)</div>
        </div>
        <div class="stat-item alt2">
          <div class="stat-value" id="cls">--</div>
          <div class="stat-name">CLS (score)</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="fid">--</div>
          <div class="stat-name">FID (ms)</div>
        </div>
      </div>
    </div>

    <!-- Click Heatmap -->
    <div class="chart-container">
      <div class="chart-title">üî• Click Heatmap</div>
      <div class="heatmap-container">
        <canvas id="heatmapCanvas" class="heatmap-canvas"></canvas>
      </div>
      <p class="metric-label">Warmer colors = more frequent clicks</p>
    </div>

    <!-- Feature Usage -->
    <div class="chart-container">
      <div class="chart-title">‚≠ê Top Features</div>
      <table>
        <thead>
          <tr>
            <th>Feature</th>
            <th>Usage Count</th>
            <th>% of Events</th>
          </tr>
        </thead>
        <tbody id="topFeaturesTable">
          <tr><td colspan="3" class="loading">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Page Analytics -->
    <div class="chart-container">
      <div class="chart-title">üìÑ Top Pages</div>
      <table>
        <thead>
          <tr>
            <th>Page Path</th>
            <th>Views</th>
            <th>% of Traffic</th>
          </tr>
        </thead>
        <tbody id="topPagesTable">
          <tr><td colspan="3" class="loading">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Active Sessions -->
    <div class="chart-container">
      <div class="chart-title">üë• Active Sessions</div>
      <table>
        <thead>
          <tr>
            <th>Session ID</th>
            <th>User</th>
            <th>Events</th>
            <th>Duration</th>
            <th>Pages</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="sessionsTable">
          <tr><td colspan="6" class="loading">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <div class="refresh-time">
      Last updated: <span id="lastUpdate">--</span> | Auto-refresh every <span id="refreshInterval">30</span>s
    </div>
  </div>

  <script>
    let autoRefresh = true;
    const REFRESH_INTERVAL = 30000; // 30 seconds
    const MONITOR_URL = 'http://127.0.0.1:3051';

    /**
     * Show message
     */
    function showMessage(message, type = 'success') {
      const msgDiv = document.getElementById('messages');
      const msg = document.createElement('div');
      msg.className = type;
      msg.textContent = message;
      msgDiv.appendChild(msg);

      setTimeout(() => {
        msg.remove();
      }, 5000);
    }

    /**
     * Format duration
     */
    function formatDuration(ms) {
      if (ms < 1000) return ms + 'ms';
      const seconds = Math.round(ms / 1000);
      if (seconds < 60) return seconds + 's';
      const minutes = Math.round(seconds / 60);
      return minutes + 'm';
    }

    /**
     * Format number
     */
    function formatNumber(num) {
      if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'k';
      }
      return num.toString();
    }

    /**
     * Fetch and display preload data status
     */
    async function fetchPreloadStatus() {
      try {
        const res = await fetch(`${MONITOR_URL}/api/v1/analytics/preload-status`);
        const data = await res.json();

        if (data.ok) {
          const status = data.data;
          document.getElementById('preloadCount').textContent = status.preloadSessions;
          document.getElementById('realCount').textContent = status.realSessions;
          document.getElementById('totalCount').textContent = status.totalSessions;
          document.getElementById('preloadPercentage').textContent = status.preloadPercentage;
          document.getElementById('realPercentage').textContent = (100 - status.preloadPercentage);
          document.getElementById('preloadNote').textContent = status.note;
        }
      } catch (e) {
        console.error('Error fetching preload status:', e);
      }
    }

    /**
     * Fetch and render engagement metrics
     */
    async function fetchEngagement() {
      try {
        const res = await fetch(`${MONITOR_URL}/api/v1/analytics/engagement`);
        const data = await res.json();

        if (data.ok) {
          const eng = data.data;
          document.getElementById('activeSessions').textContent = eng.activeSessions;
          document.getElementById('totalEvents').textContent = formatNumber(eng.totalEvents);
          document.getElementById('avgDuration').textContent = formatDuration(eng.averageSessionDuration);
          document.getElementById('eventsPerSession').textContent = Math.round(eng.averageEventsPerSession);

          // Top pages
          const pagesHtml = eng.topPages.map(p => `
            <tr>
              <td><code>${p.page || '/'}</code></td>
              <td>${p.views}</td>
              <td>${Math.round((p.views / eng.totalEvents) * 100)}%</td>
            </tr>
          `).join('');
          document.getElementById('topPagesTable').innerHTML = pagesHtml || '<tr><td colspan="3" class="loading">No data</td></tr>';
        }
      } catch (e) {
        console.error('Error fetching engagement:', e);
      }
    }

    /**
     * Fetch and render performance metrics
     */
    async function fetchPerformance() {
      try {
        const res = await fetch(`${MONITOR_URL}/api/v1/analytics/performance`);
        const data = await res.json();

        if (data.ok) {
          const perf = data.data;
          document.getElementById('fcp').textContent = perf.firstContentfulPaint.value || '--';
          document.getElementById('lcp').textContent = perf.largestContentfulPaint.value || '--';
          document.getElementById('cls').textContent = (perf.cumulativeLayoutShift.value || 0).toFixed(2);
          document.getElementById('fid').textContent = perf.firstInputDelay.value || '--';
        }
      } catch (e) {
        console.error('Error fetching performance:', e);
      }
    }

    /**
     * Fetch and render feature usage
     */
    async function fetchFeatures() {
      try {
        const res = await fetch(`${MONITOR_URL}/api/v1/analytics/features`);
        const data = await res.json();

        if (data.ok) {
          const features = data.data.topFeatures || [];
          const html = features.map(f => `
            <tr>
              <td><code>${f.feature}</code></td>
              <td>${f.usageCount}</td>
              <td>${f.percentage}%</td>
            </tr>
          `).join('');
          document.getElementById('topFeaturesTable').innerHTML = html || '<tr><td colspan="3" class="loading">No data</td></tr>';
        }
      } catch (e) {
        console.error('Error fetching features:', e);
      }
    }

    /**
     * Fetch and render heatmap
     */
    async function fetchHeatmap() {
      try {
        const res = await fetch(`${MONITOR_URL}/api/v1/analytics/heatmap`);
        const data = await res.json();

        if (data.ok && data.data.data.length > 0) {
          renderHeatmap(data.data.data, data.data.resolution);
        }
      } catch (e) {
        console.error('Error fetching heatmap:', e);
      }
    }

    /**
     * Render heatmap on canvas
     */
    function renderHeatmap(heatmapData, resolution) {
      const canvas = document.getElementById('heatmapCanvas');
      const ctx = canvas.getContext('2d');
      const width = canvas.offsetWidth;
      const height = canvas.offsetHeight;

      canvas.width = width;
      canvas.height = height;

      const cellWidth = width / resolution;
      const cellHeight = height / resolution;

      // Clear canvas
      ctx.fillStyle = '#0f172a';
      ctx.fillRect(0, 0, width, height);

      // Draw heatmap cells
      heatmapData.forEach(point => {
        const hue = (1 - point.percentage / 100) * 240; // Blue to Red
        ctx.fillStyle = `hsl(${hue}, 100%, 50%)`;
        ctx.globalAlpha = 0.7;
        ctx.fillRect(point.x * cellWidth, point.y * cellHeight, cellWidth, cellHeight);
      });

      ctx.globalAlpha = 1;
    }

    /**
     * Fetch and render sessions
     */
    async function fetchSessions() {
      try {
        const res = await fetch(`${MONITOR_URL}/api/v1/analytics/sessions`);
        const data = await res.json();

        if (data.ok) {
          const sessions = data.data.sessions || [];
          const html = sessions.slice(0, 10).map(s => {
            const status = Date.now() - s.endTime < 60000 ? 'active' : 'idle';
            return `
              <tr>
                <td><code>${s.sessionId.substring(0, 20)}...</code></td>
                <td>${s.userId}</td>
                <td>${s.eventCount}</td>
                <td>${formatDuration(s.duration)}</td>
                <td>${s.pages.length}</td>
                <td><span class="status-badge status-${status}">${status}</span></td>
              </tr>
            `;
          }).join('');
          document.getElementById('sessionsTable').innerHTML = html || '<tr><td colspan="6" class="loading">No sessions</td></tr>';
        }
      } catch (e) {
        console.error('Error fetching sessions:', e);
      }
    }

    /**
     * Refresh all data
     */
    async function refreshData() {
      document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
      await Promise.all([
        fetchPreloadStatus(),
        fetchEngagement(),
        fetchPerformance(),
        fetchFeatures(),
        fetchHeatmap(),
        fetchSessions()
      ]);
    }

    /**
     * Toggle auto refresh
     */
    function toggleAutoRefresh() {
      autoRefresh = !autoRefresh;
      document.getElementById('autoRefreshStatus').textContent = autoRefresh ? 'ON' : 'OFF';
    }

    /**
     * Export data
     */
    async function exportData() {
      try {
        const res = await fetch(`${MONITOR_URL}/api/v1/analytics/summary`);
        const data = await res.json();

        const json = JSON.stringify(data.data, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `analytics-${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);

        showMessage('‚úÖ Analytics exported successfully');
      } catch (e) {
        showMessage('‚ùå Export failed: ' + e.message, 'error');
      }
    }

    // Initial load
    refreshData();

    // Auto-refresh
    setInterval(() => {
      if (autoRefresh) {
        refreshData();
      }
    }, REFRESH_INTERVAL);
  </script>
</body>
</html>
